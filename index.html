<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BDR ì°¸ê°€ì‹ ì²­ì„œ v1.1</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --blue:#1769ff; --bg:#f8fbfd; --card:#fff; --shadow:0 8px 32px #1769ff1a; --radius:24px; --red:#ef4444; --muted:#6b7684 }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:'Pretendard','Apple SD Gothic Neo',sans-serif;color:#222}
  .wrap{max-width:980px;margin:28px auto;padding:16px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:24px;position:relative}
  h1{font-size:28px;margin:0 0 10px}
  .section-title{font-weight:800;margin:18px 0 8px}
  label{display:block;font-weight:700;margin:14px 0 6px}
  input,select,textarea{width:100%;padding:14px 12px;border:1px solid #e6ecf5;border-radius:14px;font-size:16px;outline:none;background:#fff}
  input:focus,select:focus,textarea:focus{border-color:var(--blue)}
  .row{display:grid;gap:12px}
  @media(min-width:720px){ .row-2{grid-template-columns:1fr 1fr} .row-3{grid-template-columns:1fr 1fr 1fr} }
  .muted{color:var(--muted);font-size:13px;margin-top:6px}
  .btn{margin-top:18px;width:100%;padding:14px;border:none;border-radius:14px;background:var(--blue);color:#fff;font-weight:700;font-size:17px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.done{background:#2ebf6f}
  .btn-sm{padding:8px 12px;border-radius:12px;border:1px solid #dfe6ee;background:#fff;cursor:pointer;margin-top:10px}
  .btn-danger{border-color:#ffd4d4;background:#fff;color:#b91c1c}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#222;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:.25s;z-index:30}
  .toast.show{opacity:1}
  .brand{position:absolute;right:30px;top:30px}
  .brand img{height:31px;opacity:.95}
  .conn{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:6px}
  .dot{font-size:14px;line-height:1}
  .dot.ok{color:#1769ff}
  .dot.bad{color:#ef4444}
  .dot.warn{color:#f59e0b}
  .step{display:none}.step.active{display:block}
  .nextbar{display:flex;gap:10px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap}
  .next{padding:10px 14px;border:1px solid #dfe6ee;background:#fff;border-radius:12px;cursor:pointer}
  .next.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
  .error{border-color:var(--red)!important;background:#fff7f7}
  .error-note{color:var(--red);font-size:12px;margin-top:6px}
  #tourInfo.cardish{border:1px solid #e6ecf5;border-radius:14px;padding:12px;background:#fbfdff}
  #tourInfo .kv{display:grid;grid-template-columns:92px 1fr;gap:6px 10px;font-size:14px;word-break:break-word;overflow-wrap:anywhere;white-space:normal}
  #tourInfo .kv b{color:#111}
  .poster-wrap{display:none;margin-top:8px;text-align:center}
  .poster-wrap img{max-width:100%;max-height:420px;border:1px solid #e6ecf5;border-radius:14px;background:#fff;object-fit:contain;box-shadow:var(--shadow)}
  .poster-wrap .caption{font-size:12px;color:var(--muted);margin-top:6px}
  .color-grid{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center}
  .color-btn{padding:10px 14px;border:1px solid #cdd6e1;border-radius:12px;background:#fff;cursor:pointer;font-weight:700}
  .color-confirm{padding:10px 14px;border:1px solid #cdd6e1;border-radius:12px;background:#fff;cursor:pointer;font-weight:700;display:none}
  .visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  .uniform-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
  .jersey-card{border:1px solid #e6ecf5;border-radius:14px;padding:12px;background:#f7fbff}
  .jersey-title{font-weight:700;margin-bottom:6px}
  .jersey{width:100%;height:180px}
  .edit-panel{margin-top:14px;border:1px dashed #dbe5f3;background:#f7fbff;border-radius:14px;padding:12px}

  /* ===== Modal (ì£¼ì˜ì‚¬í•­ í™•ì¸: ì·¨ì†Œ) ===== */
  .modal-backdrop{position:fixed;inset:0;background:rgba(17,24,39,.45);display:none;align-items:center;justify-content:center;z-index:50}
  .modal-backdrop.show{display:flex}
  .modal{width:min(560px,92vw);background:#fff;border-radius:18px;box-shadow:0 20px 80px rgba(0,0,0,.25);padding:18px}
  .modal header{display:flex;justify-content:space-between;align-items:center}
  .modal h3{margin:0;font-size:18px}
  .modal .body{margin-top:10px;color:#374151;line-height:1.5}
  .modal .foot{margin-top:16px;display:flex;gap:8px;justify-content:flex-end}
  .btn-outline{border:1px solid #d1d5db;background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
  .btn-danger-solid{background:#ef4444;color:#fff;border:none;border-radius:12px;padding:10px 14px;cursor:pointer}

  /* ===== ì œì¶œ ì™„ë£Œ í”Œë¡œíŒ… íŒ¨ë„ ===== */
  .floating-done{position:fixed;right:16px;bottom:16px;z-index:60;display:none}
  .floating-done.show{display:block;animation:pop .18s ease-out}
  @keyframes pop{from{transform:translateY(6px) scale(.98);opacity:.0}to{transform:translateY(0) scale(1);opacity:1}}
  .floating-card{background:#111;color:#fff;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.3);padding:14px 14px 12px;width:min(92vw,420px)}
  .floating-head{display:flex;align-items:center;gap:8px;font-weight:800}
  .floating-sub{font-size:12px;color:#cfd5dc;margin:6px 0 10px}
  .chiprow{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px dashed rgba(255,255,255,.35);background:transparent;color:#fff;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:700}
  .chip:disabled{opacity:.45;border-style:solid;cursor:not-allowed}
  .chip small{opacity:.8;font-weight:600}
  .paytext{background: rgba(255,255,255,.08);border-radius: 12px;padding: 10px 12px;white-space: pre-line;font-family: ui-monospace, Menlo, Consolas, "SFMono-Regular", monospace;font-size: 13px;line-height: 1.5;margin-bottom: 10px;}
  /* â˜… ëŒ€ê¸°íŒ€ ì¹© ë²„íŠ¼ */
  .chip-toggle{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 14px; border:1px solid #e6ecf5; background:#fbfdff;
    border-radius:999px; cursor:pointer; font-weight:700;
    user-select:none;
  }
  .chip-toggle.on{
    border-color:#1769ff40; background:#eef5ff; box-shadow: inset 0 0 0 2px #1769ff22;
  }
  .chip-toggle .vchk{
    width:16px; height:16px; accent-color: var(--blue);
    margin:0;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="brand">
      <img id="bdrLogo" alt="BDR" src="BDR(ë°°ê²½ì—†ìŒ).png">
      <div class="conn" title="Apps Script ì—°ê²° ìƒíƒœ">
        <span id="connDot" class="dot warn">â—</span>
        <button class="btn-sm" id="formSettingsBtn" type="button" title="Web App URL ì„¤ì •">âš™ï¸</button>
      </div>
    </div>
    <h1>BDR ì°¸ê°€ì‹ ì²­ì„œ v1.1</h1>
    <div class="muted">ì°¸ê°€ ëŒ€íšŒ ì„ íƒ âœ íŒ€ ëŒ€í‘œ ì •ë³´ âœ ì„ ìˆ˜ ëª…ë‹¨ âœ ì œì¶œ</div>

    <!-- 0) ëŒ€íšŒ ì„ íƒ -->
    <div class="step active" id="step0">
      <div class="section-title">0) ì°¸ê°€í¬ë§ ëŒ€íšŒ</div>
      <label>ëŒ€íšŒ ì„ íƒ</label>
      <select id="tourSelect"><option value="">ëŒ€íšŒë¥¼ ì„ íƒí•˜ì„¸ìš”</option></select>

      <!-- í¬ìŠ¤í„° -->
      <div id="posterWrap" class="poster-wrap" aria-live="polite">
        <img id="posterImg" alt="ëŒ€íšŒ í¬ìŠ¤í„°" referrerpolicy="no-referrer">
        <div class="caption">ëŒ€íšŒ í¬ìŠ¤í„°</div>
      </div>

      <div id="tourInfo" class="muted cardish" style="display:none;margin-top:8px"></div>
      <div class="muted">â€» ëŒ€íšŒë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ëŒ€íšŒì— ì„¤ì •ëœ <b>ì¢…ë³„/ë””ë¹„ì „</b>ë§Œ ì„ íƒí•  ìˆ˜ ìˆì–´ìš”.</div>

      <!-- ì‹ ì²­ì„œ ìˆ˜ì •/ë³µì œ/ì·¨ì†Œ(ë³¸ì¸ì¸ì¦) -->
      <div class="edit-panel">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:end">
          <div style="flex:1;min-width:220px">
            <label>ì‹ ì²­ì ì´ë¦„</label>
            <input id="ownerName" placeholder="ì˜ˆ: í™ê¸¸ë™">
          </div>
          <div style="flex:1;min-width:220px">
            <label>ì‹ ì²­ì ì—°ë½ì²˜</label>
            <input id="ownerPhone" placeholder="ìˆ«ìë§Œ ì…ë ¥" inputmode="numeric" maxlength="11">
          </div>
          <div>
            <button class="btn-sm" id="ownerFindBtn" type="button">ì‹ ì²­ì„œ ì°¾ê¸°</button>
          </div>
        </div>

        <div id="ownerResult" style="display:none;margin-top:8px">
          <label>ë‚´ ì‹ ì²­ì„œ ì„ íƒ</label>
          <select id="ownerTeamSel"></select>

          <div class="nextbar" style="justify-content:flex-start;gap:8px">
            <button class="btn-sm" id="ownerEditBtn" type="button">ìˆ˜ì •í•˜ê¸°</button>
            <button class="btn-sm" id="ownerCloneBtn" type="button">ë‹¤ë¥¸ ëŒ€íšŒ ì‹ ì²­í•˜ê¸°</button>
            <button class="btn-sm btn-danger" id="ownerCancelBtn" type="button" title="ì„ íƒí•œ ì‹ ì²­ì„œë¥¼ ì·¨ì†Œí•©ë‹ˆë‹¤">ì°¸ê°€ì·¨ì†Œ</button>
          </div>

          <div id="clonePanel" style="display:none;margin-top:10px">
            <label>ìƒˆ ëŒ€íšŒ ì„ íƒ</label>
            <select id="cloneTourSel"><option value="">ëŒ€íšŒë¥¼ ì„ íƒí•˜ì„¸ìš”</option></select>
            <div class="nextbar" style="justify-content:flex-start">
              <button class="btn-sm" id="ownerCloneSubmitBtn" type="button">ì¶”ê°€ ì‹ ì²­í•˜ê¸°</button>
            </div>
            <div class="muted">â€» ìƒˆ ëŒ€íšŒë¡œ ê¸°ë³¸ ì •ë³´/ëª…ë‹¨ì„ ë¶ˆëŸ¬ì˜¤ê³ , <b>â‘¡ ì¢…ë³„/ë””ë¹„ì „ì€ ì´ˆê¸°í™”</b>ë˜ì–´ ë‹¤ì‹œ ì„ íƒí•´ìš”.</div>
          </div>
        </div>

        <div class="muted">â€» ì´ë¦„+ì „í™”ë²ˆí˜¸ë¡œ ë³¸ì¸ ì¸ì¦ í›„ ê¸°ì¡´ ì‹ ì²­ì„œë¥¼ <b>ìˆ˜ì •/ì¶”ê°€ì‹ ì²­/ì°¸ê°€ì·¨ì†Œ</b>í•  ìˆ˜ ìˆì–´ìš”.</div>
      </div>

      <div class="nextbar" id="nextbar0" style="display:none">
        <button class="next primary" data-next="#step1" data-validate="1">ë‹¤ìŒ â†’</button>
      </div>
    </div>

    <!-- 1) íŒ€ ê¸°ë³¸ì •ë³´ -->
    <div class="step" id="step1">
      <div class="section-title">â‘  íŒ€ ê¸°ë³¸ì •ë³´</div>
      <div class="row row-2">
        <div>
          <label>ì‹œë„ ì„ íƒ</label>
          <select id="province"><option value="">ì„ íƒ</option>
            <option>ì„œìš¸íŠ¹ë³„ì‹œ</option><option>ë¶€ì‚°ê´‘ì—­ì‹œ</option><option>ëŒ€êµ¬ê´‘ì—­ì‹œ</option>
            <option>ì¸ì²œê´‘ì—­ì‹œ</option><option>ê´‘ì£¼ê´‘ì—­ì‹œ</option><option>ëŒ€ì „ê´‘ì—­ì‹œ</option>
            <option>ìš¸ì‚°ê´‘ì—­ì‹œ</option><option>ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ</option><option>ê²½ê¸°ë„</option>
            <option>ê°•ì›íŠ¹ë³„ìì¹˜ë„</option><option>ì¶©ì²­ë¶ë„</option><option>ì¶©ì²­ë‚¨ë„</option>
            <option>ì „ë¶íŠ¹ë³„ìì¹˜ë„</option><option>ì „ë¼ë‚¨ë„</option><option>ê²½ìƒë¶ë„</option>
            <option>ê²½ìƒë‚¨ë„</option><option>ì œì£¼íŠ¹ë³„ìì¹˜ë„</option>
          </select>
          <div class="error-note" id="errProvince" style="display:none">ì‹œë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>
        </div>
        <div>
          <label>ì‹œêµ°êµ¬ ì„ íƒ</label>
          <select id="city" disabled><option value="">ì‹œë„ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option></select>
          <div class="error-note" id="errCity" style="display:none">ì‹œêµ°êµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>
        </div>
      </div>

      <div class="row row-2">
        <div>
          <label>íŒ€ëª…(í•œê¸€)</label>
          <input id="teamNameKo" placeholder="ì˜ˆ: ìŠ¬ë¡œìš°" />
          <div class="error-note" id="errTeamNameKo" style="display:none">íŒ€ëª…(í•œê¸€)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
        </div>
        <div>
          <label>íŒ€ëª…(ì˜ë¬¸)</label>
          <input id="teamNameEn" placeholder="ì˜ˆ: SLOW" />
          <div class="error-note" id="errTeamNameEn" style="display:none">íŒ€ëª…(ì˜ë¬¸)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
        </div>
      </div>

      <div class="row row-2">
        <div>
          <label>ëŒ€í‘œì ì´ë¦„</label>
          <input id="managerName" placeholder="ì´ë¦„" />
          <div class="error-note" id="errManagerName" style="display:none">ëŒ€í‘œì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
        </div>
        <div>
          <label>ëŒ€í‘œì ì—°ë½ì²˜</label>
          <input id="managerPhone" placeholder="ìˆ«ìë§Œ ì…ë ¥(í•˜ì´í”ˆ ì—†ì´)" inputmode="numeric" pattern="[0-9]*" maxlength="11" autocomplete="tel" />
          <div class="error-note" id="errPhone" style="display:none">ìˆ«ìë§Œ ì…ë ¥(ì˜ˆ: 01012345678)</div>
        </div>
      </div>

      <div class="nextbar">
        <button class="next" data-next="#step0" data-dir="prev">â† ì´ì „</button>
        <button class="next primary" data-next="#step2" data-validate="1">ë‹¤ìŒ â†’</button>
      </div>
    </div>

    <!-- 2) ì¢…ë³„/ë””ë¹„ì „ -->
    <div class="step" id="step2">
      <div class="section-title">â‘¡ ì¢…ë³„/ë””ë¹„ì „</div>
      <div class="row row-2">
        <div>
          <label>ì¢…ë³„</label>
          <select id="category" disabled><option value="">ëŒ€íšŒë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option></select>
          <div class="error-note" id="errCategory" style="display:none">ì¢…ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
        </div>
        <div>
          <label>ë””ë¹„ì „</label>
          <select id="division" disabled><option value="">ì¢…ë³„ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option></select>
          <div class="error-note" id="errDivision" style="display:none">ë””ë¹„ì „ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
          <div class="muted" id="divCapHint" style="display:none"></div> <!-- â˜… ì¶”ê°€ -->
          <!-- â˜…â˜…â˜… ëŒ€ê¸°íŒ€ ì ‘ìˆ˜ UI (ì •ì› ë§ˆê° ì‹œ ë…¸ì¶œ) â˜…â˜…â˜… -->
          <div id="waitlistWrap" style="display:none; margin-top:8px">
            <button id="waitlistBtn" type="button" class="chip-toggle" aria-pressed="false" title="ëŒ€ê¸°íŒ€ìœ¼ë¡œ ì‹ ì²­">
              <input type="checkbox" id="waitlistChk" class="vchk" />
              <span>ëŒ€ê¸°íŒ€ìœ¼ë¡œ ì‹ ì²­</span>
            </button>
            <div class="muted" id="waitlistMsg" style="margin-top:6px"></div>
          </div>
        </div>
      </div>

      <div class="nextbar">
        <button class="next" data-next="#step1" data-dir="prev">â† ì´ì „</button>
        <button class="next primary" data-next="#step3" data-validate="1">ë‹¤ìŒ â†’</button>
      </div>
    </div>

    <!-- 3) ìœ ë‹ˆí¼ ìƒ‰ìƒ -->
    <div class="step" id="step3">
      <div class="section-title">â‘¢ ìœ ë‹ˆí¼ ìƒ‰ìƒ</div>

      <div>
        <label>í™ˆ ìƒ‰ìƒ</label>
        <div class="color-grid">
          <input class="hex" id="uniformHome" placeholder="#ff0000" value="#ff0000" />
          <label for="uniformHomePicker" class="color-btn">ìƒ‰ìƒì„ íƒ</label>
          <button class="color-confirm" id="uniformHomeConfirm" type="button">í™•ì¸</button>
        </div>
      </div>
      <div style="margin-top:8px">
        <label>ì–´ì›¨ì´ ìƒ‰ìƒ</label>
        <div class="color-grid">
          <input class="hex" id="uniformAway" placeholder="#ffffff" value="#ffffff" />
          <label for="uniformAwayPicker" class="color-btn">ìƒ‰ìƒì„ íƒ</label>
          <button class="color-confirm" id="uniformAwayConfirm" type="button">í™•ì¸</button>
        </div>
      </div>
      <div class="muted">â€» ì»¬ëŸ¬í”¼ì»¤ì—ì„œ ìƒ‰ìƒì„ ê³ ë¥¸ ë‹¤ìŒ <b>í™•ì¸</b>ì„ ëˆŒëŸ¬ ì ìš©í•˜ì„¸ìš”. (HEX ì§ì ‘ ì…ë ¥ì€ ì¦‰ì‹œ ì ìš©)</div>

      <input type="color" id="uniformHomePicker" class="visually-hidden" value="#ff0000" />
      <input type="color" id="uniformAwayPicker" class="visually-hidden" value="#ffffff" />

      <div class="uniform-row">
        <div class="jersey-card"><div class="jersey-title">í™ˆ</div><svg id="jerseyHome" class="jersey" viewBox="0 0 120 140"></svg></div>
        <div class="jersey-card"><div class="jersey-title">ì–´ì›¨ì´</div><svg id="jerseyAway" class="jersey" viewBox="0 0 120 140"></svg></div>
      </div>

      <div id="contrastWarn" class="muted" style="display:none;margin-top:8px">ìœ ë‹ˆí¼ ìƒ‰ìƒ ëŒ€ë¹„ê°€ ë‚®ì•„ ë²ˆí˜¸/ì´ë¦„ ê°€ë…ì„±ì´ ë–¨ì–´ì§ˆ ìˆ˜ ìˆì–´ìš”.</div>

      <div class="nextbar">
        <button class="next" data-next="#step2" data-dir="prev">â† ì´ì „</button>
        <button class="next primary" data-next="#step4" data-validate="1">ë‹¤ìŒ â†’</button>
      </div>
    </div>

    <!-- 4) ì„ ìˆ˜ ëª…ë‹¨ -->
    <div class="step" id="step4">
      <div class="section-title">â‘£ ì„ ìˆ˜ ëª…ë‹¨</div>

      <!-- ìƒë‹¨ íˆ´ë°”(ë¶™ì—¬ë„£ê¸°/ìƒ˜í”Œë§Œ ìœ ì§€) -->
      <div class="toolbar" style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn-sm" id="togglePasteBtn" type="button">ëª…ë‹¨ ë¶™ì—¬ë„£ê¸°</button>
        <button class="btn-sm" id="copySampleBtn" type="button">ìƒ˜í”Œë³µì‚¬</button>
      </div>

      <div id="pastePanel" style="display:none;margin-top:8px">
        <div class="muted">í˜•ì‹: <b>ì´ë¦„/ë°±ë„˜ë²„/í¬ì§€ì…˜/ìƒë…„ì›”ì¼(YYMMDD)/ì„ ì¶œ ë˜ëŠ” ë¹„ì„ ì¶œ</b></div>
        <textarea id="pasteText" style="height:120px;resize:vertical" placeholder="ì˜ˆ)
í™ê¸¸ë™/7/G/010302/ë¹„ì„ ì¶œ
ê¹€ì² ìˆ˜/11/F/000615/ì„ ì¶œ"></textarea>
        <div style="display:flex;gap:8px">
          <button class="btn-sm" id="pasteApplyBtn" type="button">ë¶™ì—¬ë„£ê¸° ì ìš©</button>
          <button class="btn-sm" id="pasteClearBtn" type="button">ì§€ìš°ê¸°</button>
        </div>
      </div>

      <!-- ì…ë ¥ í•„ë“œ -->
      <div id="players"></div>

      <!-- â–¼â–¼â–¼ ìš”ì²­ëŒ€ë¡œ 'ì„ ìˆ˜ ì¶”ê°€ +' ë²„íŠ¼ì„ ì…ë ¥ í•„ë“œ ì•„ë˜ë¡œ ì´ë™ â–¼â–¼â–¼ -->
      <div class="toolbar" style="display:flex;gap:8px;flex-wrap:wrap; margin-top:10px;">
        <button class="btn-sm" id="addPlayerBtn" type="button">ì„ ìˆ˜ ì¶”ê°€ +</button>
      </div>

      <div class="muted">â€» ìµœì†Œ 5ëª… í•„ìˆ˜. ëª¨ë“  ì¹¸ì„ ì±„ìš°ê³  íŒ€ ë‚´ ë“±ë²ˆí˜¸ ì¤‘ë³µì´ ì—†ë„ë¡ í™•ì¸í•´ ì£¼ì„¸ìš”.</div>

      <button class="btn" id="submitBtn">ì‹ ì²­ì„œ ì œì¶œ</button>
      <div class="nextbar"><button class="next" data-next="#step3" data-dir="prev">â† ì´ì „</button></div>

      <div id="editLinkWrap" style="display:none;margin-top:12px">
        <div class="muted" style="margin-bottom:6px;">ìˆ˜ì • ë§í¬</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="editLinkInput" type="text" readonly style="flex:1">
          <button class="btn-sm" id="copyEditLinkBtn" type="button">ë³µì‚¬</button>
        </div>
        <div id="qr" style="display:none;margin-top:8px;text-align:center">
          <img alt="ìˆ˜ì • ë§í¬ QR" style="width:140px;height:140px;border-radius:12px;border:1px solid #e6ecf5;background:#fff">
        </div>
      </div>
    </div>

    <div class="toast" id="toast">ì™„ë£Œ!</div>
  </div>
</div>

<!-- ===== ì°¸ê°€ì·¨ì†Œ ëª¨ë‹¬ ===== -->
<div class="modal-backdrop" id="cancelModal" role="dialog" aria-modal="true" aria-labelledby="cancelTitle" aria-describedby="cancelDesc">
  <div class="modal">
    <header>
      <h3 id="cancelTitle">ì°¸ê°€ì‹ ì²­ ì·¨ì†Œ</h3>
      <button class="btn-outline" id="cancelCloseBtn" type="button" aria-label="ë‹«ê¸°">âœ•</button>
    </header>
    <div class="body" id="cancelDesc">
      ì„ íƒí•œ ì‹ ì²­ì„œë¥¼ <b style="color:#b91c1c">ì •ë§ë¡œ ì·¨ì†Œ</b>í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br/>
      ì´ ì‘ì—…ì€ ì¦‰ì‹œ ë°˜ì˜ë˜ë©°, <b>ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</b><br/>
      (â€» ì¶”í›„ ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì·¨ì†Œ ì •ì±…ì´ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)
    </div>
    <div class="foot">
      <button class="btn-outline" id="cancelNoBtn" type="button">ì·¨ì†Œ</button>
      <button class="btn-danger-solid" id="cancelYesBtn" type="button">í™•ì¸(ì‚­ì œ)</button>
    </div>
  </div>
</div>

<!-- ===== ì œì¶œ ì™„ë£Œ í”Œë¡œíŒ… íŒ¨ë„ ===== -->
<div class="floating-done" id="floatingDone" aria-live="polite">
  <div class="floating-card">
    <div class="floating-head">âœ… ì œì¶œ ì™„ë£Œ</div>
    <div class="floating-sub" id="floatingSub">ì•„ë˜ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ë³µì‚¬í•˜ì„¸ìš”.</div>
    <div id="payText" class="paytext">ì°¸ê°€ë¹„ -ì›
  ì€í–‰ëª… ê³„ì¢Œë²ˆí˜¸ ì˜ˆê¸ˆì£¼</div>
    <div class="chiprow">
      <button class="chip" id="copyPayBtn" type="button">ğŸ“‹ ë‘ ì¤„ ëª¨ë‘ ë³µì‚¬</button>
    </div>
  </div>
</div>

<script>
  /* ===== ì—°ê²° ì„¤ì •/í—¬í¼ ===== */
  const DEFAULT_APP_URL = 'https://script.google.com/macros/s/AKfycbz1qk5MbQvVU3d8Qs3EcPO792iBNlVQR71WhCpNbkqzCcdn5gM17Hqx9AUAIGUwwSKCww/exec';
  const CONF_KEY = 'BDR_FORM_CONF_V1';

  const store = {
    load(){ try{ return JSON.parse(localStorage.getItem(CONF_KEY)||'{}'); }catch{return{};} },
    save(o){ localStorage.setItem(CONF_KEY, JSON.stringify(o||{})); }
  };
  const conf = store.load();
  function validWebAppUrl(u){ return /^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec(\?.*)?$/i.test((u||'').trim()); }
  if(!validWebAppUrl(conf.appUrl)) { conf.appUrl = DEFAULT_APP_URL; store.save(conf); }

  function appUrl(){ return (conf.appUrl||DEFAULT_APP_URL).trim(); }
  function apiUrl(path, params){
    const u = new URL(appUrl());
    if(path) u.searchParams.set('path', path);
    if(params) Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,String(v)));
    return u.toString();
  }

  async function getJSONFlex(u){
    try{
      const r = await fetch(u, { cache:'no-store', mode:'cors', credentials:'omit', redirect:'follow' });
      const t = await r.text();
      try { return JSON.parse(t); } catch(e) {
        return { ok:false, error:'JSON_PARSE_FAIL', raw: t.slice(0,300) };
      }
    }catch(e){
      return { ok:false, error: String(e && e.message || e) };
    }
  }

  async function apiGet(path, params){ return getJSONFlex(apiUrl(path, params)); }

  async function apiPost(paths, payload){
    const bodyText = JSON.stringify(payload||{});
    async function tryTextPlain(p){
      const r = await fetch(apiUrl(p), { method:'POST', headers:{'Content-Type':'text/plain'}, body:bodyText });
      const t = await r.text(); try{ return JSON.parse(t); }catch{ return {ok:false,error:t||'JSON íŒŒì‹± ì‹¤íŒ¨'}; }
    }
    async function tryForm(p){
      const r = await fetch(apiUrl(p), { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:'payload='+encodeURIComponent(bodyText) });
      const t = await r.text(); try{ return JSON.parse(t); }catch{ return {ok:false,error:t||'JSON íŒŒì‹± ì‹¤íŒ¨'}; }
    }
    let last = null;
    for(const p of paths){
      try{ const j = await tryTextPlain(p); last=j; if(j && (j.ok!==undefined || j.rows!==undefined)) return j; }catch(e){}
      try{ const j = await tryForm(p); last=j; if(j && (j.ok!==undefined || j.rows!==undefined)) return j; }catch(e){}
    }
    return last || { ok:false, error:'unknown' };
  }

  /* ===== URL íŒŒë¼ë¯¸í„° ===== */
  const qs=new URLSearchParams(location.search);
  const editTeamId=qs.get('edit');
  const editCode=qs.get('code');

  /* ===== ë„ìš°ë¯¸ ===== */
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const show=msg=>{ const t=$('.toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); };

  function setConn(state, tip){
    const dot = $('#connDot');
    dot.classList.remove('ok','bad','warn');
    if(state==='ok') dot.classList.add('ok'); else if(state==='bad') dot.classList.add('bad'); else dot.classList.add('warn');
    if(tip) dot.title = tip;
  }

  (function fixLogo(){
    const el=$('#bdrLogo');
    const fallback2='https://raw.githubusercontent.com/cobby8/assets/main/bdr-logo.png';
    const inline='data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="120" height="36"><rect width="120" height="36" fill="white"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-weight="700" font-family="sans-serif" fill="#111">BDR</text></svg>');
    el.onerror=()=>{ if(el.dataset.fallback==='1'){ el.src=inline; } else { el.dataset.fallback='1'; el.src=fallback2; } };
  })();

  // ì„¤ì • ë²„íŠ¼
  $('#formSettingsBtn').addEventListener('click', ()=>{
    const cur=(conf.appUrl||'').trim();
    const val=prompt('Apps Script Web App URLì„ ì…ë ¥í•˜ì„¸ìš” (â€¦/exec):', cur);
    if(val===null) return;
    if(!validWebAppUrl(val)) { alert('URL í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (â€¦/exec)'); return; }
    conf.appUrl = val.trim(); store.save(conf);
    show('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„ ì¤‘â€¦');
    boot(true);
  });

  $$('.next').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const target=btn.getAttribute('data-next'); if(!target) return;
      const needValidate=btn.hasAttribute('data-validate');
      if(needValidate){ const curr=btn.closest('.step'); if(!validateStep(curr.id)) return; }
      $$('.step').forEach(s=>s.classList.remove('active'));
      document.querySelector(target).classList.add('active');
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });

  /* ===== ëŒ€íšŒ ëª©ë¡ ===== */
  let TOUR_MAP={}, currentTour=null;
  /* â˜… ì¶”ê°€: ì„ íƒëœ ëŒ€íšŒì˜ ë””ë¹„ì „ë³„ í˜„ì¬ ì‹ ì²­íŒ€ìˆ˜ */
  let CUR_DIV_COUNT = {};  // ì˜ˆ: { "D4": 12, "i2 U12": 8 }

  // â˜…â˜…â˜… ì°¸ê°€íŒ€ìˆ˜(ë””ë¹„ì „ë³„) ë¡œë” - ëª¨ë“  ì‘ë‹µ í˜•íƒœ í˜¸í™˜ + ì·¨ì†ŒíŒ€ ì œì™¸
  async function loadAppliedCounts(tourId){
    CUR_DIV_COUNT = {};
    if(!tourId) return;
  
    try{
      const j = await apiGet('teams', { tourId });
  
      // 1) ì‘ë‹µ ë°°ì—´ êº¼ë‚´ê¸°(rows|items|list ë“±)
      const raw = (j && (
        (Array.isArray(j.rows) && j.rows) ||
        (Array.isArray(j.items) && j.items) ||
        (Array.isArray(j.list) && j.list) ||
        []
      )) || [];
  
      // 2) rows í˜•íƒœê°€ ê°ì²´ë°°ì—´ì¸ì§€, 2ì°¨ì› ë°°ì—´ì¸ì§€ íŒë³„
      //    - 2ì°¨ì› ë°°ì—´ì¼ ê²½ìš° í—¤ë” ì¸ë±ìŠ¤ë¥¼ ì°¾ì•„ì„œ division/status/ì‚­ì œì—¬ë¶€ ì»¬ëŸ¼ì„ ë§¤í•‘
      let header = null;
      if (raw.length && Array.isArray(raw[0])) {
        // 2ì°¨ì› ë°°ì—´
        header = raw[0].map(h => String(h||'').trim());
      }
  
      // 3) ê³µí†µ íŒŒì„œ: í–‰ì—ì„œ division / status / deleted ì¶”ì¶œ
      function pickFields(row){
        // ê°ì²´ ë ˆì½”ë“œ
        if (!Array.isArray(row) && row && typeof row === 'object'){
          // ë‹¤ì–‘í•œ í‚¤ ëŒ€ì‘ (division, Division, ë””ë¹„ì „, divison(ì˜¤íƒ€))
          const division = String(
            row.division ?? row.Division ?? row['ë””ë¹„ì „'] ?? row.divison ?? ''
          ).trim();
  
          const status = String(
            row.status ?? row.Status ?? row['ìƒíƒœ'] ?? ''
          ).trim();
  
          const deleted = Boolean(
            row.deleted ?? row.isDeleted ?? row['ì‚­ì œ'] ?? false
          );
  
          return { division, status, deleted };
        }
  
        // 2ì°¨ì› ë°°ì—´ ë ˆì½”ë“œ
        if (Array.isArray(row) && Array.isArray(header)){
          const idxOf = (names)=> {
            for(const n of names){
              const i = header.findIndex(h => h.toLowerCase() === String(n).toLowerCase());
              if (i>=0) return i;
            }
            return -1;
          };
  
          const iDiv = idxOf(['division','Division','ë””ë¹„ì „','divison']);
          const iStat= idxOf(['status','Status','ìƒíƒœ']);
          const iDel = idxOf(['deleted','isDeleted','ì‚­ì œ']);
  
          const division = iDiv>=0 ? String(row[iDiv]||'').trim() : '';
          const status   = iStat>=0 ? String(row[iStat]||'').trim() : '';
          const deleted  = iDel>=0 ? Boolean(row[iDel]) : false;
  
          return { division, status, deleted };
        }
  
        // ì˜ˆìƒì¹˜ ëª»í•œ í˜•íƒœ
        return { division:'', status:'', deleted:false };
      }
  
      // 4) í—¤ë”í–‰ ì œê±°(2ì°¨ì› ë°°ì—´ì¸ ê²½ìš°)
      const dataRows = (header ? raw.slice(1) : raw);
  
      // 5) ì¹´ìš´íŒ…(ì·¨ì†Œ/ì‚­ì œ ì œì™¸)
      for (const r of dataRows){
        const { division, status, deleted } = pickFields(r);
        if (!division) continue;
        if (deleted) continue;
        const isCancelled = /ì·¨ì†Œ|cancel/i.test(status);
        if (isCancelled) continue;
  
        CUR_DIV_COUNT[division] = (CUR_DIV_COUNT[division] || 0) + 1;
        // ì¹´í…Œê³ ë¦¬ë„ ìˆìœ¼ë©´ "cat division" í‚¤ë¡œë„ í•¨ê»˜ ì¹´ìš´íŠ¸
        const cat = String((r.category ?? r.Category ?? r['ì¢…ë³„'] ?? '')).trim();
        if (cat) {
            const k2 = `${cat} ${division}`.replace(/\s+/g,' ').trim();
            CUR_DIV_COUNT[k2] = (CUR_DIV_COUNT[k2] || 0) + 1;
        }
      }
  
    }catch(e){
      // ì‹¤íŒ¨ ì‹œ ì¹´ìš´íŠ¸ëŠ” ë¹„ì›Œë‘  (ë¬´ì‹œ)
    }
  }

  async function loadTournaments(){
    const json = await apiGet('tournaments');
    if(!(json && (json.ok || Array.isArray(json.rows)))){
      setConn('bad', (json && (json.error || (json.raw && 'ë¡œê·¸ì¸/ê¶Œí•œ í•„ìš”'))) || 'ì—°ê²° ì‹¤íŒ¨');
      return;
    }
    setConn('ok','ì—°ê²° ì •ìƒ');

    const sel=$('#tourSelect'); sel.innerHTML='<option value="">ëŒ€íšŒë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
    TOUR_MAP = {};
    (json.rows||[]).forEach(t=>{
      TOUR_MAP[t.TourID||t.tourId]=t;
      const opt=document.createElement('option');
      opt.value=t.TourID||t.tourId;
      const period=(t.start||t.end)?` Â· ${fmtDate(t.start)}~${fmtDate(t.end)}`:''; 
      opt.textContent=`${t.name}${t.status?' ('+t.status+')':''}${period}`;
      sel.appendChild(opt);
    });
  }
  const pad2=n=>String(n).padStart(2,'0');
  const fmtDate=v=>{ if(!v) return ''; const d=new Date(v); if(isNaN(d)) return v; return `${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}`; };
  const fmtDT=v=>{ if(!v) return ''; const d=new Date(v); if(isNaN(d)) return v; return `${d.getFullYear()}.${pad2(d.getMonth()+1)}.${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`; };

  async function fetchTourMeta(tourId){
    if(!tourId) return null;
    try { const m = await apiGet('tournament_meta', { tourId }); return (m && m.ok) ? m : null; }
    catch { return null; }
  }
  function isPast(nowIso, targetIso){
    if(!targetIso) return false;
    const now = new Date(nowIso || Date.now());
    const tgt = new Date(targetIso);
    if (isNaN(tgt)) return false;
    return now > tgt;
  }

  function summarizeDivs(divs){
    try{ const obj=(typeof divs==='string')?JSON.parse(divs||'{}'):(divs||{}); const parts=Object.keys(obj).map(cat=>{ const arr=Array.isArray(obj[cat])?obj[cat]:[]; return arr.length?`${cat}: ${arr.join('Â·')}`:`${cat}`; }); return parts.length?parts.join(' / '):'-'; }
    catch{ return '-'; }
  }
  function parsePlaces(p){
    try{ const arr=Array.isArray(p)?p:JSON.parse(p||'[]'); const names=(arr||[]).map(v=>typeof v==='string'?v:(v&&v.name)||'').filter(Boolean); return names.length?names.join(' Â· '):'-'; }
    catch{ return '-'; }
  }

  function extractDriveId(u){
    const s=String(u||'').trim();
    if(!s) return '';
    if(/^[A-Za-z0-9_-]{20,}$/.test(s) && !/^https?:\/\//i.test(s)) return s;
    let m = s.match(/\/d\/([A-Za-z0-9_-]{10,})/); if(m) return m[1];
    m = s.match(/[?&]id=([A-Za-z0-9_-]{10,})/);   if(m) return m[1];
    m = s.match(/\/uc(?:\?[^#]*?)?\bid=([A-Za-z0-9_-]{10,})/); if(m) return m[1];
    return '';
  }
  const buildView  = id => 'https://drive.google.com/uc?export=view&id='+encodeURIComponent(id);
  const buildDown  = id => 'https://drive.google.com/uc?export=download&id='+encodeURIComponent(id);
  const buildPlain = id => 'https://drive.google.com/uc?id='+encodeURIComponent(id);
  const buildThumb = id => 'https://drive.google.com/thumbnail?id='+encodeURIComponent(id)+'&sz=w2000';

  function computePosterVariants(posterUrl, posterId, posterLegacy){
    const variants=[];
    const candidates=[posterId, posterUrl, posterLegacy].filter(v=>typeof v==='string' && v.trim());
    const id=candidates.map(extractDriveId).find(Boolean);
    if(id){ [buildView(id), buildDown(id), buildPlain(id), buildThumb(id)].forEach(u=>{ if(!variants.includes(u)) variants.push(u); }); }
    candidates.forEach(u=>{
      const s=String(u).trim();
      if(/^data:image\//i.test(s)){ if(!variants.includes(s)) variants.push(s); return; }
      if(/\.(png|jpe?g|webp|gif|svg)(\?.*)?$/i.test(s) && !variants.includes(s)) variants.push(s);
      if(/^https?:\/\//i.test(s) && !variants.includes(s)) variants.push(s);
    });
    return variants;
  }

  async function renderPosterStrict(tourId){
    const wrap=$('#posterWrap'), img=$('#posterImg');
    wrap.style.display='none'; img.removeAttribute('src'); img.onerror=null; img.onload=null;
    if(!tourId) return;
    const t = TOUR_MAP[tourId]; if(!t) return;

    const urls = computePosterVariants(t.posterUrl, t.posterId, t.poster);
    if(!urls.length) return;

    let idx=0;
    const tryNext=()=>{ if(idx>=urls.length){ wrap.style.display='none'; img.removeAttribute('src'); return; } img.src = urls[idx++]; };
    img.onload = ()=>{ wrap.style.display='block'; };
    img.onerror= ()=>{ tryNext(); };
    tryNext();
  }

  function renderTourInfo(t){
    const box=$('#tourInfo'), nextbar=$('#nextbar0');
    if(!t){ box.style.display='none'; box.innerHTML=''; if(nextbar) nextbar.style.display='none'; return; }
    box.innerHTML = `<div class="kv">
      <b>ëŒ€íšŒëª…</b><div>${t.name||'-'}</div>
      <b>ì¢…ë³„</b><div>${summarizeDivs(t.divs)}</div>
      <b>ì¼ì‹œ</b><div>${(t.start||t.end)?`${fmtDate(t.start)} ~ ${fmtDate(t.end)}`:'ì¼ì •ë¯¸ì •'}</div>
      <b>ì¥ì†Œ</b><div>${parsePlaces(t.places)}</div>
      <b>ì ‘ìˆ˜ê¸°ê°„</b><div>${(t.regStart||t.regEnd)?`${fmtDT(t.regStart)} ~ ${fmtDT(t.regEnd)}`:'ë¯¸ì •'}</div>
      <b>ìˆ˜ì • ë§ˆê°</b><div id="editDeadlineCell">${t.editDeadlineAt ? fmtDT(t.editDeadlineAt) : 'â€” (ë¯¸ì„¤ì •)'}</div>
      ${(!t.url || /^data:image\//i.test(t.url)) ? '' : `<b>ì•ˆë‚´í˜ì´ì§€</b><div><a href="${t.url}" target="_blank" rel="noopener">${t.url}</a></div>`}
    </div>`;
    box.style.display='block';
    if(nextbar) nextbar.style.display='flex';
  }

$('#tourSelect').addEventListener('change', async (e) => {
  const id = e.target.value;                // ì„ íƒëœ tourId
  currentTour = id ? TOUR_MAP[id] : null;

  renderTourInfo(currentTour);
  await renderPosterStrict(id || '');

  // 1) ì‹ ì²­íŒ€ìˆ˜ ì§‘ê³„
  await loadAppliedCounts(id);

  // 2) ì¢…ë³„/ë””ë¹„ì „ UI êµ¬ì„± + íŒíŠ¸ ê°±ì‹ 
  fillCategoriesFromTour(currentTour);
  updateDivisionHint();  // ë””ë¹„ì „ ì„ íƒ ì „ì—ëŠ” íŒíŠ¸ ìˆ¨ê¹€ ì²˜ë¦¬

  // 3) ì„œë²„ ê¸°ì¤€ ìˆ˜ì •ë§ˆê° í‘œê¸° ë³´ì •
  if (id) {
    try {
      const meta = await apiGet('tournament_meta', { tourId: id });
      if (meta && meta.ok) {
        const cell = document.getElementById('editDeadlineCell');
        if (cell) cell.textContent = meta.editDeadlineAt ? fmtDT(meta.editDeadlineAt) : 'â€” (ë¯¸ì„¤ì •)';
      }
    } catch (_) {}
  }
});

  /* ===== ì¢…ë³„/ë””ë¹„ì „ ===== */
  const categorySelect=$('#category'), divisionSelect=$('#division');
    // â˜… division ë³€ê²½ ì‹œ í•œ ë²ˆë§Œ ì—°ê²°
    divisionSelect.addEventListener('change', updateDivisionHint);
    divisionSelect.addEventListener('change', updateWaitlistUI);

  /* â˜… í‚¤ ì •ê·œí™” + ì¹´í…Œê³ ë¦¬/ë¬´ì ‘ë‘ì‚¬ ì–‘ìª½ ë§¤ì¹­ */
  function normKey(s){ return String(s||'').replace(/\s+/g,' ').trim(); }
  
  function appliedFor(cat, dv){
    const k1 = normKey(dv);                // ex) "U12" ë˜ëŠ” "i2 U12"
    const k2 = normKey(`${cat} ${dv}`);    // ex) "i2 U12"
    return (CUR_DIV_COUNT[k1] ?? CUR_DIV_COUNT[k2] ?? 0);
  }
  
  function capFor(cat, dv){
    const caps = getDivCapsObj();
    const k1 = normKey(dv);
    const k2 = normKey(`${cat} ${dv}`);
    const raw = (caps && (caps[k1] ?? caps[k2]));
    const n = Number(raw);
    return Number.isFinite(n) ? n : null;
  }

    // â˜… í•´ë‹¹ ë””ë¹„ì „ì´ ì •ì› ë§ˆê°ì¸ì§€ íŒë‹¨
  function isDivisionFull(cat, dv){
    const cap = capFor(cat, dv);
    if (cap == null) return false;                 // ì •ì› ì„¤ì •ì´ ì—†ìœ¼ë©´ ë§ˆê° ì•„ë‹˜
    const applied = appliedFor(cat, dv);
    return applied >= cap;                         // í˜„ì¬ ì‹ ì²­íŒ€ìˆ˜ >= ì •ì› â†’ ë§ˆê°
  }

  /* â˜… ì¶”ê°€: divCaps ì½ê¸°(ë¬¸ì/ê°ì²´ í˜¸í™˜) */
  function getDivCapsObj(){
    if(!currentTour) return {};
    let caps = currentTour.divCaps;
    // í˜¹ì‹œ ë¬¸ìì—´ë¡œ ë‚´ë ¤ì˜¨ ê²½ìš° íŒŒì‹±
    if (typeof caps === 'string') {
      try { caps = JSON.parse(caps); } catch { caps = {}; }
    }
    return (caps && typeof caps === 'object') ? caps : {};
  }
  
  /* â˜… ì¶”ê°€: íŠ¹ì • ë””ë¹„ì „ ëª¨ì§‘ì •ì› ìˆ«ì ì¶”ì¶œ (ì—†ìœ¼ë©´ null) */
  function getCapForDivision(dv){
    const caps = getDivCapsObj();
    const raw = caps && (caps[dv]);
    const n = Number(raw);
    return Number.isFinite(n) ? n : null;
  }
  
  /* â˜… ì¹´í…Œê³ ë¦¬ ê³ ë ¤ ë¼ë²¨ */
  function formatDivisionLabel(cat, dv){
    const applied = appliedFor(cat, dv);
    const cap = capFor(cat, dv);
    return (cap!=null) ? `${dv} (${applied}/${cap})` : `${dv} (${applied}/-)`;
  }
  
  function updateDivisionHint(){
    const box = $('#divCapHint');
    if(!box) return;
  
    const cat = $('#category').value || '';
    const dv  = $('#division').value  || '';
  
    if(!dv){
      box.style.display='none';
      box.textContent='';
      box.style.color='';
      return;
    }
  
    const applied = appliedFor(cat, dv);
    const cap     = capFor(cat, dv);
  
    if(cap == null){
      box.textContent = `í˜„ì¬ ì‹ ì²­íŒ€ìˆ˜: ${applied}íŒ€ (ëª¨ì§‘ì •ì› ë¯¸ì„¤ì •)`;
      box.style.color = '';
    }else{
      const left  = Math.max(0, cap - applied);
      const isFull = applied >= cap;
      box.textContent = isFull
        ? `í˜„ì¬ ì‹ ì²­íŒ€ìˆ˜: ${applied}íŒ€ / ëª¨ì§‘ì •ì›: ${cap}íŒ€  â†’ ë§ˆê°ë¨`
        : `í˜„ì¬ ì‹ ì²­íŒ€ìˆ˜: ${applied}íŒ€ / ëª¨ì§‘ì •ì›: ${cap}íŒ€  (ì”ì—¬ ${left}íŒ€)`;
      box.style.color = isFull ? '#b91c1c' : '';
    }
  
    box.style.display='';
  }

  // â˜… ë””ë¹„ì „ ì„ íƒ ìƒíƒœì— ë”°ë¼ 'ëŒ€ê¸°íŒ€' UIë¥¼ ë…¸ì¶œ/ìˆ¨ê¹€
  function updateWaitlistUI(){
    const wrap = $('#waitlistWrap');
    const msg  = $('#waitlistMsg');
    const chk  = $('#waitlistChk');
    const btn  = $('#waitlistBtn');
    if (!wrap || !msg || !chk || !btn) return;
  
    const cat = $('#category').value || '';
    const dv  = $('#division').value  || '';
  
    // ê¸°ë³¸ ìˆ¨ê¹€
    if (!dv || !cat) {
      wrap.style.display = 'none';
      chk.checked = false;
      btn.classList.remove('on');
      btn.setAttribute('aria-pressed','false');
      msg.textContent = '';
      return;
    }
  
    const full = isDivisionFull(cat, dv);
    if (full){
      wrap.style.display = '';
      msg.textContent = 'í˜„ì¬ ë””ë¹„ì „ì€ ëª¨ì§‘ì •ì›ì— ë„ë‹¬í•˜ì—¬ "ëŒ€ê¸°íŒ€"ìœ¼ë¡œë§Œ ì ‘ìˆ˜í•  ìˆ˜ ìˆì–´ìš”. ì²´í¬ ì‹œ ëŒ€ê¸°ìˆœë²ˆì´ ë¶€ì—¬ë©ë‹ˆë‹¤.';
      // í˜„ì¬ ì²´í¬ ìƒíƒœ ë°˜ì˜
      btn.classList.toggle('on', chk.checked);
      btn.setAttribute('aria-pressed', chk.checked ? 'true' : 'false');
    } else {
      wrap.style.display = 'none';
      chk.checked = false;
      btn.classList.remove('on');
      btn.setAttribute('aria-pressed','false');
      msg.textContent = '';
    }
  }

  // â˜… ëŒ€ê¸°íŒ€ ì¹© ë²„íŠ¼ ë™ì‘(í´ë¦­/í‚¤ë³´ë“œ) + ìƒíƒœ ë™ê¸°í™”
  function setupWaitlistToggle(){
    const btn = $('#waitlistBtn');
    const chk = $('#waitlistChk');
    if(!btn || !chk) return;
  
    const sync = () => {
      btn.classList.toggle('on', chk.checked);
      btn.setAttribute('aria-pressed', chk.checked ? 'true' : 'false');
    };
  
    btn.addEventListener('click', () => { chk.checked = !chk.checked; sync(); });
    btn.addEventListener('keydown', (e) => {
      if(e.key === ' ' || e.key === 'Enter'){ e.preventDefault(); chk.checked = !chk.checked; sync(); }
    });
    chk.addEventListener('change', sync);
  })();

  function resetCategoryDivisionUI(){
    categorySelect.value = '';
    divisionSelect.innerHTML = '<option value="">ì¢…ë³„ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>';
    divisionSelect.disabled = true;
  }

  function fillCategoriesFromTour(t){
    categorySelect.innerHTML='';
    divisionSelect.innerHTML='<option value="">ì¢…ë³„ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>';
    divisionSelect.disabled=true;
    if(!t || !t.divs || !Object.keys(t.divs).length){
      categorySelect.disabled=true;
      categorySelect.innerHTML='<option value="">ëŒ€íšŒì— ì¢…ë³„/ë””ë¹„ì „ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤</option>';
      return;
    }
    categorySelect.disabled=false;
    categorySelect.appendChild(new Option('ì„ íƒ',''));
    Object.keys(t.divs).forEach(cat=> categorySelect.appendChild(new Option(cat,cat)));
  }

  categorySelect.addEventListener('change',e=>{
    const cat=e.target.value;
    divisionSelect.innerHTML='';
    if(!currentTour || !cat){
      divisionSelect.disabled=true;
      divisionSelect.innerHTML='<option value="">ì¢…ë³„ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>';
      return;
    }
    const arr=currentTour.divs[cat]||[];
    if(!arr.length){
      divisionSelect.disabled=true;
      divisionSelect.innerHTML='<option value="">í•´ë‹¹ ì¢…ë³„ì˜ ë””ë¹„ì „ ì—†ìŒ</option>';
      return;
    }
    divisionSelect.disabled=false;
    divisionSelect.appendChild(new Option('ì„ íƒ',''));
    arr.forEach(dv=>{
      const label   = formatDivisionLabel(cat, dv);
      const applied = appliedFor(cat, dv);
      const cap     = capFor(cat, dv);
      const full    = (cap!=null && applied >= cap);

      const opt = new Option(full ? (label + ' [ë§ˆê°]') : label, dv);
      // â˜… ë¹„í™œì„±í™”í•˜ì§€ ì•Šê³ , ìƒíƒœë§Œ data-fullë¡œ í‘œê¸°í•´ ë‘ 
      opt.dataset.full = full ? '1' : '0';
      divisionSelect.appendChild(opt);
    });
    updateDivisionHint();
    updateWaitlistUI();     // â˜… ëŒ€ê¸°íŒ€ UI ê°±ì‹ 
  });

  /* ===== ìœ ë‹ˆí¼ SVG/ìƒ‰ìƒ ===== */
  function renderJersey(svgEl, hex){
    svgEl.innerHTML = `
      <defs><filter id="shadow" x="-20%" y="-20%" width="140%"><feDropShadow dx="0" dy="2" stdDeviation="2"></feDropShadow></filter></defs>
      <g filter="url(#shadow)">
        <path d="M35 10 L50 10 L54 22 L66 22 L70 10 L85 10 L85 34 L95 42 L95 130 L25 130 L25 42 L35 34 Z" fill="${hex}" stroke="#111" stroke-width="1.5"/>
        <path d="M54 22 L60 28 L66 22" fill="none" stroke="#111" stroke-width="2"/>
        <rect x="38" y="60" width="44" height="8" rx="4" fill="rgba(255,255,255,0.25)"/>
        <path d="M35 34 L35 24" stroke="#111" stroke-width="1"/>
        <path d="M85 34 L85 24" stroke="#111" stroke-width="1"/>
      </g>`;
  }
  function hexToRgb(h){ const s=h.replace('#',''); return { r:parseInt(s.slice(0,2),16), g:parseInt(s.slice(2,4),16), b:parseInt(s.slice(4,6),16) }; }
  function relLum({r,g,b}){ const c=[r,g,b].map(v=>{v/=255; return v<=0.03928? v/12.92 : Math.pow((v+0.055)/1.055,2.4)}); return 0.2126*c[0]+0.7152*c[1]+0.0722*c[2]; }
  function contrastRatio(h1,h2){ try{const L1=relLum(hexToRgb(h1)); const L2=relLum(hexToRgb(h2)); const [a,b]=L1>L2?[L1,L2]:[L2,L1]; return (a+0.05)/(b+0.05);}catch{return 7}}
  function checkContrast(){
    const h=$('#uniformHome').value||'', a=$('#uniformAway').value||'';
    const warn=$('#contrastWarn'); const ok1=/^#[0-9A-Fa-f]{6}$/.test(h), ok2=/^#[0-9A-Fa-f]{6}$/.test(a);
    if(!ok1 && !ok2){ warn.style.display='none'; return; }
    const poor = (ok1 && Math.max(contrastRatio(h,'#000'), contrastRatio(h,'#fff')) < 4.5) ||
                 (ok2 && Math.max(contrastRatio(a,'#000'), contrastRatio(a,'#fff')) < 4.5);
    warn.style.display=poor?'block':'none';
  }
  function syncColor({hexId, pickerId, jerseyId, confirmId}){
    const hexEl=$(hexId), picker=$(pickerId), svg=$(jerseyId), confirmBtn=$(confirmId);
    const initVal = /^#[0-9A-Fa-f]{6}$/.test(hexEl.value) ? hexEl.value : (picker.value || '#000000');
    hexEl.value = initVal; picker.value = initVal; renderJersey(svg, initVal);
    const normalizeHex=v=>{ const val=(v||'').startsWith('#')?v:'#'+(v||''); return /^#[0-9A-Fa-f]{6}$/.test(val)?val:''; }
    picker.addEventListener('input', e=>{ const v=normalizeHex(e.target.value); if(!v) return; renderJersey(svg,v); confirmBtn.style.display='inline-block'; });
    confirmBtn.addEventListener('click', ()=>{ const v=normalizeHex(picker.value); if(!v) return; hexEl.value=v; renderJersey(svg,v); confirmBtn.style.display='none'; checkContrast(); });
    hexEl.addEventListener('input', e=>{ const raw=e.target.value.replace('#',''); if(/^[0-9A-Fa-f]{6}$/.test(raw)){ const v='#'+raw; picker.value=v; renderJersey(svg,v); confirmBtn.style.display='none'; checkContrast(); }});
  }
  syncColor({hexId:'#uniformHome', pickerId:'#uniformHomePicker', jerseyId:'#jerseyHome', confirmId:'#uniformHomeConfirm'});
  syncColor({hexId:'#uniformAway', pickerId:'#uniformAwayPicker', jerseyId:'#jerseyAway', confirmId:'#uniformAwayConfirm'});

  /* ===== ì—°ë½ì²˜/ì§€ì—­ ===== */
  $('#ownerPhone').addEventListener('input',e=> e.target.value=(e.target.value||'').replace(/\D+/g,'').slice(0,11));
  $('#managerPhone').addEventListener('input',e=> e.target.value=(e.target.value||'').replace(/\D+/g,'').slice(0,11));
  const regionMap={'ì„œìš¸íŠ¹ë³„ì‹œ':['ê°•ë‚¨êµ¬','ê°•ë™êµ¬','ê°•ë¶êµ¬','ê°•ì„œêµ¬','ê´€ì•…êµ¬','ê´‘ì§„êµ¬','êµ¬ë¡œêµ¬','ê¸ˆì²œêµ¬','ë…¸ì›êµ¬','ë„ë´‰êµ¬','ë™ëŒ€ë¬¸êµ¬','ë™ì‘êµ¬','ë§ˆí¬êµ¬','ì„œëŒ€ë¬¸êµ¬','ì„œì´ˆêµ¬','ì„±ë™êµ¬','ì„±ë¶êµ¬','ì†¡íŒŒêµ¬','ì–‘ì²œêµ¬','ì˜ë“±í¬êµ¬','ìš©ì‚°êµ¬','ì€í‰êµ¬','ì¢…ë¡œêµ¬','ì¤‘êµ¬','ì¤‘ë‘êµ¬'],
  'ë¶€ì‚°ê´‘ì—­ì‹œ':['ê°•ì„œêµ¬','ê¸ˆì •êµ¬','ë‚¨êµ¬','ë™êµ¬','ë™ë˜êµ¬','ë¶€ì‚°ì§„êµ¬','ë¶êµ¬','ì‚¬ìƒêµ¬','ì‚¬í•˜êµ¬','ì„œêµ¬','ìˆ˜ì˜êµ¬','ì—°ì œêµ¬','ì˜ë„êµ¬','ì¤‘êµ¬','í•´ìš´ëŒ€êµ¬','ê¸°ì¥êµ°'],
  'ëŒ€êµ¬ê´‘ì—­ì‹œ':['ë‚¨êµ¬','ë‹¬ì„œêµ¬','ë™êµ¬','ë¶êµ¬','ì„œêµ¬','ìˆ˜ì„±êµ¬','ì¤‘êµ¬','ë‹¬ì„±êµ°','êµ°ìœ„êµ°'],
  'ì¸ì²œê´‘ì—­ì‹œ':['ê°•í™”êµ°','ê³„ì–‘êµ¬','ë¯¸ì¶”í™€êµ¬','ë‚¨ë™êµ¬','ë™êµ¬','ë¶€í‰êµ¬','ì„œêµ¬','ì—°ìˆ˜êµ¬','ì¤‘êµ¬','ì˜¹ì§„êµ°'],
  'ê´‘ì£¼ê´‘ì—­ì‹œ':['ê´‘ì‚°êµ¬','ë‚¨êµ¬','ë™êµ¬','ë¶êµ¬','ì„œêµ¬'],
  'ëŒ€ì „ê´‘ì—­ì‹œ':['ëŒ€ë•êµ¬','ë™êµ¬','ì„œêµ¬','ìœ ì„±êµ¬','ì¤‘êµ¬'],
  'ìš¸ì‚°ê´‘ì—­ì‹œ':['ë‚¨êµ¬','ë™êµ¬','ë¶êµ¬','ì¤‘êµ¬','ìš¸ì£¼êµ°'],
  'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ':['ì„¸ì¢…ì‹œ'],
  'ê²½ê¸°ë„':['ê°€í‰êµ°','ê³ ì–‘ì‹œ','ê³¼ì²œì‹œ','ê´‘ëª…ì‹œ','ê´‘ì£¼ì‹œ','êµ¬ë¦¬ì‹œ','êµ°í¬ì‹œ','ê¹€í¬ì‹œ','ë‚¨ì–‘ì£¼ì‹œ','ë™ë‘ì²œì‹œ','ë¶€ì²œì‹œ','ì„±ë‚¨ì‹œ','ìˆ˜ì›ì‹œ','ì‹œí¥ì‹œ','ì•ˆì‚°ì‹œ','ì•ˆì„±ì‹œ','ì•ˆì–‘ì‹œ','ì–‘ì£¼ì‹œ','ì–‘í‰êµ°','ì—¬ì£¼ì‹œ','ì—°ì²œêµ°','ì˜¤ì‚°ì‹œ','ìš©ì¸ì‹œ','ì˜ì™•ì‹œ','ì˜ì •ë¶€ì‹œ','ì´ì²œì‹œ','íŒŒì£¼ì‹œ','í‰íƒì‹œ','í¬ì²œì‹œ','í•˜ë‚¨ì‹œ','í™”ì„±ì‹œ'],
  'ê°•ì›íŠ¹ë³„ìì¹˜ë„':['ê°•ë¦‰ì‹œ','ë™í•´ì‹œ','ì†ì´ˆì‹œ','ì‚¼ì²™ì‹œ','ì›ì£¼ì‹œ','ì¶˜ì²œì‹œ','íƒœë°±ì‹œ','ê³ ì„±êµ°','ì–‘êµ¬êµ°','ì–‘ì–‘êµ°','ì˜ì›”êµ°','ì¸ì œêµ°','ì •ì„ êµ°','ì² ì›êµ°','í‰ì°½êµ°','í™ì²œêµ°','í™”ì²œêµ°','íš¡ì„±êµ°'],
  'ì¶©ì²­ë¶ë„':['ì œì²œì‹œ','ì²­ì£¼ì‹œ','ì¶©ì£¼ì‹œ','ê´´ì‚°êµ°','ë‹¨ì–‘êµ°','ë³´ì€êµ°','ì˜ë™êµ°','ì˜¥ì²œêµ°','ìŒì„±êµ°','ì¦í‰êµ°'],
  'ì¶©ì²­ë‚¨ë„':['ê³„ë£¡ì‹œ','ê³µì£¼ì‹œ','ë…¼ì‚°ì‹œ','ë‹¹ì§„ì‹œ','ë³´ë ¹ì‹œ','ì„œì‚°ì‹œ','ì•„ì‚°ì‹œ','ì²œì•ˆì‹œ','ê¸ˆì‚°êµ°','ë¶€ì—¬êµ°','ì„œì²œêµ°','ì˜ˆì‚°êµ°','ì²­ì–‘êµ°','íƒœì•ˆêµ°','í™ì„±êµ°'],
  'ì „ë¶íŠ¹ë³„ìì¹˜ë„':['ì „ì£¼ì‹œ','êµ°ì‚°ì‹œ','ìµì‚°ì‹œ','ì •ìì‹œ','ë‚¨ì›ì‹œ','ê¹€ì œì‹œ','ì™„ì£¼êµ°','ê³ ì°½êµ°','ë¬´ì£¼êµ°','ë¶€ì•ˆêµ°','ìˆœì°½êµ°','ì„ì‹¤êµ°','ì¥ìˆ˜êµ°','ì§„ì•ˆêµ°'],
  'ì „ë¼ë‚¨ë„':['ê´‘ì–‘ì‹œ','ë‚˜ì£¼ì‹œ','ëª©í¬ì‹œ','ìˆœì²œì‹œ','ì—¬ìˆ˜ì‹œ','ê°•ì§„êµ°','ê³ í¥êµ°','ê³¡ì„±êµ°','êµ¬ë¡€êµ°','ë‹´ì–‘êµ°','ë¬´ì•ˆêµ°','ë³´ì„±êµ°','ì‹ ì•ˆêµ°','ì˜ê´‘êµ°','ì˜ì•”êµ°','ì™„ë„êµ°','ì¥ì„±êµ°','ì¥í¥êµ°','ì§„ë„êµ°','í•¨í‰êµ°','í•´ë‚¨êµ°','í™”ìˆœêµ°'],
  'ê²½ìƒë¶ë„':['ê²½ì‚°ì‹œ','ê²½ì£¼ì‹œ','êµ¬ë¯¸ì‹œ','ê¹€ì²œì‹œ','ë¬¸ê²½ì‹œ','ìƒì£¼ì‹œ','ì•ˆë™ì‹œ','ì˜ì£¼ì‹œ','ì˜ì²œì‹œ','í¬í•­ì‹œ','ê³ ë ¹êµ°','êµ°ìœ„êµ°','ë´‰í™”êµ°','ì„±ì£¼êµ°','ì˜ë•êµ°','ì˜ì–‘êµ°','ì˜ˆì²œêµ°','ìš¸ë¦‰êµ°','ìš¸ì§„êµ°','ì˜ì„±êµ°','ì²­ë„êµ°','ì²­ì†¡êµ°','ì¹ ê³¡êµ°'],
  'ê²½ìƒë‚¨ë„':['ê±°ì œì‹œ','ê¹€í•´ì‹œ','ë°€ì–‘ì‹œ','ì‚¬ì²œì‹œ','ì–‘ì‚°ì‹œ','ì§„ì£¼ì‹œ','ì°½ì›ì‹œ','í†µì˜ì‹œ','ê±°ì°½êµ°','ê³ ì„±êµ°','ë‚¨í•´êµ°','ì‚°ì²­êµ°','ì˜ë ¹êµ°','ì°½ë…•êµ°','í•˜ë™êµ°','í•¨ì•ˆêµ°','í•¨ì–‘êµ°','í•©ì²œêµ°'],
  'ì œì£¼íŠ¹ë³„ìì¹˜ë„':['ì œì£¼ì‹œ','ì„œê·€í¬ì‹œ']};
  $('#province').addEventListener('change',e=>{
    const prov=e.target.value; const citySel=$('#city'); citySel.innerHTML='';
    if(!prov){ citySel.disabled=true; citySel.innerHTML='<option value="">ì‹œë„ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>'; }
    else{ citySel.disabled=false; citySel.appendChild(new Option('ì„ íƒ','')); (regionMap[prov]||[]).forEach(c=>citySel.appendChild(new Option(c,c))); }
  });

  /* ===== ì„ ìˆ˜ ì¹´ë“œ & ë¶™ì—¬ë„£ê¸° ===== */
  function createPlayerCard(){
    const div=document.createElement('div');
    div.className='player-card';
    div.style.cssText='border:1px dashed #e6ecf5;border-radius:14px;padding:10px;margin-top:10px;background:#fafcff';
    div.innerHTML = `<div class="row row-3">
      <div><label>ì„ ìˆ˜ ì´ë¦„</label><input data-key="name" placeholder="ì´ë¦„"></div>
      <div><label>ë“±ë²ˆí˜¸</label><input data-key="number" inputmode="numeric" placeholder="ì˜ˆ: 7"></div>
      <div><label>í¬ì§€ì…˜</label><select data-key="position"><option value="">ì„ íƒ</option><option>G</option><option>F</option><option>C</option></select></div>
    </div>
    <div class="row row-2" style="margin-top:8px">
      <div><label>ìƒë…„ì›”ì¼</label><input data-key="birth" type="date"></div>
      <div><label>ì„ ì¶œì—¬ë¶€</label><select data-key="elite"><option value="">ì„ íƒ</option><option>ì„ ì¶œ</option><option>ë¹„ì„ ì¶œ</option></select></div>
    </div>
    <div style="text-align:right;margin-top:6px"><button class="btn-sm remove" type="button">ì‚­ì œ</button></div>`;
    div.querySelector('.remove').addEventListener('click',()=>div.remove());
    return div;
  }
  const playersDiv=$('#players');
  // â–¼ ì•„ë˜ ìœ„ì¹˜ì˜ ë²„íŠ¼ì„ í´ë¦­í•´ì„œ ì¹´ë“œ ì¶”ê°€
  $('#addPlayerBtn').addEventListener('click',()=>playersDiv.appendChild(createPlayerCard()));
  // ê¸°ë³¸ 5ëª… ìƒì„±
  for(let i=0;i<5;i++) $('#addPlayerBtn').click();

  $('#togglePasteBtn').addEventListener('click', ()=>{ const p=$('#pastePanel'); p.style.display=p.style.display==='none'?'block':'none'; });
  $('#pasteClearBtn')?.addEventListener('click', ()=> $('#pasteText').value='' );
  const SAMPLE=`í™ê¸¸ë™/7/G/010302/ë¹„ì„ ì¶œ
ê¹€ì² ìˆ˜/11/F/000615/ì„ ì¶œ`;
  $('#copySampleBtn').addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(SAMPLE); show('ìƒ˜í”Œì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. ë¶™ì—¬ë„£ê¸° í›„ ì ìš©ì„ ëˆ„ë¥´ì„¸ìš”.'); }
    catch(e){ const ta=document.createElement('textarea'); ta.value=SAMPLE; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); show('ìƒ˜í”Œì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
    $('#pastePanel').style.display='block'; $('#pasteText').focus();
  });
  function yyToYYYY(yy){ const n=parseInt(yy,10); if(isNaN(n)) return '2000'; return (n>=50?'19':'20') + (n<10?('0'+n):String(n)); }
  function normalizeBirth(s){
    const v=(s||'').replace(/\D/g,'');
    if (v.length===6)  return `${yyToYYYY(v.slice(0,2))}-${v.slice(2,4)}-${v.slice(4,6)}`;
    if (v.length===8)  return `${v.slice(0,4)}-${v.slice(4,6)}-${v.slice(6,8)}`;
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    return '';
  }
  $('#pasteApplyBtn').addEventListener('click', ()=>{
    const text=$('#pasteText').value||''; if(!text.trim()) return;
    const lines=text.replace(/\r\n/g,'\n').split('\n').map(s=>s.trim()).filter(Boolean);
    const allCards=$$('.player-card'); const allEmpty=allCards.length && allCards.every(c=>!c.querySelector('[data-key="name"]').value.trim());
    if(allEmpty) playersDiv.innerHTML='';
    lines.forEach(line=>{
      const cols=line.split(/[\/,\t]| {2,}/).map(s=>s.trim());
      const [name='', number='', position='', birthYY='', elite=''] = cols;
      const card=createPlayerCard();
      card.querySelector('[data-key="name"]').value=name;
      card.querySelector('[data-key="number"]').value=number;
      card.querySelector('[data-key="position"]').value=(position||'').toUpperCase();
      card.querySelector('[data-key="birth"]').value=normalizeBirth(birthYY);
      card.querySelector('[data-key="elite"]').value=elite||'';
      playersDiv.appendChild(card);
    });
    show('ë¶™ì—¬ë„£ê¸° ì ìš© ì™„ë£Œ');
  });

  /* ===== ê²€ì¦ ===== */
  function setErr(el,noteId,on){ if(!el) return; if(on){ el.classList.add('error'); if(noteId) $('#'+noteId).style.display='block'; } else { el.classList.remove('error'); if(noteId) $('#'+noteId).style.display='none'; } }

  function validateStep(stepId){
    let ok=true;
    if(stepId==='step0'){ const v=$('#tourSelect').value; if(!v){ show('ëŒ€íšŒë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”'); ok=false; } }
    if(stepId==='step1'){
      const prov=$('#province'), city=$('#city'), tKo=$('#teamNameKo'), tEn=$('#teamNameEn'), man=$('#managerName'), ph=$('#managerPhone');
      const phOk=/^\d{10,11}$/.test(ph.value);
      setErr(prov,'errProvince',!prov.value); setErr(city,'errCity',!city.value);
      setErr(tKo,'errTeamNameKo',!tKo.value.trim()); setErr(tEn,'errTeamNameEn',!tEn.value.trim());
      setErr(man,'errManagerName',!man.value.trim()); setErr(ph,'errPhone',!phOk);
      ok = prov.value && city.value && tKo.value.trim() && tEn.value.trim() && man.value.trim() && phOk;
      if(!ok) show('í•„ìˆ˜ í•­ëª©ì„ í™•ì¸í•´ ì£¼ì„¸ìš”');
    }
    if(stepId==='step2'){
      const catSel=$('#category'), divSel=$('#division');
      setErr(catSel,'errCategory',!catSel.value); 
      setErr(divSel,'errDivision',!divSel.value);

      ok = !!(catSel.value && divSel.value);
      if(!ok){
        show('ì¢…ë³„/ë””ë¹„ì „ì„ ì„ íƒí•´ ì£¼ì„¸ìš”');
        return ok;
      }

      // â˜… ì •ì› ë§ˆê° ë””ë¹„ì „ì´ë©´ ëŒ€ê¸°íŒ€ ì²´í¬ í•„ìˆ˜
      const cat = catSel.value;
      const dv  = divSel.value;
      if (isDivisionFull(cat, dv)){
        const wl = $('#waitlistChk');
        if (!wl || !wl.checked){
          show('í•´ë‹¹ ë””ë¹„ì „ì€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤. [ëŒ€ê¸°íŒ€ìœ¼ë¡œ ì‹ ì²­]ì„ ì²´í¬í•´ì•¼ ì§„í–‰í•  ìˆ˜ ìˆì–´ìš”.');
          // ì‹œê°ì  íŒíŠ¸
          $('#waitlistWrap')?.scrollIntoView({behavior:'smooth', block:'center'});
          return false;
        }
      }
    }
    return ok;
  }

  // â–¼ ì„ ìˆ˜ ëª…ë‹¨ ì—„ê²© ê²€ì¦ (ëª¨ë“  í•„ë“œ í•„ìˆ˜ + ë“±ë²ˆí˜¸ ì¤‘ë³µ ê¸ˆì§€)
  function validatePlayersStrict(){
    const cards=$$('.player-card');
    if(cards.length<5){ alert('ì„ ìˆ˜ëŠ” ìµœì†Œ 5ëª… ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return false; }

    // ì´ˆê¸°í™”
    cards.forEach(c=> c.querySelectorAll('input,select').forEach(el=>el.classList.remove('error')));

    const numbers=[];
    let firstBad=null;

    for(const card of cards){
      const nameEl=card.querySelector('[data-key="name"]');
      const numEl=card.querySelector('[data-key="number"]');
      const posEl=card.querySelector('[data-key="position"]');
      const birthEl=card.querySelector('[data-key="birth"]');
      const eliteEl=card.querySelector('[data-key="elite"]');

      const name=(nameEl.value||'').trim();
      const number=(numEl.value||'').trim();
      const position=(posEl.value||'').trim();
      const birth=(birthEl.value||'').trim();
      const elite=(eliteEl.value||'').trim();

      // ìˆ«ìë§Œ í—ˆìš©(0~99 ì œí•œì€ ê±¸ì§€ ì•Šê³  ìˆ«ì í•„ìˆ˜ë§Œ)
      const numOk=/^\d+$/.test(number);

      const requiredMap = [
        [nameEl, !!name],
        [numEl, numOk],
        [posEl, !!position],
        [birthEl, !!birth],
        [eliteEl, !!elite],
      ];
      requiredMap.forEach(([el,ok])=>{ if(!ok){ el.classList.add('error'); if(!firstBad) firstBad=el; } });

      numbers.push(number);
    }

    // ì¤‘ë³µ ì²´í¬(ë¹ˆì¹¸ì€ ìœ„ì—ì„œ ì´ë¯¸ ê±¸ëŸ¬ì§)
    const seen=new Set(), dups=new Set();
    numbers.forEach(n=>{ if(seen.has(n)) dups.add(n); else seen.add(n); });
    if(dups.size){
      cards.forEach(c=>{
        const el=c.querySelector('[data-key="number"]');
        if(dups.has((el.value||'').trim())) el.classList.add('error');
      });
      if(!firstBad){
        // ì²« ì˜¤ë¥˜ê°€ ì•„ì§ ì—†ìœ¼ë©´ ì¤‘ë³µ ë“±ë²ˆí˜¸ ìœ„ì¹˜ë¡œ
        const firstDupCard=[...cards].find(c=>dups.has((c.querySelector('[data-key="number"]').value||'').trim()));
        if(firstDupCard) firstBad=firstDupCard.querySelector('[data-key="number"]');
      }
      show('ë“±ë²ˆí˜¸ê°€ ì¤‘ë³µë˜ì—ˆìŠµë‹ˆë‹¤. ì¤‘ë³µì„ í•´ê²°í•´ ì£¼ì„¸ìš”.');
    }

    if(firstBad){
      firstBad.scrollIntoView({behavior:'smooth', block:'center'});
      return false;
    }
    return true;
  }

  /* ===== ë³¸ì¸ ì‹ ì²­ì„œ ì°¾ê¸°/ë¶ˆëŸ¬ì˜¤ê¸°/ë³µì œ/ì·¨ì†Œ ===== */
  let ownerEdit=null;   // {teamId,name,phone}
  let cloneSource=null; // {team, players}

  $('#ownerFindBtn').addEventListener('click', async ()=>{
    const name=$('#ownerName').value.trim(); const phone=($('#ownerPhone').value||'').replace(/\D/g,'');
    if(!name || phone.length<8){ show('ì´ë¦„ê³¼ ì—°ë½ì²˜(ìˆ«ìë§Œ)ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
    try{
      const json = await apiGet('findteam', { name, phone });
      if(!json.ok){ alert('ì˜¤ë¥˜: '+(json.error||'fail')); return; }
      const list=json.items||[]; if(list.length===0){ show('ì¼ì¹˜í•˜ëŠ” ì‹ ì²­ì„œê°€ ì—†ìŠµë‹ˆë‹¤.'); $('#ownerResult').style.display='none'; return; }
      const sel=$('#ownerTeamSel'); sel.innerHTML='';
      list.forEach(it=>{
        const txt=`${it.teamNameKo||'(íŒ€ëª…ì—†ìŒ)'} / ${it.tourName||'-'} ${it.category?(' / '+it.category):''}${it.division?(' '+it.division):''}`;
        sel.appendChild(new Option(txt, it.teamId));
      });
      $('#ownerResult').style.display='block';
      $('#clonePanel').style.display='none';
    }catch(e){ alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'); }
  });

  async function fillFormFromTeam_(t, pls){
    if (t.tourId && TOUR_MAP[t.tourId]) {
      $('#tourSelect').value = t.tourId;
      currentTour = TOUR_MAP[t.tourId];
    
      renderTourInfo(currentTour);
      await renderPosterStrict(t.tourId);
    
      // â˜… ì‹ ì²­íŒ€ìˆ˜ ì„ ê³„ì‚°(ìˆ˜ì •í™”ë©´ì—ì„œë„ ìˆ«ì í‘œì‹œë˜ë„ë¡)
      await loadAppliedCounts(t.tourId);
    
      // ì‹ ì²­íŒ€ìˆ˜ ë¡œë“œ í›„ ì¢…ë³„/ë””ë¹„ì „ ì˜µì…˜ êµ¬ì„±
      fillCategoriesFromTour(currentTour);
    }
    $('#province').value = t.province || ''; $('#province').dispatchEvent(new Event('change')); setTimeout(()=>{ $('#city').value = t.city || ''; }, 0);
    $('#teamNameKo').value = t.teamNameKo || ''; $('#teamNameEn').value = t.teamNameEn || '';
    $('#managerName').value = t.managerName || ''; $('#managerPhone').value = String(t.managerPhone||'').replace(/\D/g,'');

    if (t.category){
      $('#category').value = t.category;
      $('#category').dispatchEvent(new Event('change'));
      setTimeout(async ()=>{ 
        if(t.division){
          $('#division').value = t.division;
          $('#division').dispatchEvent(new Event('change'));
        }
        // â˜… ì´ë¯¸ loadAppliedCountsë¡œ ì§‘ê³„ë¨ â†’ íŒíŠ¸ë§Œ ê°±ì‹ 
        updateDivisionHint();
      }, 0);
    }

    $('#uniformHome').value = t.uniformHome || '#ff0000'; $('#uniformAway').value = t.uniformAway || '#ffffff';
    $('#uniformHomePicker').value = $('#uniformHome').value; $('#uniformAwayPicker').value = $('#uniformAway').value;
    renderJersey($('#jerseyHome'), $('#uniformHome').value); renderJersey($('#jerseyAway'), $('#uniformAway').value); checkContrast();

    playersDiv.innerHTML='';
    (pls||[]).forEach(pl=>{
      const c=createPlayerCard();
      c.querySelector('[data-key="name"]').value=pl.name||pl['ì„ ìˆ˜ì´ë¦„']||'';
      c.querySelector('[data-key="number"]').value=pl.number||pl['ë“±ë²ˆí˜¸']||'';
      c.querySelector('[data-key="position"]').value=(pl.position||pl['í¬ì§€ì…˜']||'').toUpperCase();
      c.querySelector('[data-key="birth"]').value=pl.birth||pl['ìƒë…„ì›”ì¼']||'';
      c.querySelector('[data-key="elite"]').value=pl.elite||'';
      playersDiv.appendChild(c);
    });
  }

  $('#ownerEditBtn').addEventListener('click', async ()=>{
    const teamId=$('#ownerTeamSel').value; const name=$('#ownerName').value.trim(); const phone=($('#ownerPhone').value||'').replace(/\D/g,'');
    if(!teamId){ show('ì‹ ì²­ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }
    try{
      const json = await apiGet('getTeamByOwner', { name, phone, teamId });
      if(!json.ok){ alert('ì˜¤ë¥˜: '+(json.error||'fail')); return; }
      ownerEdit={teamId,name,phone};
      await fillFormFromTeam_(json.team||{}, json.players||[]);
      if (currentTour && currentTour.tourId) {
        const meta = await fetchTourMeta(currentTour.tourId);
        if (meta && meta.editDeadlineAt) show('ìˆ˜ì • ë§ˆê°: ' + fmtDT(meta.editDeadlineAt));
      }
      show('ì‹ ì²­ì„œê°€ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤. ìˆ˜ì • í›„ ì œì¶œí•˜ì„¸ìš”.');
      $$('.step').forEach(s=>s.classList.remove('active')); $('#step1').classList.add('active'); window.scrollTo({top:0,behavior:'smooth'});
    }catch(e){ alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'); }
  });

  function fillCloneTourOptions(){
    const sel=$('#cloneTourSel');
    sel.innerHTML='<option value="">ëŒ€íšŒë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
    Object.keys(TOUR_MAP).forEach(id=>{
      const t=TOUR_MAP[id];
      sel.appendChild(new Option(`${t.name}${t.status?' ('+t.status+')':''}`, id));
    });
  }
  $('#ownerCloneBtn').addEventListener('click', async ()=>{
    const teamId=$('#ownerTeamSel').value; const name=$('#ownerName').value.trim(); const phone=($('#ownerPhone').value||'').replace(/\D/g,'');
    if(!teamId){ show('ì‹ ì²­ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }
    try{
      const json = await apiGet('getTeamByOwner', { name, phone, teamId });
      if(!json.ok){ alert('ì˜¤ë¥˜: '+(json.error||'fail')); return; }
      cloneSource={ team: json.team||{}, players: json.players||[] };
      fillCloneTourOptions();
      $('#clonePanel').style.display='block';
      show('ìƒˆ ëŒ€íšŒë¥¼ ì„ íƒí•œ ë’¤ [ì¶”ê°€ ì‹ ì²­í•˜ê¸°]ë¥¼ ëˆ„ë¥´ì„¸ìš”.');
    }catch(e){ alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'); }
  });

  $('#ownerCloneSubmitBtn').addEventListener('click', async ()=>{
    if(!cloneSource || !cloneSource.team){ show('ë¨¼ì € ì›ë³¸ ì‹ ì²­ì„œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }
    const newTourId=$('#cloneTourSel').value;
    if(!newTourId){ show('ìƒˆ ëŒ€íšŒë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”'); return; }
    const newTour=TOUR_MAP[newTourId];
    if(!newTour){ show('ëŒ€íšŒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤'); return; }

    const src=cloneSource.team, srcPlayers=cloneSource.players||[];
    await fillFormFromTeam_({...src, tourId:newTourId}, srcPlayers);
    currentTour=newTour; fillCategoriesFromTour(newTour);
    resetCategoryDivisionUI();
    ownerEdit=null;

    $$('.step').forEach(s=>s.classList.remove('active')); $('#step2').classList.add('active');
    window.scrollTo({top:0,behavior:'smooth'});
    show('ìƒˆ ëŒ€íšŒë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. â‘¡ ì¢…ë³„/ë””ë¹„ì „ì„ ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”.');
  });

  /* ===== ì°¸ê°€ì·¨ì†Œ: ëª¨ë‹¬ ===== */
  const cancelModal = $('#cancelModal');
  let lastFocused=null;

  function openCancelModal(){
    cancelModal.classList.add('show');
    lastFocused=document.activeElement;
    $('#cancelYesBtn').focus();
    function trap(e){
      if(e.key==='Tab'){
        const f = cancelModal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        const focusables = Array.from(f).filter(el=>!el.hasAttribute('disabled'));
        const first=focusables[0], last=focusables[focusables.length-1];
        if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
        else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
      } else if(e.key==='Escape'){ closeCancelModal(); }
    }
    cancelModal.addEventListener('keydown', trap);
    cancelModal._trap = trap;
  }
  function closeCancelModal(){
    cancelModal.classList.remove('show');
    if(cancelModal._trap){ cancelModal.removeEventListener('keydown', cancelModal._trap); cancelModal._trap=null; }
    if(lastFocused) lastFocused.focus();
  }
  $('#cancelCloseBtn').addEventListener('click', closeCancelModal);
  $('#cancelNoBtn').addEventListener('click', closeCancelModal);
  cancelModal.addEventListener('click', (e)=>{ if(e.target===cancelModal) closeCancelModal(); });

  $('#ownerCancelBtn').addEventListener('click', ()=>{
    const teamId=$('#ownerTeamSel').value;
    if(!teamId){ show('ì·¨ì†Œí•  ì‹ ì²­ì„œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”'); return; }
    openCancelModal();
  });

  $('#cancelYesBtn').addEventListener('click', async ()=>{
    const teamId=$('#ownerTeamSel').value; 
    const name=$('#ownerName').value.trim(); 
    const phone=($('#ownerPhone').value||'').replace(/\D/g,'');
    if(!teamId){ show('ì·¨ì†Œí•  ì‹ ì²­ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }
    if(!name || phone.length<8){ show('ì´ë¦„ê³¼ ì—°ë½ì²˜ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”'); return; }

    const candidates = ['cancelteambyowner','cancelTeamByOwner','deleteteambyowner','deleteTeamByOwner'];
    const payload = { name, phone, teamId };

    const yesBtn = $('#cancelYesBtn'); yesBtn.disabled = true; yesBtn.textContent = 'ì²˜ë¦¬ ì¤‘â€¦';
    try{
      const json = await apiPost(candidates, payload);
      if(json && json.ok){
        closeCancelModal();
        show('ì·¨ì†Œ ì™„ë£Œ: ì‹ ì²­ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        $('#ownerTeamSel').innerHTML='';
        $('#ownerResult').style.display='none';
        ownerEdit=null; cloneSource=null;
        resetAllFormUI();
      }else{
        alert('ì·¨ì†Œ ì‹¤íŒ¨: ' + (json && (json.error||json.raw) || 'unknown'));
      }
    }catch(e){
      alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }finally{
      yesBtn.disabled=false; yesBtn.textContent='í™•ì¸(ì‚­ì œ)';
    }
  });

  function resetAllFormUI(){
    $('#tourSelect').value='';
    renderTourInfo(null);
    $('#posterWrap').style.display='none';
    $('#province').value=''; $('#province').dispatchEvent(new Event('change'));
    $('#teamNameKo').value=''; $('#teamNameEn').value='';
    $('#managerName').value=''; $('#managerPhone').value='';
    categorySelect.innerHTML='<option value="">ëŒ€íšŒë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>'; categorySelect.disabled=true;
    divisionSelect.innerHTML='<option value="">ì¢…ë³„ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>'; divisionSelect.disabled=true;
    $('#uniformHome').value='#ff0000'; $('#uniformAway').value='#ffffff';
    $('#uniformHomePicker').value='#ff0000'; $('#uniformAwayPicker').value='#ffffff';
    renderJersey($('#jerseyHome'), '#ff0000'); renderJersey($('#jerseyAway'), '#ffffff'); checkContrast();
    playersDiv.innerHTML=''; for(let i=0;i<5;i++) $('#addPlayerBtn').click();
    $$('.step').forEach(s=>s.classList.remove('active')); $('#step0').classList.add('active');
    window.scrollTo({top:0,behavior:'smooth'});
  }

  /* ===== ì œì¶œ(ì‹ ê·œ/ìˆ˜ì • ê³µìš©) ===== */
  function safelyCopy(txt, label){
    if(!txt){ show(label+' ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ì ì„¤ì • ëŒ€ê¸°'); return; }
    navigator.clipboard.writeText(txt).then(()=>{
      show(label+' ë³µì‚¬ ì™„ë£Œ');
    }).catch(()=>{
      const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
      show(label+' ë³µì‚¬ ì™„ë£Œ');
    });
  }

  function extractPaymentInfo(t){
    const obj=t||{};
    const tryKeys=(o, keys)=>{ for(const k of keys){ if(k in o && String(o[k]??'').trim()) return String(o[k]); } return ''; };
    const fee = tryKeys(obj, ['fee','entryFee','entry_fee','ì°¸ê°€ë¹„','ì°¸ê°€ë¹„ìš©','ë“±ë¡ë¹„']);
    const acct = tryKeys(obj, ['account','bankAccount','bank_account','ì…ê¸ˆê³„ì¢Œ','ê³„ì¢Œ','ì…ê¸ˆì •ë³´']);
    return { fee, acct };
  }

function buildPayText(fee, acct){
  const feeLine  = `ì°¸ê°€ë¹„ ${String(fee||'').trim()||'-'}ì›`;
  let acctLine = String(acct||'').trim();
  if(!acctLine){
    acctLine = 'ì€í–‰ëª… ê³„ì¢Œë²ˆí˜¸ ì˜ˆê¸ˆì£¼';
  }else{
    acctLine = acctLine.replace(/[,\|/]+/g,' ')
                       .replace(/\s{2,}/g,' ')
                       .trim();
    acctLine = acctLine.replace(/(ì˜ˆê¸ˆì£¼)\s*[:ï¼š]\s*/g,'$1 ');
  }
  return `${feeLine}\n${acctLine}`;
}

function showFloatingPanelAfterSubmit(){
  const el = $('#floatingDone');
  const { fee, acct } = extractPaymentInfo(currentTour || {});
  const txt = buildPayText(fee, acct);
  $('#payText').textContent = txt;
  const ready = Boolean(String(fee||'').trim() && String(acct||'').trim());
  $('#floatingSub').innerHTML = ready
    ? 'ì•„ë˜ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ë³µì‚¬í•˜ì„¸ìš”.'
    : 'ê´€ë¦¬ì ì„¤ì • ëŒ€ê¸°: ì°¸ê°€ë¹„/ì…ê¸ˆê³„ì¢Œê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤. (ê´€ë¦¬ì ì„¤ì • í›„ ìë™ ë…¸ì¶œ)';
  const copyBtn = $('#copyPayBtn');
  copyBtn.disabled = !ready;
  copyBtn.onclick = () => safelyCopy(txt, 'ê²°ì œì •ë³´');
  el.classList.add('show');
  if(el._hideTimer) clearTimeout(el._hideTimer);
  el._hideTimer = setTimeout(()=>{ el.classList.remove('show'); }, 30000);
}

/* ===== ì œì¶œ(ì‹ ê·œ/ìˆ˜ì • ê³µìš©): ì¤‘ë³µë°©ì§€ ê°€ë“œ ì¶”ê°€ ===== */
let isSubmitting = false;  // â˜… ì¶”ê°€: ì¤‘ë³µ ì œì¶œ ê°€ë“œ í”Œë˜ê·¸

$('#submitBtn').addEventListener('click', async ()=>{
  // â˜… ê°€ë“œ: ì´ë¯¸ ì œì¶œ ì¤‘ì´ë©´ ë¬´ì‹œ
  if (isSubmitting) return;
  isSubmitting = true;

  const btn = $('#submitBtn');
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'ì œì¶œ ì¤‘...';  // â˜… ì¦‰ì‹œ "ì œì¶œ ì¤‘..." í‘œì‹œ

  try{
    // 1) ë‹¨ê³„ë³„ ê²€ì¦ (ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ë³µêµ¬ í›„ ì¢…ë£Œ)
    if (!validateStep('step0') || !validateStep('step1') || !validateStep('step2')) {
      btn.disabled = false;
      btn.textContent = originalText;
      isSubmitting = false;
      return;
    }
    if (!validatePlayersStrict()) {
      btn.disabled = false;
      btn.textContent = originalText;
      isSubmitting = false;
      return;
    }

    // 2) ìˆ˜ì •ë§ˆê° í™•ì¸
    {
      const tourId = ($('#tourSelect').value || '').trim();
      const meta = await fetchTourMeta(tourId);
      const isEditing = Boolean(ownerEdit && ownerEdit.teamId) || Boolean(editTeamId && editCode);

      const pad2=n=>String(n).padStart(2,'0');
      const fmtDT=v=>{ if(!v) return ''; const d=new Date(v); if(isNaN(d)) return v; return `${d.getFullYear()}.${pad2(d.getMonth()+1)}.${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`; };

      if (meta && meta.editDeadlineAt) {
        if (isPast(meta.now, meta.editDeadlineAt)) {
          alert('ìˆ˜ì • ë§ˆê°ì´ ì§€ë‚¬ìŠµë‹ˆë‹¤. ë” ì´ìƒ ì‹ ì²­ì„œ ë³€ê²½ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.');
          btn.disabled = false;
          btn.textContent = originalText;
          isSubmitting = false;
          return;
        } else {
          const msg = isEditing
            ? `ìˆ˜ì • ë§ˆê°: ${fmtDT(meta.editDeadlineAt)}\nì´í›„ì—ëŠ” ë³€ê²½ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.\nìˆ˜ì •ì„ ì§„í–‰í• ê¹Œìš”?`
            : `ìˆ˜ì • ë§ˆê°: ${fmtDT(meta.editDeadlineAt)}\nì œì¶œ í›„ ë§ˆê° ì‹œê° ì´í›„ì—ëŠ” ë³€ê²½ì´ ì œí•œë©ë‹ˆë‹¤.\nì œì¶œì„ ì§„í–‰í• ê¹Œìš”?`;
          if (!confirm(msg)) {
            btn.disabled = false;
            btn.textContent = originalText;
            isSubmitting = false;
            return;
          }
        }
      } else {
        const msg = (Boolean(ownerEdit && ownerEdit.teamId) || Boolean(editTeamId && editCode))
          ? 'í˜„ì¬ ìˆ˜ì • ë§ˆê°ì´ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\nìˆ˜ì •ì„ ì§„í–‰í• ê¹Œìš”?'
          : 'í˜„ì¬ ìˆ˜ì • ë§ˆê°ì´ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\nì œì¶œì„ ì§„í–‰í• ê¹Œìš”?';
        if (!confirm(msg)) {
          btn.disabled = false;
          btn.textContent = originalText;
          isSubmitting = false;
          return;
        }
      }
    }

    // 3) í˜ì´ë¡œë“œ êµ¬ì„±
    const province=$('#province').value.trim(), city=$('#city').value.trim();
    const team={
      tourId: $('#tourSelect').value.trim(),
      tourName: (currentTour&&currentTour.name)||'',
      region: province && city ? `${province} ${city}` : '',
      province, city,
      teamNameKo: $('#teamNameKo').value.trim(),
      teamNameEn: $('#teamNameEn').value.trim(),
      managerName: $('#managerName').value.trim(),
      managerPhone: ($('#managerPhone').value||'').replace(/\D+/g,''),
      category: $('#category').value,
      division: $('#division').value,
      uniformHome: $('#uniformHome').value.trim(),
      uniformAway: $('#uniformAway').value.trim()
      ,
      waitlist: !!$('#waitlistChk')?.checked            // â˜… ëŒ€ê¸°íŒ€ ì‹ ì²­ ì—¬ë¶€
      // statusWanted: $('#waitlistChk')?.checked ? 'ëŒ€ê¸°' : 'ì •ìƒ' // (ì›í•˜ë©´ í•¨ê»˜ ì „ì†¡)
    };
    const players=$$('.player-card').map(card=>{
      const get=k=> (card.querySelector(`[data-key="${k}"]`)?.value || '').trim();
      return { name:get('name'), number:get('number'), position:get('position'), birth:get('birth'), elite:get('elite') };
    });

    const payload={team, players, base: location.origin + location.pathname};
    let candidates = ['registerteam','registerTeam'];

    if (ownerEdit && ownerEdit.teamId){
      payload.teamId = ownerEdit.teamId; payload.name = ownerEdit.name; payload.phone = ownerEdit.phone;
      candidates = ['updateteambyowner','updateTeamByOwner'];
    } else if (editTeamId && editCode){
      payload.teamId = editTeamId; payload.editCode = editCode;
      candidates = ['updateteam','updateTeam'];
    }

    // 4) ì œì¶œ(ë„¤íŠ¸ì›Œí¬ ì¤‘ì—ë„ ê³„ì† ë¹„í™œì„±í™” ìœ ì§€)
    const json = await apiPost(candidates, payload);
    if(json && json.ok){
      // ì„±ê³µ ì‹œ ë²„íŠ¼ì„ ë‹¤ì‹œ í™œì„±í™”í•˜ì§€ ì•ŠìŒ(ì¤‘ë³µ ë°©ì§€)
      btn.textContent = (ownerEdit || (editTeamId&&editCode)) ? 'ìˆ˜ì • ì™„ë£Œ' : 'ì œì¶œ ì™„ë£Œ';
      btn.classList.add('done');
      show((ownerEdit || (editTeamId&&editCode)) ? 'ìˆ˜ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');

      if (!(ownerEdit || (editTeamId&&editCode))){
        const editUrl = json.editUrl || `${location.origin}${location.pathname}?edit=${encodeURIComponent(json.teamId)}&code=${encodeURIComponent(json.editCode)}`;
        $('#editLinkInput').value=editUrl; $('#editLinkWrap').style.display='block';
        const img=$('#qr img'); img.src='https://chart.googleapis.com/chart?chs=160x160&cht=qr&chl='+encodeURIComponent(editUrl); $('#qr').style.display='block';
      }
      showFloatingPanelAfterSubmit();
      // â˜… ì„±ê³µ í›„ì—ë„ isSubmittingì„ trueë¡œ ë‘¬ì„œ ì¶”ê°€ í´ë¦­ì„ ì™„ì „íˆ ì°¨ë‹¨
      return;
    } else {
      alert('ì˜¤ë¥˜: ' + (json && (json.error||json.raw) || 'unknown'));
      // ì‹¤íŒ¨ ì‹œì—ë§Œ ë³µêµ¬
      btn.disabled = false;
      btn.textContent = originalText;
      isSubmitting = false;
    }
  }catch(err){
    alert('ì œì¶œ ì‹¤íŒ¨: ' + (err && err.message || err));
    btn.disabled = false;
    btn.textContent = originalText;
    isSubmitting = false;
  }
});

  /* ===== ë¶€íŠ¸ìŠ¤íŠ¸ë© ===== */
  async function boot(forceReload){
    setConn('warn','ì—°ê²° í™•ì¸ ì¤‘â€¦');
    await loadTournaments();
    const initialId = $('#tourSelect').value || '';
    const initialTour = initialId ? TOUR_MAP[initialId] : null;
    renderTourInfo(initialTour);
    
    if (initialId){
      await renderPosterStrict(initialId);
      await loadAppliedCounts(initialId);   // ì‹ ì²­ìˆ˜ ì„ ê³„ì‚°
    }

    if (editTeamId && editCode){
      try{
        const j = await apiGet('getteam', { teamId: editTeamId, code: editCode });
        if(j && (j.team || j.ok)){
          await fillFormFromTeam_(j.team||{}, j.players||[]);
          show('ìˆ˜ì • ë§í¬ë¡œ ë¶ˆëŸ¬ì˜¨ ì‹ ì²­ì„œì…ë‹ˆë‹¤.');
        }else if(j && j.error){
          show('ìˆ˜ì • ë§í¬ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + j.error);
        }
      }catch(e){}
    }
  }

  // ì²« ë¡œë”© ì‹œì—ë„ íŒíŠ¸/ëŒ€ê¸° UI ìƒíƒœ 1íšŒ ë™ê¸°í™”
  updateDivisionHint();
  updateWaitlistUI();
  
  (async function init(){ await boot(); })();

</script>
</body>
</html>
