<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BDR 참가신청서 v1.1</title>

<!-- 네트워크 최적화 -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="dns-prefetch" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="dns-prefetch" href="https://drive.google.com">
<link rel="preconnect" href="https://drive.google.com" crossorigin>
<link rel="dns-prefetch" href="https://chart.googleapis.com">

<style>
  :root{ --blue:#1769ff; --bg:#f8fbfd; --card:#fff; --shadow:0 8px 32px #1769ff1a; --radius:24px; --red:#ef4444; --muted:#6b7684 }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:'Pretendard','Apple SD Gothic Neo',sans-serif;color:#222}
  .wrap{max-width:980px;margin:28px auto;padding:16px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:24px;position:relative}
  @media (max-width:520px){ .card{ box-shadow:0 4px 16px #1769ff14 } } /* 모바일 페인트 부담 ↓ */
  h1{font-size:28px;margin:0 0 10px}
  .section-title{font-weight:800;margin:18px 0 8px}
  label{display:block;font-weight:700;margin:14px 0 6px}
  input,select,textarea{width:100%;padding:14px 12px;border:1px solid #e6ecf5;border-radius:14px;font-size:16px;outline:none;background:#fff}
  input:focus,select:focus,textarea:focus{border-color:var(--blue)}
  .row{display:grid;gap:12px}
  @media(min-width:720px){ .row-2{grid-template-columns:1fr 1fr} .row-3{grid-template-columns:1fr 1fr 1fr} }
  .muted{color:var(--muted);font-size:13px;margin-top:6px}
  .btn{margin-top:18px;width:100%;padding:14px;border:none;border-radius:14px;background:var(--blue);color:#fff;font-weight:700;font-size:17px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.done{background:#2ebf6f}
  .btn-sm{padding:8px 12px;border-radius:12px;border:1px solid #dfe6ee;background:#fff;cursor:pointer;margin-top:10px}
  .btn-danger{border-color:#ffd4d4;background:#fff;color:#b91c1c}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#222;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:.25s;z-index:30}
  .toast.show{opacity:1}
  .brand{position:absolute;right:30px;top:30px}
  .brand img{height:31px;opacity:.95}
  .conn{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:6px}
  .dot{font-size:14px;line-height:1}
  .dot.ok{color:#1769ff}
  .dot.bad{color:#ef4444}
  .dot.warn{color:#f59e0b}
  .step{display:none}.step.active{display:block}
  .nextbar{display:flex;gap:10px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap}
  .next{padding:10px 14px;border:1px solid #dfe6ee;background:#fff;border-radius:12px;cursor:pointer}
  .next.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
  .error{border-color:var(--red)!important;background:#fff7f7}
  .error-note{color:var(--red);font-size:12px;margin-top:6px}
  #tourInfo.cardish{border:1px solid #e6ecf5;border-radius:14px;padding:12px;background:#fbfdff}
  #tourInfo .kv{display:grid;grid-template-columns:92px 1fr;gap:6px 10px;font-size:14px;word-break:break-word;overflow-wrap:anywhere;white-space:normal}
  #tourInfo .kv b{color:#111}
  .poster-wrap{display:none;margin-top:8px;text-align:center}
  .poster-wrap img{max-width:100%;max-height:420px;border:1px solid #e6ecf5;border-radius:14px;background:#fff;object-fit:contain;box-shadow:var(--shadow)}
  .poster-wrap .caption{font-size:12px;color:var(--muted);margin-top:6px}
  .color-grid{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center}
  .color-btn{padding:10px 14px;border:1px solid #cdd6e1;border-radius:12px;background:#fff;cursor:pointer;font-weight:700}
  .color-confirm{padding:10px 14px;border:1px solid #cdd6e1;border-radius:12px;background:#fff;cursor:pointer;font-weight:700;display:none}
  .visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  .uniform-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
  .jersey-card{border:1px solid #e6ecf5;border-radius:14px;padding:12px;background:#f7fbff}
  .jersey-title{font-weight:700;margin-bottom:6px}
  .jersey{width:100%;height:180px}
  .edit-panel{margin-top:14px;border:1px dashed #dbe5f3;background:#f7fbff;border-radius:14px;padding:12px}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(17,24,39,.45);display:none;align-items:center;justify-content:center;z-index:50}
  .modal-backdrop.show{display:flex}
  .modal{width:min(560px,92vw);background:#fff;border-radius:18px;box-shadow:0 20px 80px rgba(0,0,0,.25);padding:18px}
  .modal header{display:flex;justify-content:space-between;align-items:center}
  .modal h3{margin:0;font-size:18px}
  .modal .body{margin-top:10px;color:#374151;line-height:1.5}
  .modal .foot{margin-top:16px;display:flex;gap:8px;justify-content:flex-end}
  .btn-outline{border:1px solid #d1d5db;background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
  .btn-danger-solid{background:#ef4444;color:#fff;border:none;border-radius:12px;padding:10px 14px;cursor:pointer}

  /* 제출 완료 패널 */
  .floating-done{position:fixed;right:16px;bottom:16px;z-index:60;display:none}
  .floating-done.show{display:block;animation:pop .18s ease-out}
  @keyframes pop{from{transform:translateY(6px) scale(.98);opacity:.0}to{transform:translateY(0) scale(1);opacity:1}}
  .floating-card{background:#111;color:#fff;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.3);padding:14px 14px 12px;width:min(92vw,420px)}
  .floating-head{display:flex;align-items:center;gap:8px;font-weight:800}
  .floating-sub{font-size:12px;color:#cfd5dc;margin:6px 0 10px}
  .chiprow{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px dashed rgba(255,255,255,.35);background:transparent;color:#fff;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:700}
  .chip:disabled{opacity:.45;border-style:solid;cursor:not-allowed}
  .chip small{opacity:.8;font-weight:600}
  .paytext{background: rgba(255,255,255,.08);border-radius: 12px;padding: 10px 12px;white-space: pre-line;font-family: ui-monospace, Menlo, Consolas, "SFMono-Regular", monospace;font-size: 13px;line-height: 1.5;margin-bottom: 10px;}

  /* 성능 최적화 */
  .step{ content-visibility:auto; contain-intrinsic-size: 800px; }
  .poster-wrap{ content-visibility:auto; contain-intrinsic-size: 420px; }
  .floating-card{ contain: content; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="brand">
      <img id="bdrLogo" alt="BDR" src="BDR(배경없음).png"
           loading="lazy" decoding="async" fetchpriority="low" width="120" height="31">
      <div class="conn" title="Apps Script 연결 상태">
        <span id="connDot" class="dot warn">●</span>
        <button class="btn-sm" id="formSettingsBtn" type="button" title="Web App URL 설정">⚙️</button>
      </div>
    </div>
    <h1>BDR 참가신청서 v1.1</h1>
    <div class="muted">참가 대회 선택 ➜ 팀 대표 정보 ➜ 선수 명단 ➜ 제출</div>

    <!-- 0) 대회 선택 -->
    <div class="step active" id="step0">
      <div class="section-title">0) 참가희망 대회</div>
      <label>대회 선택</label>
      <select id="tourSelect"><option value="">대회를 선택하세요</option></select>

      <!-- 포스터 -->
      <div id="posterWrap" class="poster-wrap" aria-live="polite">
        <img id="posterImg" alt="대회 포스터" referrerpolicy="no-referrer"
             loading="lazy" decoding="async" fetchpriority="low" width="800" height="420">
        <div class="caption">대회 포스터</div>
      </div>

      <div id="tourInfo" class="muted cardish" style="display:none;margin-top:8px"></div>
      <div class="muted">※ 대회를 선택하면 해당 대회에 설정된 <b>종별/디비전</b>만 선택할 수 있어요.</div>

      <!-- 신청서 수정/복제/취소(본인인증) -->
      <div class="edit-panel">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:end">
          <div style="flex:1;min-width:220px">
            <label>신청자 이름</label>
            <input id="ownerName" placeholder="예: 홍길동">
          </div>
          <div style="flex:1;min-width:220px">
            <label>신청자 연락처</label>
            <input id="ownerPhone" placeholder="숫자만 입력" inputmode="numeric" maxlength="11">
          </div>
          <div>
            <button class="btn-sm" id="ownerFindBtn" type="button">신청서 찾기</button>
          </div>
        </div>

        <div id="ownerResult" style="display:none;margin-top:8px">
          <label>내 신청서 선택</label>
          <select id="ownerTeamSel"></select>

          <div class="nextbar" style="justify-content:flex-start;gap:8px">
            <button class="btn-sm" id="ownerEditBtn" type="button">수정하기</button>
            <button class="btn-sm" id="ownerCloneBtn" type="button">다른 대회 신청하기</button>
            <button class="btn-sm btn-danger" id="ownerCancelBtn" type="button" title="선택한 신청서를 취소합니다">참가취소</button>
          </div>

          <div id="clonePanel" style="display:none;margin-top:10px">
            <label>새 대회 선택</label>
            <select id="cloneTourSel"><option value="">대회를 선택하세요</option></select>
            <div class="nextbar" style="justify-content:flex-start">
              <button class="btn-sm" id="ownerCloneSubmitBtn" type="button">추가 신청하기</button>
            </div>
            <div class="muted">※ 새 대회로 기본 정보/명단을 불러오고, <b>② 종별/디비전은 초기화</b>되어 다시 선택해요.</div>
          </div>
        </div>

        <div class="muted">※ 이름+전화번호로 본인 인증 후 기존 신청서를 <b>수정/추가신청/참가취소</b>할 수 있어요.</div>
      </div>

      <div class="nextbar" id="nextbar0" style="display:none">
        <button class="next primary" data-next="#step1" data-validate="1">다음 →</button>
      </div>
    </div>

    <!-- 1) 팀 기본정보 -->
    <div class="step" id="step1">
      <div class="section-title">① 팀 기본정보</div>
      <div class="row row-2">
        <div>
          <label>시도 선택</label>
          <select id="province"><option value="">선택</option>
            <option>서울특별시</option><option>부산광역시</option><option>대구광역시</option>
            <option>인천광역시</option><option>광주광역시</option><option>대전광역시</option>
            <option>울산광역시</option><option>세종특별자치시</option><option>경기도</option>
            <option>강원특별자치도</option><option>충청북도</option><option>충청남도</option>
            <option>전북특별자치도</option><option>전라남도</option><option>경상북도</option>
            <option>경상남도</option><option>제주특별자치도</option>
          </select>
          <div class="error-note" id="errProvince" style="display:none">시도를 선택해주세요</div>
        </div>
        <div>
          <label>시군구 선택</label>
          <select id="city" disabled><option value="">시도를 먼저 선택하세요</option></select>
          <div class="error-note" id="errCity" style="display:none">시군구를 선택해주세요</div>
        </div>
      </div>

      <div class="row row-2">
        <div>
          <label>팀명(한글)</label>
          <input id="teamNameKo" placeholder="예: 슬로우" />
          <div class="error-note" id="errTeamNameKo" style="display:none">팀명(한글)을 입력해주세요</div>
        </div>
        <div>
          <label>팀명(영문)</label>
          <input id="teamNameEn" placeholder="예: SLOW" />
          <div class="error-note" id="errTeamNameEn" style="display:none">팀명(영문)을 입력해주세요</div>
        </div>
      </div>

      <div class="row row-2">
        <div>
          <label>대표자 이름</label>
          <input id="managerName" placeholder="이름" />
          <div class="error-note" id="errManagerName" style="display:none">대표자 이름을 입력해주세요</div>
        </div>
        <div>
          <label>대표자 연락처</label>
          <input id="managerPhone" placeholder="숫자만 입력(하이픈 없이)" inputmode="numeric" pattern="[0-9]*" maxlength="11" autocomplete="tel" />
          <div class="error-note" id="errPhone" style="display:none">숫자만 입력(예: 01012345678)</div>
        </div>
      </div>

      <div class="nextbar">
        <button class="next" data-next="#step0" data-dir="prev">← 이전</button>
        <button class="next primary" data-next="#step2" data-validate="1">다음 →</button>
      </div>
    </div>

    <!-- 2) 종별/디비전 -->
    <div class="step" id="step2">
      <div class="section-title">② 종별/디비전</div>
      <div class="row row-2">
        <div>
          <label>종별</label>
          <select id="category" disabled><option value="">대회를 먼저 선택하세요</option></select>
          <div class="error-note" id="errCategory" style="display:none">종별을 선택해주세요</div>
        </div>
        <div>
          <label>디비전</label>
          <select id="division" disabled><option value="">종별을 먼저 선택하세요</option></select>
          <div class="error-note" id="errDivision" style="display:none">디비전을 선택해주세요</div>
          <div class="muted" id="divCapHint" style="display:none"></div>
        </div>
      </div>

      <div class="nextbar">
        <button class="next" data-next="#step1" data-dir="prev">← 이전</button>
        <button class="next primary" data-next="#step3" data-validate="1">다음 →</button>
      </div>
    </div>

    <!-- 3) 유니폼 색상 -->
    <div class="step" id="step3">
      <div class="section-title">③ 유니폼 색상</div>

      <div>
        <label>홈 색상</label>
        <div class="color-grid">
          <input class="hex" id="uniformHome" placeholder="#ff0000" value="#ff0000" />
          <label for="uniformHomePicker" class="color-btn">색상선택</label>
          <button class="color-confirm" id="uniformHomeConfirm" type="button">확인</button>
        </div>
      </div>
      <div style="margin-top:8px">
        <label>어웨이 색상</label>
        <div class="color-grid">
          <input class="hex" id="uniformAway" placeholder="#ffffff" value="#ffffff" />
          <label for="uniformAwayPicker" class="color-btn">색상선택</label>
          <button class="color-confirm" id="uniformAwayConfirm" type="button">확인</button>
        </div>
      </div>
      <div class="muted">※ 컬러피커에서 색상을 고른 다음 <b>확인</b>을 눌러 적용하세요. (HEX 직접 입력은 즉시 적용)</div>

      <input type="color" id="uniformHomePicker" class="visually-hidden" value="#ff0000" />
      <input type="color" id="uniformAwayPicker" class="visually-hidden" value="#ffffff" />

      <div class="uniform-row">
        <div class="jersey-card"><div class="jersey-title">홈</div><svg id="jerseyHome" class="jersey" viewBox="0 0 120 140"></svg></div>
        <div class="jersey-card"><div class="jersey-title">어웨이</div><svg id="jerseyAway" class="jersey" viewBox="0 0 120 140"></svg></div>
      </div>

      <div id="contrastWarn" class="muted" style="display:none;margin-top:8px">유니폼 색상 대비가 낮아 번호/이름 가독성이 떨어질 수 있어요.</div>

      <div class="nextbar">
        <button class="next" data-next="#step2" data-dir="prev">← 이전</button>
        <button class="next primary" data-next="#step4" data-validate="1">다음 →</button>
      </div>
    </div>

    <!-- 4) 선수 명단 -->
    <div class="step" id="step4">
      <div class="section-title">④ 선수 명단</div>

      <div class="toolbar" style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn-sm" id="togglePasteBtn" type="button">명단 붙여넣기</button>
        <button class="btn-sm" id="copySampleBtn" type="button">샘플복사</button>
      </div>

      <div id="pastePanel" style="display:none;margin-top:8px">
        <div class="muted">형식: <b>이름/백넘버/포지션/생년월일(YYMMDD)/선출 또는 비선출</b></div>
        <textarea id="pasteText" style="height:120px;resize:vertical" placeholder="예)
홍길동/7/G/010302/비선출
김철수/11/F/000615/선출"></textarea>
        <div style="display:flex;gap:8px">
          <button class="btn-sm" id="pasteApplyBtn" type="button">붙여넣기 적용</button>
          <button class="btn-sm" id="pasteClearBtn" type="button">지우기</button>
        </div>
      </div>

      <div id="players"></div>

      <div class="toolbar" style="display:flex;gap:8px;flex-wrap:wrap; margin-top:10px;">
        <button class="btn-sm" id="addPlayerBtn" type="button">선수 추가 +</button>
      </div>

      <div class="muted">※ 최소 5명 필수. 모든 칸을 채우고 팀 내 등번호 중복이 없도록 확인해 주세요.</div>

      <button class="btn" id="submitBtn">신청서 제출</button>
      <div class="nextbar"><button class="next" data-next="#step3" data-dir="prev">← 이전</button></div>

      <div id="editLinkWrap" style="display:none;margin-top:12px">
        <div class="muted" style="margin-bottom:6px;">수정 링크</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="editLinkInput" type="text" readonly style="flex:1">
          <button class="btn-sm" id="copyEditLinkBtn" type="button">복사</button>
        </div>
        <div id="qr" style="display:none;margin-top:8px;text-align:center">
          <img alt="수정 링크 QR" style="width:140px;height:140px;border-radius:12px;border:1px solid #e6ecf5;background:#fff"
               loading="lazy" decoding="async">
        </div>
      </div>
    </div>

    <div class="toast" id="toast">완료!</div>
  </div>
</div>

<!-- ===== 참가취소 모달 ===== -->
<div class="modal-backdrop" id="cancelModal" role="dialog" aria-modal="true" aria-labelledby="cancelTitle" aria-describedby="cancelDesc">
  <div class="modal">
    <header>
      <h3 id="cancelTitle">참가신청 취소</h3>
      <button class="btn-outline" id="cancelCloseBtn" type="button" aria-label="닫기">✕</button>
    </header>
    <div class="body" id="cancelDesc">
      선택한 신청서를 <b style="color:#b91c1c">정말로 취소</b>하시겠습니까?<br/>
      이 작업은 즉시 반영되며, <b>삭제된 데이터는 복구할 수 없습니다.</b><br/>
      (※ 추후 관리자 페이지에서 취소 정책이 변경될 수 있습니다)
    </div>
    <div class="foot">
      <button class="btn-outline" id="cancelNoBtn" type="button">취소</button>
      <button class="btn-danger-solid" id="cancelYesBtn" type="button">확인(삭제)</button>
    </div>
  </div>
</div>

<!-- ===== 제출 완료 플로팅 패널 ===== -->
<div class="floating-done" id="floatingDone" aria-live="polite">
  <div class="floating-card">
    <div class="floating-head">✅ 제출 완료</div>
    <div class="floating-sub" id="floatingSub">아래 정보를 확인하고 복사하세요.</div>
    <div id="payText" class="paytext">참가비 -원
  은행명 계좌번호 예금주</div>
    <div class="chiprow">
      <button class="chip" id="copyPayBtn" type="button">📋 두 줄 모두 복사</button>
    </div>
  </div>

<script>
  /* ===== 연결 설정/헬퍼 ===== */
  const DEFAULT_APP_URL = 'https://script.google.com/macros/s/AKfycbz1qk5MbQvVU3d8Qs3EcPO792iBNlVQR71WhCpNbkqzCcdn5gM17Hqx9AUAIGUwwSKCww/exec';
  const CONF_KEY = 'BDR_FORM_CONF_V1';

  const store = {
    load(){ try{ return JSON.parse(localStorage.getItem(CONF_KEY)||'{}'); }catch{return{};} },
    save(o){ localStorage.setItem(CONF_KEY, JSON.stringify(o||{})); }
  };
  const conf = store.load();
  function validWebAppUrl(u){ return /^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec(\?.*)?$/i.test((u||'').trim()); }
  if(!validWebAppUrl(conf.appUrl)) { conf.appUrl = DEFAULT_APP_URL; store.save(conf); }

  function appUrl(){ return (conf.appUrl||DEFAULT_APP_URL).trim(); }
  function apiUrl(path, params){
    const u = new URL(appUrl());
    if(path) u.searchParams.set('path', path);
    if(params) Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,String(v)));
    return u.toString();
  }

  /* ===== 캐시/상태 ===== */
  const TOURN_CACHE_KEY = 'BDR_TOURN_CACHE_V1';
  const TOURN_CACHE_TTL = 15 * 60 * 1000; // 15분
  const DIVCOUNT_TTL = 5 * 60 * 1000; // 5분
  const divCountCache = new Map(); // key: tourId, val: {ts, data:{dv:count}}
  let appliedCountsAbort; // AbortController for counts
  let posterAbort;       // AbortController for poster
  let lastTourChangeToken = 0; // race 방지 토큰

  function getCache(k){
    try{
      const raw = localStorage.getItem(k);
      if(!raw) return null;
      const {ts, data} = JSON.parse(raw);
      if(!ts || Date.now() - ts > TOURN_CACHE_TTL) return null;
      return data;
    }catch{ return null; }
  }
  function setCache(k, data){
    try{ localStorage.setItem(k, JSON.stringify({ts:Date.now(), data})); }catch{}
  }

  async function getJSONFlex(u, opt={}){
    try{
      const r = await fetch(u, { cache:'no-store', mode:'cors', credentials:'omit', redirect:'follow', signal: opt.signal });
      const t = await r.text();
      try { return JSON.parse(t); } catch(e) {
        return { ok:false, error:'JSON_PARSE_FAIL', raw: t.slice(0,300) };
      }
    }catch(e){
      if(e.name==='AbortError') return { ok:false, error:'ABORTED' };
      return { ok:false, error: String(e && e.message || e) };
    }
  }
  async function apiGet(path, params, opt){ return getJSONFlex(apiUrl(path, params), opt); }

  async function apiPost(paths, payload){
    const bodyText = JSON.stringify(payload||{});
    async function tryTextPlain(p){
      const r = await fetch(apiUrl(p), { method:'POST', headers:{'Content-Type':'text/plain'}, body:bodyText });
      const t = await r.text(); try{ return JSON.parse(t); }catch{ return {ok:false,error:t||'JSON 파싱 실패'}; }
    }
    async function tryForm(p){
      const r = await fetch(apiUrl(p), { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:'payload='+encodeURIComponent(bodyText) });
      const t = await r.text(); try{ return JSON.parse(t); }catch{ return {ok:false,error:t||'JSON 파싱 실패'}; }
    }
    let last = null;
    for(const p of paths){
      try{ const j = await tryTextPlain(p); last=j; if(j && (j.ok!==undefined || j.rows!==undefined)) return j; }catch(e){}
      try{ const j = await tryForm(p); last=j; if(j && (j.ok!==undefined || j.rows!==undefined)) return j; }catch(e){}
    }
    return last || { ok:false, error:'unknown' };
  }

  /* ===== URL 파라미터 ===== */
  const qs=new URLSearchParams(location.search);
  const editTeamId=qs.get('edit');
  const editCode=qs.get('code');

  /* ===== 도우미 ===== */
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const show=msg=>{ const t=$('.toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); };

  function setConn(state, tip){
    const dot = $('#connDot');
    dot.classList.remove('ok','bad','warn');
    if(state==='ok') dot.classList.add('ok'); else if(state==='bad') dot.classList.add('bad'); else dot.classList.add('warn');
    if(tip) dot.title = tip;
  }

  (function fixLogo(){
    const el=$('#bdrLogo');
    const fallback2='https://raw.githubusercontent.com/cobby8/assets/main/bdr-logo.png';
    const inline='data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="120" height="36"><rect width="120" height="36" fill="white"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-weight="700" font-family="sans-serif" fill="#111">BDR</text></svg>');
    el.onerror=()=>{ if(el.dataset.fallback==='1'){ el.src=inline; } else { el.dataset.fallback='1'; el.src=fallback2; } };
  })();

  // 설정 버튼
  $('#formSettingsBtn').addEventListener('click', ()=>{
    const cur=(conf.appUrl||'').trim();
    const val=prompt('Apps Script Web App URL을 입력하세요 (…/exec):', cur);
    if(val===null) return;
    if(!validWebAppUrl(val)) { alert('URL 형식이 올바르지 않습니다. (…/exec)'); return; }
    conf.appUrl = val.trim(); store.save(conf);
    show('설정이 저장되었습니다. 다시 시도 중…');
    boot(true);
  });

  $$('.next').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const target=btn.getAttribute('data-next'); if(!target) return;
      const needValidate=btn.hasAttribute('data-validate');
      if(needValidate){ const curr=btn.closest('.step'); if(!validateStep(curr.id)) return; }
      $$('.step').forEach(s=>s.classList.remove('active'));
      document.querySelector(target).classList.add('active');
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });

  /* ===== 대회 목록 ===== */
  let TOUR_MAP={}, currentTour=null;
  let CUR_DIV_COUNT = {};  // 디비전별 현재 신청팀수

  async function loadTournaments(){
    let cached = getCache(TOURN_CACHE_KEY);
    if(cached && Array.isArray(cached.rows)) {
      hydrateTournaments(cached);
      refreshTournamentsSilently();
      return;
    }
    const json = await apiGet('tournaments');
    if(!(json && (json.ok || Array.isArray(json.rows)))){
      setConn('bad', (json && (json.error || (json.raw && '로그인/권한 필요'))) || '연결 실패');
      return;
    }
    setCache(TOURN_CACHE_KEY, json);
    hydrateTournaments(json);
  }

  function hydrateTournaments(json){
    setConn('ok','연결 정상');
    const rows = json.rows || [];
    TOUR_MAP = {};
    const sel = $('#tourSelect');
    const frag = document.createDocumentFragment();
    frag.appendChild(new Option('대회를 선택하세요', ''));
    rows.forEach(t=>{
      const id = t.TourID || t.tourId;
      TOUR_MAP[id] = t;
      const period=(t.start||t.end)?` · ${fmtDate(t.start)}~${fmtDate(t.end)}`:'';
      frag.appendChild(new Option(`${t.name}${t.status?' ('+t.status+')':''}${period}`, id));
    });
    sel.innerHTML='';
    sel.appendChild(frag);
  }

  async function refreshTournamentsSilently(){
    try{
      const j = await apiGet('tournaments');
      if(j && (j.ok || Array.isArray(j.rows))){
        setCache(TOURN_CACHE_KEY, j);
      }
    }catch{}
  }

  const pad2=n=>String(n).padStart(2,'0');
  const fmtDate=v=>{ if(!v) return ''; const d=new Date(v); if(isNaN(d)) return v; return `${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}`; };
  const fmtDT=v=>{ if(!v) return ''; const d=new Date(v); if(isNaN(d)) return v; return `${d.getFullYear()}.${pad2(d.getMonth()+1)}.${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`; };

  async function fetchTourMeta(tourId){
    if(!tourId) return null;
    try { const m = await apiGet('tournament_meta', { tourId }); return (m && m.ok) ? m : null; }
    catch { return null; }
  }
  function isPast(nowIso, targetIso){
    if(!targetIso) return false;
    const now = new Date(nowIso || Date.now());
    const tgt = new Date(targetIso);
    if (isNaN(tgt)) return false;
    return now > tgt;
  }

  function summarizeDivs(divs){
    try{ const obj=(typeof divs==='string')?JSON.parse(divs||'{}'):(divs||{}); const parts=Object.keys(obj).map(cat=>{ const arr=Array.isArray(obj[cat])?obj[cat]:[]; return arr.length?`${cat}: ${arr.join('·')}`:`${cat}`; }); return parts.length?parts.join(' / '):'-'; }
    catch{ return '-'; }
  }
  function parsePlaces(p){
    try{ const arr=Array.isArray(p)?p:JSON.parse(p||'[]'); const names=(arr||[]).map(v=>typeof v==='string'?v:(v&&v.name)||'').filter(Boolean); return names.length?names.join(' · '):'-'; }
    catch{ return '-'; }
  }

  function extractDriveId(u){
    const s=String(u||'').trim();
    if(!s) return '';
    if(/^[A-Za-z0-9_-]{20,}$/.test(s) && !/^https?:\/\//i.test(s)) return s;
    let m = s.match(/\/uc(?:\?[^#]*?)?\bid=([A-Za-z0-9_-]{10,})/); if(m) return m[1];
    m = s.match(/\/d\/([A-Za-z0-9_-]{10,})/); if(m) return m[1];
    m = s.match(/[?&]id=([A-Za-z0-9_-]{10,})/);   if(m) return m[1];
    return '';
  }
  const buildThumb = id => 'https://drive.google.com/thumbnail?id='+encodeURIComponent(id)+'&sz=w1200'; // 썸네일 우선
  const buildView  = id => 'https://drive.google.com/uc?export=view&id='+encodeURIComponent(id);
  const buildDown  = id => 'https://drive.google.com/uc?export=download&id='+encodeURIComponent(id);
  const buildPlain = id => 'https://drive.google.com/uc?id='+encodeURIComponent(id);

  function computePosterVariants(posterUrl, posterId, posterLegacy){
    const variants=[];
    const candidates=[posterId, posterUrl, posterLegacy].filter(v=>typeof v==='string' && v.trim());
    const id=candidates.map(extractDriveId).find(Boolean);
    if(id){ [buildThumb(id), buildView(id), buildPlain(id), buildDown(id)].forEach(u=>{ if(!variants.includes(u)) variants.push(u); }); }
    candidates.forEach(u=>{
      const s=String(u).trim();
      if(/^data:image\//i.test(s)){ if(!variants.includes(s)) variants.push(s); return; }
      if(/\.(png|jpe?g|webp|gif|svg)(\?.*)?$/i.test(s) && !variants.includes(s)) variants.push(s);
      if(/^https?:\/\//i.test(s) && !variants.includes(s)) variants.push(s);
    });
    return variants;
  }

  async function renderPosterStrict(tourId){
    const wrap=$('#posterWrap'), img=$('#posterImg');
    wrap.style.display='none'; img.removeAttribute('src'); img.onerror=null; img.onload=null;
    if(posterAbort) posterAbort.abort();
    posterAbort = new AbortController();
    if(!tourId) return;
    const t = TOUR_MAP[tourId]; if(!t) return;

    const urls = computePosterVariants(t.posterUrl, t.posterId, t.poster);
    if(!urls.length) return;

    let idx=0;
    const tryNext=()=>{ if(idx>=urls.length){ wrap.style.display='none'; img.removeAttribute('src'); return; } img.src = urls[idx++]; };
    img.loading = 'lazy';
    img.decoding = 'async';
    img.fetchPriority = 'low';
    img.width = 800; img.height = 420;
    img.onload = ()=>{ wrap.style.display='block'; };
    img.onerror= ()=>{ tryNext(); };
    tryNext();
  }

  function renderTourInfo(t){
    const box=$('#tourInfo'), nextbar=$('#nextbar0');
    if(!t){ box.style.display='none'; box.innerHTML=''; if(nextbar) nextbar.style.display='none'; return; }
    box.innerHTML = `<div class="kv">
      <b>대회명</b><div>${t.name||'-'}</div>
      <b>종별</b><div>${summarizeDivs(t.divs)}</div>
      <b>일시</b><div>${(t.start||t.end)?`${fmtDate(t.start)} ~ ${fmtDate(t.end)}`:'일정미정'}</div>
      <b>장소</b><div>${parsePlaces(t.places)}</div>
      <b>접수기간</b><div>${(t.regStart||t.regEnd)?`${fmtDT(t.regStart)} ~ ${fmtDT(t.regEnd)}`:'미정'}</div>
      <b>수정 마감</b><div id="editDeadlineCell">${t.editDeadlineAt ? fmtDT(t.editDeadlineAt) : '— (미설정)'}</div>
      ${(!t.url || /^data:image\//i.test(t.url)) ? '' : `<b>안내페이지</b><div><a href="${t.url}" target="_blank" rel="noopener">${t.url}</a></div>`}
    </div>`;
    box.style.display='block';
    if(nextbar) nextbar.style.display='flex';
  }

  document.getElementById('tourSelect').addEventListener('change', (e) => {
    const id = e.target.value;
    const token = ++lastTourChangeToken;  // 최신 선택 토큰
    currentTour = id ? TOUR_MAP[id] : null;

    renderTourInfo(currentTour);
    renderPosterStrict(id || ''); // await 하지 않음 → UI 즉시 반응

    // 카테고리/디비전 즉시 표기
    fillCategoriesFromTour(currentTour);
    updateDivisionHint();

    // 수정 마감 최신화(비차단)
    if (id) {
      apiGet('tournament_meta', { tourId: id }).then(meta=>{
        if (meta && meta.ok && token===lastTourChangeToken) {
          const cell = document.getElementById('editDeadlineCell');
          if (cell) cell.textContent = meta.editDeadlineAt ? fmtDT(meta.editDeadlineAt) : '— (미설정)';
        }
      }).catch(()=>{});
      // 디비전 카운트 로딩(스마트)
      loadAppliedCountsSmart(id, token, true);
    }
  });

  /* ===== 종별/디비전 ===== */
  const categorySelect=$('#category'), divisionSelect=$('#division');

  // ---- Division Key Normalizer & Accessor ----
  const normDv = (s) => String(s||'')
    .trim()
    .replace(/\s+/g,' ')          // 중복 공백 정리
    .toUpperCase();               // 대소문자 정규화
  
  function getAppliedCount(dv){
    const k = normDv(dv);
    if (CUR_DIV_COUNT[k] != null) return Number(CUR_DIV_COUNT[k])||0;
    // 접두어가 붙은 케이스(U14B D1 등) 대비: 마지막 토큰으로도 한 번 더 조회
    const last = k.split(' ').pop();
    if (CUR_DIV_COUNT[last] != null) return Number(CUR_DIV_COUNT[last])||0;
    return 0;
  }

  function getDivCapsObj(){
    if(!currentTour) return {};
    let caps = currentTour.divCaps;
    if (typeof caps === 'string') {
      try { caps = JSON.parse(caps); } catch { caps = {}; }
    }
    return (caps && typeof caps === 'object') ? caps : {};
  }
  function getCapForDivision(dv){
    const caps = getDivCapsObj();
    const raw = caps && (caps[dv]);
    const n = Number(raw);
    return Number.isFinite(n) ? n : null;
  }
  function formatDivisionLabel(dv){
    const applied = getAppliedCount(dv);
    const cap = getCapForDivision(dv);
    return cap!=null ? `${dv} (${applied}/${cap})` : `${dv} (${applied}/-)`;
  }
  function updateDivisionHint(){
    const box = $('#divCapHint');
    if(!box){ return; }
    const dv = $('#division').value || '';
    if(!dv){ box.style.display='none'; box.textContent=''; return; }
    const applied = getAppliedCount(dv);
    const cap = getCapForDivision(dv);
    if(cap==null){
      box.textContent = `현재 신청팀수: ${applied}팀 (모집정원 미설정)`;
    }else{
      const left = Math.max(0, cap - applied);
      box.textContent = applied >= cap
        ? `현재 신청팀수: ${applied}팀 / 모집정원: ${cap}팀  → 마감됨`
        : `현재 신청팀수: ${applied}팀 / 모집정원: ${cap}팀  (잔여 ${left}팀)`;
    }
    box.style.display='';
  }

  function resetCategoryDivisionUI(){
    categorySelect.value = '';
    divisionSelect.innerHTML = '<option value="">종별을 먼저 선택하세요</option>';
    divisionSelect.disabled = true;
  }

  function fillCategoriesFromTour(t){
    categorySelect.innerHTML='';
    divisionSelect.innerHTML='<option value="">종별을 먼저 선택하세요</option>';
    divisionSelect.disabled=true;
    if(!t || !t.divs || !Object.keys(t.divs).length){
      categorySelect.disabled=true;
      categorySelect.innerHTML='<option value="">대회에 종별/디비전 설정이 없습니다</option>';
      return;
    }
    categorySelect.disabled=false;
    categorySelect.appendChild(new Option('선택',''));
    Object.keys(t.divs).forEach(cat=> categorySelect.appendChild(new Option(cat,cat)));
  }

  // 전역 1회만 등록
  divisionSelect.addEventListener('change', updateDivisionHint);

  categorySelect.addEventListener('change',e=>{
    const cat=e.target.value;
    divisionSelect.innerHTML='';
    if(!currentTour || !cat){
      divisionSelect.disabled=true;
      divisionSelect.innerHTML='<option value="">종별을 먼저 선택하세요</option>';
      return;
    }
    const arr=currentTour.divs[cat]||[];
    if(!arr.length){
      divisionSelect.disabled=true;
      divisionSelect.innerHTML='<option value="">해당 종별의 디비전 없음</option>';
      return;
    }
    divisionSelect.disabled=false;
    const frag=document.createDocumentFragment();
    frag.appendChild(new Option('선택',''));
    arr.forEach(dv=>{
      const label = formatDivisionLabel(dv);
      const opt = new Option(label, dv);
      const cap = getCapForDivision(dv);
      const applied = getAppliedCount(dv);
      if (cap!=null && applied >= cap) {
        opt.disabled = true;
        opt.textContent = label + ' [마감]';
      }
      frag.appendChild(opt);
    });
    divisionSelect.innerHTML='';
    divisionSelect.appendChild(frag);
    updateDivisionHint();
  });

  /* ===== 유니폼 SVG/색상 ===== */
  function renderJersey(svgEl, hex){
    svgEl.innerHTML = `
      <defs><filter id="shadow" x="-20%" y="-20%" width="140%"><feDropShadow dx="0" dy="2" stdDeviation="2"></feDropShadow></filter></defs>
      <g filter="url(#shadow)">
        <path d="M35 10 L50 10 L54 22 L66 22 L70 10 L85 10 L85 34 L95 42 L95 130 L25 130 L25 42 L35 34 Z" fill="${hex}" stroke="#111" stroke-width="1.5"/>
        <path d="M54 22 L60 28 L66 22" fill="none" stroke="#111" stroke-width="2"/>
        <rect x="38" y="60" width="44" height="8" rx="4" fill="rgba(255,255,255,0.25)"/>
        <path d="M35 34 L35 24" stroke="#111" stroke-width="1"/>
        <path d="M85 34 L85 24" stroke="#111" stroke-width="1"/>
      </g>`;
  }
  function hexToRgb(h){ const s=h.replace('#',''); return { r:parseInt(s.slice(0,2),16), g:parseInt(s.slice(2,4),16), b:parseInt(s.slice(4,6),16) }; }
  function relLum({r,g,b}){ const c=[r,g,b].map(v=>{v/=255; return v<=0.03928? v/12.92 : Math.pow((v+0.055)/1.055,2.4)}); return 0.2126*c[0]+0.7152*c[1]+0.0722*c[2]; }
  function contrastRatio(h1,h2){ try{const L1=relLum(hexToRgb(h1)); const L2=relLum(hexToRgb(h2)); const [a,b]=L1>L2?[L1,L2]:[L2,L1]; return (a+0.05)/(b+0.05);}catch{return 7}}
  function checkContrast(){
    const h=$('#uniformHome').value||'', a=$('#uniformAway').value||'';
    const warn=$('#contrastWarn'); const ok1=/^#[0-9A-Fa-f]{6}$/.test(h), ok2=/^#[0-9A-Fa-f]{6}$/.test(a);
    if(!ok1 && !ok2){ warn.style.display='none'; return; }
    const poor = (ok1 && Math.max(contrastRatio(h,'#000'), contrastRatio(h,'#fff')) < 4.5) ||
                 (ok2 && Math.max(contrastRatio(a,'#000'), contrastRatio(a,'#fff')) < 4.5);
    warn.style.display=poor?'block':'none';
  }
  function syncColor({hexId, pickerId, jerseyId, confirmId}){
    const hexEl=$(hexId), picker=$(pickerId), svg=$(jerseyId), confirmBtn=$(confirmId);
    const initVal = /^#[0-9A-Fa-f]{6}$/.test(hexEl.value) ? hexEl.value : (picker.value || '#000000');
    hexEl.value = initVal; picker.value = initVal; renderJersey(svg, initVal);
    const normalizeHex=v=>{ const val=(v||'').startsWith('#')?v:'#'+(v||''); return /^#[0-9A-Fa-f]{6}$/.test(val)?val:''; }
    picker.addEventListener('input', e=>{ const v=normalizeHex(e.target.value); if(!v) return; renderJersey(svg,v); confirmBtn.style.display='inline-block'; });
    confirmBtn.addEventListener('click', ()=>{ const v=normalizeHex(picker.value); if(!v) return; hexEl.value=v; renderJersey(svg,v); confirmBtn.style.display='none'; checkContrast(); });
    hexEl.addEventListener('input', e=>{ const raw=e.target.value.replace('#',''); if(/^[0-9A-Fa-f]{6}$/.test(raw)){ const v='#'+raw; picker.value=v; renderJersey(svg,v); confirmBtn.style.display='none'; checkContrast(); }});
  }
  syncColor({hexId:'#uniformHome', pickerId:'#uniformHomePicker', jerseyId:'#jerseyHome', confirmId:'#uniformHomeConfirm'});
  syncColor({hexId:'#uniformAway', pickerId:'#uniformAwayPicker', jerseyId:'#jerseyAway', confirmId:'#uniformAwayConfirm'});

  /* ===== 연락처/지역 ===== */
  $('#ownerPhone').addEventListener('input',e=> e.target.value=(e.target.value||'').replace(/\D+/g,'').slice(0,11));
  $('#managerPhone').addEventListener('input',e=> e.target.value=(e.target.value||'').replace(/\D+/g,'').slice(0,11));
  const regionMap={'서울특별시':['강남구','강동구','강북구','강서구','관악구','광진구','구로구','금천구','노원구','도봉구','동대문구','동작구','마포구','서대문구','서초구','성동구','성북구','송파구','양천구','영등포구','용산구','은평구','종로구','중구','중랑구'],
  '부산광역시':['강서구','금정구','남구','동구','동래구','부산진구','북구','사상구','사하구','서구','수영구','연제구','영도구','중구','해운대구','기장군'],
  '대구광역시':['남구','달서구','동구','북구','서구','수성구','중구','달성군','군위군'],
  '인천광역시':['강화군','계양구','미추홀구','남동구','동구','부평구','서구','연수구','중구','옹진군'],
  '광주광역시':['광산구','남구','동구','북구','서구'],
  '대전광역시':['대덕구','동구','서구','유성구','중구'],
  '울산광역시':['남구','동구','북구','중구','울주군'],
  '세종특별자치시':['세종시'],
  '경기도':['가평군','고양시','과천시','광명시','광주시','구리시','군포시','김포시','남양주시','동두천시','부천시','성남시','수원시','시흥시','안산시','안성시','안양시','양주시','양평군','여주시','연천군','오산시','용인시','의왕시','의정부시','이천시','파주시','평택시','포천시','하남시','화성시'],
  '강원특별자치도':['강릉시','동해시','속초시','삼척시','원주시','춘천시','태백시','고성군','양구군','양양군','영월군','인제군','정선군','철원군','평창군','홍천군','화천군','횡성군'],
  '충청북도':['제천시','청주시','충주시','괴산군','단양군','보은군','영동군','옥천군','음성군','증평군'],
  '충청남도':['계룡시','공주시','논산시','당진시','보령시','서산시','아산시','천안시','금산군','부여군','서천군','예산군','청양군','태안군','홍성군'],
  '전북특별자치도':['전주시','군산시','익산시','정읍시','남원시','김제시','완주군','고창군','무주군','부안군','순창군','임실군','장수군','진안군'],
  '전라남도':['광양시','나주시','목포시','순천시','여수시','강진군','고흥군','곡성군','구례군','담양군','무안군','보성군','신안군','영광군','영암군','완도군','장성군','장흥군','진도군','함평군','해남군','화순군'],
  '경상북도':['경산시','경주시','구미시','김천시','문경시','상주시','안동시','영주시','영천시','포항시','고령군','군위군','봉화군','성주군','영덕군','영양군','예천군','울릉군','울진군','의성군','청도군','청송군','칠곡군'],
  '경상남도':['거제시','김해시','밀양시','사천시','양산시','진주시','창원시','통영시','거창군','고성군','남해군','산청군','의령군','창녕군','하동군','함안군','함양군','합천군'],
  '제주특별자치도':['제주시','서귀포시']};
  $('#province').addEventListener('change',e=>{
    const prov=e.target.value; const citySel=$('#city'); citySel.innerHTML='';
    if(!prov){ citySel.disabled=true; citySel.innerHTML='<option value="">시도를 먼저 선택하세요</option>'; }
    else{ citySel.disabled=false; citySel.appendChild(new Option('선택','')); (regionMap[prov]||[]).forEach(c=>citySel.appendChild(new Option(c,c))); }
  });

  /* ===== 선수 카드 & 붙여넣기 ===== */
  function createPlayerCard(){
    const div=document.createElement('div');
    div.className='player-card';
    div.style.cssText='border:1px dashed #e6ecf5;border-radius:14px;padding:10px;margin-top:10px;background:#fafcff';
    div.innerHTML = `<div class="row row-3">
      <div><label>선수 이름</label><input data-key="name" placeholder="이름"></div>
      <div><label>등번호</label><input data-key="number" inputmode="numeric" placeholder="예: 7"></div>
      <div><label>포지션</label><select data-key="position"><option value="">선택</option><option>G</option><option>F</option><option>C</option></select></div>
    </div>
    <div class="row row-2" style="margin-top:8px">
      <div><label>생년월일</label><input data-key="birth" type="date"></div>
      <div><label>선출여부</label><select data-key="elite"><option value="">선택</option><option>선출</option><option>비선출</option></select></div>
    </div>
    <div style="text-align:right;margin-top:6px"><button class="btn-sm remove" type="button">삭제</button></div>`;
    const num = div.querySelector('[data-key="number"]');
    num.addEventListener('input', e=> e.target.value = (e.target.value||'').replace(/\D+/g,''));
    div.querySelector('.remove').addEventListener('click',()=>div.remove());
    return div;
  }
  const playersDiv=$('#players');
  $('#addPlayerBtn').addEventListener('click',()=>playersDiv.appendChild(createPlayerCard()));
  (function initFivePlayers(){
    const frag = document.createDocumentFragment();
    for(let i=0;i<5;i++) frag.appendChild(createPlayerCard());
    $('#players').appendChild(frag);
  })();

  $('#togglePasteBtn').addEventListener('click', ()=>{ const p=$('#pastePanel'); p.style.display=p.style.display==='none'?'block':'none'; });
  $('#pasteClearBtn')?.addEventListener('click', ()=> $('#pasteText').value='' );
  const SAMPLE=`홍길동/7/G/010302/비선출
김철수/11/F/000615/선출`;
  $('#copySampleBtn').addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(SAMPLE); show('샘플이 복사되었습니다. 붙여넣기 후 적용을 누르세요.'); }
    catch(e){ const ta=document.createElement('textarea'); ta.value=SAMPLE; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); show('샘플이 복사되었습니다.'); }
    $('#pastePanel').style.display='block'; $('#pasteText').focus();
  });
  function yyToYYYY(yy){ const n=parseInt(yy,10); if(isNaN(n)) return '2000'; return (n>=50?'19':'20') + (n<10?('0'+n):String(n)); }
  function normalizeBirth(s){
    const v=(s||'').replace(/\D/g,'');
    if (v.length===6)  return `${yyToYYYY(v.slice(0,2))}-${v.slice(2,4)}-${v.slice(4,6)}`;
    if (v.length===8)  return `${v.slice(0,4)}-${v.slice(4,6)}-${v.slice(6,8)}`;
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    return '';
  }
  $('#pasteApplyBtn').addEventListener('click', ()=>{
    const text=$('#pasteText').value||''; if(!text.trim()) return;
    const lines=text.replace(/\r\n/g,'\n').split('\n').map(s=>s.trim()).filter(Boolean);
    const allCards=$$('.player-card'); const allEmpty=allCards.length && allCards.every(c=>!c.querySelector('[data-key="name"]').value.trim());
    if(allEmpty) playersDiv.innerHTML='';
    const frag=document.createDocumentFragment();
    lines.forEach(line=>{
      const cols=line.split(/[\/,\t]| {2,}/).map(s=>s.trim());
      const [name='', number='', position='', birthYY='', elite=''] = cols;
      const card=createPlayerCard();
      card.querySelector('[data-key="name"]').value=name;
      card.querySelector('[data-key="number"]').value=number;
      card.querySelector('[data-key="position"]').value=(position||'').toUpperCase();
      card.querySelector('[data-key="birth"]').value=normalizeBirth(birthYY);
      card.querySelector('[data-key="elite"]').value=elite||'';
      frag.appendChild(card);
    });
    playersDiv.appendChild(frag);
    show('붙여넣기 적용 완료');
  });

  /* ===== 검증 ===== */
  function setErr(el,noteId,on){ if(!el) return; if(on){ el.classList.add('error'); if(noteId) $('#'+noteId).style.display='block'; } else { el.classList.remove('error'); if(noteId) $('#'+noteId).style.display='none'; } }

  function validateStep(stepId){
    let ok=true;
    if(stepId==='step0'){ const v=$('#tourSelect').value; if(!v){ show('대회를 선택해 주세요'); ok=false; } }
    if(stepId==='step1'){
      const prov=$('#province'), city=$('#city'), tKo=$('#teamNameKo'), tEn=$('#teamNameEn'), man=$('#managerName'), ph=$('#managerPhone');
      const phOk=/^\d{10,11}$/.test(ph.value);
      setErr(prov,'errProvince',!prov.value); setErr(city,'errCity',!city.value);
      setErr(tKo,'errTeamNameKo',!tKo.value.trim()); setErr(tEn,'errTeamNameEn',!tEn.value.trim());
      setErr(man,'errManagerName',!man.value.trim()); setErr(ph,'errPhone',!phOk);
      ok = prov.value && city.value && tKo.value.trim() && tEn.value.trim() && man.value.trim() && phOk;
      if(!ok) show('필수 항목을 확인해 주세요');
    }
    if(stepId==='step2'){
      const cat=$('#category'), div=$('#division');
      setErr(cat,'errCategory',!cat.value); setErr(div,'errDivision',!div.value);
      ok=!!(cat.value&&div.value);
      if(!ok) show('종별/디비전을 선택해 주세요');
    }
    return ok;
  }

  function validatePlayersStrict(){
    const cards=$$('.player-card');
    if(cards.length<5){ alert('선수는 최소 5명 이상 입력해 주세요.'); return false; }
    cards.forEach(c=> c.querySelectorAll('input,select').forEach(el=>el.classList.remove('error')));

    const numbers=[]; let firstBad=null;
    for(const card of cards){
      const nameEl=card.querySelector('[data-key="name"]');
      const numEl=card.querySelector('[data-key="number"]');
      const posEl=card.querySelector('[data-key="position"]');
      const birthEl=card.querySelector('[data-key="birth"]');
      const eliteEl=card.querySelector('[data-key="elite"]');

      const name=(nameEl.value||'').trim();
      const number=(numEl.value||'').trim();
      const position=(posEl.value||'').trim();
      const birth=(birthEl.value||'').trim();
      const elite=(eliteEl.value||'').trim();

      const numOk=/^\d+$/.test(number);
      const requiredMap = [
        [nameEl, !!name],
        [numEl, numOk],
        [posEl, !!position],
        [birthEl, !!birth],
        [eliteEl, !!elite],
      ];
      requiredMap.forEach(([el,ok])=>{ if(!ok){ el.classList.add('error'); if(!firstBad) firstBad=el; } });

      numbers.push(number);
    }

    const seen=new Set(), dups=new Set();
    numbers.forEach(n=>{ if(seen.has(n)) dups.add(n); else seen.add(n); });
    if(dups.size){
      cards.forEach(c=>{
        const el=c.querySelector('[data-key="number"]');
        if(dups.has((el.value||'').trim())) el.classList.add('error');
      });
      if(!firstBad){
        const firstDupCard=[...cards].find(c=>dups.has((c.querySelector('[data-key="number"]').value||'').trim()));
        if(firstDupCard) firstBad=firstDupCard.querySelector('[data-key="number"]');
      }
      show('등번호가 중복되었습니다. 중복을 해결해 주세요.');
    }

    if(firstBad){
      firstBad.scrollIntoView({behavior:'smooth', block:'center'});
      return false;
    }
    return true;
  }

  // ✅ force=true 이면 캐시 무시하고 강제 새로고침
  async function loadAppliedCountsSmart(tourId, token, force=false){
    // 캐시 우선(단, force=false일 때만)
    const cached = !force && divCountCache.get(tourId);
    if(cached && (Date.now()-cached.ts) < DIVCOUNT_TTL){
      if(token===lastTourChangeToken){
        CUR_DIV_COUNT = {...cached.data};
        if (categorySelect.value) categorySelect.dispatchEvent(new Event('change'));
        updateDivisionHint();
      }
      return;
    }
  
    // 진행 중 요청 취소
    if(appliedCountsAbort) appliedCountsAbort.abort();
    appliedCountsAbort = new AbortController();
  
    const endpoints = ['teams_count','teamsCount','team_counts','teamCounts','teams/count'];
    const paramVariants = [
      { tourId },
      { id: tourId },
      { TourID: tourId }
    ];
  
    let counts = null;
  
    // 1) 경량 엔드포인트들 시도 (여러 파라미터 키 동시 대응)
    for(const path of endpoints){
      for(const params of paramVariants){
        const j = await apiGet(path, params, { signal: appliedCountsAbort.signal });
        if(j && j.error==='ABORTED') return;
        // (counts 객체로 받을 때)
        if(j && j.ok && j.counts && typeof j.counts==='object'){
          const out={};
          Object.entries(j.counts).forEach(([k,v])=>{
            const nk = normDv(k);
            if(!nk) return;
            out[nk] = (Number(v)||0);
            // 보조키: 마지막 토큰(D1 등)도 조회용으로 한 번 더 저장(덮어쓰지 않음)
            const last = nk.split(' ').pop();
            if(out[last]==null) out[last] = out[nk];
          });
          counts = out; break;
        }
        
        // (rows 배열로 받을 때)
        if(j && Array.isArray(j.rows)){
          const out={};
          j.rows.forEach(r=>{
            const raw = String(r.division||r.Division||'').trim();
            if(!raw) return;
            const nk = normDv(raw);
            out[nk] = (out[nk]||0) + (Number(r.count||r.Count||1)||1);
            const last = nk.split(' ').pop();
            if(out[last]==null) out[last] = out[nk];
          });
          counts = out; break;
        }
        
        // (teams 폴백 합산부에서도 동일 정규화)
        if(j && Array.isArray(j.rows)){
          const out={};
          j.rows.forEach(r=>{
            const raw = String(r.division||r.Division||'').trim();
            if(!raw) return;
            const nk = normDv(raw);
            out[nk] = (out[nk]||0) + 1;
            const last = nk.split(' ').pop();
            if(out[last]==null) out[last] = out[nk];
          });
          counts = out; break;
        }

    // 2) 폴백: 전체 teams 읽어서 집계 (파라미터 키 다양화)
    if(!counts){
      for(const params of paramVariants){
        const j = await apiGet('teams', params, { signal: appliedCountsAbort.signal });
        if(j && j.error==='ABORTED') return;
        if(j && Array.isArray(j.rows)){
          const out={};
          j.rows.forEach(r=>{
            const key = String(r.division||r.Division||'').trim();
            if(key) out[key]=(out[key]||0)+1;
          });
          counts = out; break;
        }
      }
    }
  
    if(token!==lastTourChangeToken) return;
  
    CUR_DIV_COUNT = counts || {};
    divCountCache.set(tourId, { ts: Date.now(), data: CUR_DIV_COUNT });
  
    // 라벨/힌트 갱신
    if (categorySelect.value) categorySelect.dispatchEvent(new Event('change'));
    updateDivisionHint();
  }

  /* ===== 본인 신청서 찾기/불러오기/복제/취소 ===== */
  let ownerEdit=null;
  let cloneSource=null;

  $('#ownerFindBtn').addEventListener('click', async ()=>{
    const name=$('#ownerName').value.trim(); const phone=($('#ownerPhone').value||'').replace(/\D/g,'');
    if(!name || phone.length<8){ show('이름과 연락처(숫자만)를 입력하세요'); return; }
    try{
      const json = await apiGet('findteam', { name, phone });
      if(!json.ok){ alert('오류: '+(json.error||'fail')); return; }
      const list=json.items||[]; if(list.length===0){ show('일치하는 신청서가 없습니다.'); $('#ownerResult').style.display='none'; return; }
      const sel=$('#ownerTeamSel'); sel.innerHTML='';
      list.forEach(it=>{
        const txt=`${it.teamNameKo||'(팀명없음)'} / ${it.tourName||'-'} ${it.category?(' / '+it.category):''}${it.division?(' '+it.division):''}`;
        sel.appendChild(new Option(txt, it.teamId));
      });
      $('#ownerResult').style.display='block';
      $('#clonePanel').style.display='none';
    }catch(e){ alert('네트워크 오류'); }
  });

  async function fillFormFromTeam_(t, pls){
    if (t.tourId && TOUR_MAP[t.tourId]) {
      $('#tourSelect').value = t.tourId; currentTour = TOUR_MAP[t.tourId];
      renderTourInfo(currentTour); renderPosterStrict(t.tourId); fillCategoriesFromTour(currentTour);
    }
    $('#province').value = t.province || ''; $('#province').dispatchEvent(new Event('change')); setTimeout(()=>{ $('#city').value = t.city || ''; }, 0);
    $('#teamNameKo').value = t.teamNameKo || ''; $('#teamNameEn').value = t.teamNameEn || '';
    $('#managerName').value = t.managerName || ''; $('#managerPhone').value = String(t.managerPhone||'').replace(/\D/g,'');

    if (t.category){
      $('#category').value = t.category;
      $('#category').dispatchEvent(new Event('change'));
      setTimeout(()=>{ 
        if(t.division){
          $('#division').value = t.division;
          $('#division').dispatchEvent(new Event('change'));
        }
      }, 0);
    }

    $('#uniformHome').value = t.uniformHome || '#ff0000'; $('#uniformAway').value = t.uniformAway || '#ffffff';
    $('#uniformHomePicker').value = $('#uniformHome').value; $('#uniformAwayPicker').value = $('#uniformAway').value;
    renderJersey($('#jerseyHome'), $('#uniformHome').value); renderJersey($('#jerseyAway'), $('#uniformAway').value); checkContrast();

    playersDiv.innerHTML='';
    const frag=document.createDocumentFragment();
    (pls||[]).forEach(pl=>{
      const c=createPlayerCard();
      c.querySelector('[data-key="name"]').value=pl.name||pl['선수이름']||'';
      c.querySelector('[data-key="number"]').value=pl.number||pl['등번호']||'';
      c.querySelector('[data-key="position"]').value=(pl.position||pl['포지션']||'').toUpperCase();
      c.querySelector('[data-key="birth"]').value=pl.birth||pl['생년월일']||'';
      c.querySelector('[data-key="elite"]').value=pl.elite||'';
      frag.appendChild(c);
    });
    playersDiv.appendChild(frag);
  }

  $('#ownerEditBtn').addEventListener('click', async ()=>{
    const teamId=$('#ownerTeamSel').value; const name=$('#ownerName').value.trim(); const phone=($('#ownerPhone').value||'').replace(/\D/g,'');
    if(!teamId){ show('신청서를 선택하세요'); return; }
    try{
      const json = await apiGet('getTeamByOwner', { name, phone, teamId });
      if(!json.ok){ alert('오류: '+(json.error||'fail')); return; }
      ownerEdit={teamId,name,phone};
      await fillFormFromTeam_(json.team||{}, json.players||[]);
      if (currentTour && currentTour.tourId) {
        const meta = await fetchTourMeta(currentTour.tourId);
        if (meta && meta.editDeadlineAt) show('수정 마감: ' + fmtDT(meta.editDeadlineAt));
      }
      show('신청서가 불러와졌습니다. 수정 후 제출하세요.');
      $$('.step').forEach(s=>s.classList.remove('active')); $('#step1').classList.add('active'); window.scrollTo({top:0,behavior:'smooth'});
    }catch(e){ alert('네트워크 오류'); }
  });

  function fillCloneTourOptions(){
    const sel=$('#cloneTourSel');
    sel.innerHTML='<option value="">대회를 선택하세요</option>';
    Object.keys(TOUR_MAP).forEach(id=>{
      const t=TOUR_MAP[id];
      sel.appendChild(new Option(`${t.name}${t.status?' ('+t.status+')':''}`, id));
    });
  }
  $('#ownerCloneBtn').addEventListener('click', async ()=>{
    const teamId=$('#ownerTeamSel').value; const name=$('#ownerName').value.trim(); const phone=($('#ownerPhone').value||'').replace(/\D/g,'');
    if(!teamId){ show('신청서를 선택하세요'); return; }
    try{
      const json = await apiGet('getTeamByOwner', { name, phone, teamId });
      if(!json.ok){ alert('오류: '+(json.error||'fail')); return; }
      cloneSource={ team: json.team||{}, players: json.players||[] };
      fillCloneTourOptions();
      $('#clonePanel').style.display='block';
      show('새 대회를 선택한 뒤 [추가 신청하기]를 누르세요.');
    }catch(e){ alert('네트워크 오류'); }
  });

  $('#ownerCloneSubmitBtn').addEventListener('click', async ()=>{
    if(!cloneSource || !cloneSource.team){ show('먼저 원본 신청서를 선택해 주세요.'); return; }
    const newTourId=$('#cloneTourSel').value;
    if(!newTourId){ show('새 대회를 선택해 주세요'); return; }
    const newTour=TOUR_MAP[newTourId];
    if(!newTour){ show('대회 정보를 불러오지 못했습니다'); return; }

    const src=cloneSource.team, srcPlayers=cloneSource.players||[];
    await fillFormFromTeam_({...src, tourId:newTourId}, srcPlayers);
    currentTour=newTour; fillCategoriesFromTour(newTour);
    resetCategoryDivisionUI();
    ownerEdit=null;

    $$('.step').forEach(s=>s.classList.remove('active')); $('#step2').classList.add('active');
    window.scrollTo({top:0,behavior:'smooth'});
    show('새 대회로 불러왔습니다. ② 종별/디비전을 다시 선택해 주세요.');
  });

  /* ===== 참가취소: 모달 ===== */
  const cancelModal = $('#cancelModal');
  let lastFocused=null;

  function openCancelModal(){
    cancelModal.classList.add('show');
    lastFocused=document.activeElement;
    $('#cancelYesBtn').focus();
    function trap(e){
      if(e.key==='Tab'){
        const f = cancelModal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        const focusables = Array.from(f).filter(el=>!el.hasAttribute('disabled'));
        const first=focusables[0], last=focusables[focusables.length-1];
        if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
        else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
      } else if(e.key==='Escape'){ closeCancelModal(); }
    }
    cancelModal.addEventListener('keydown', trap);
    cancelModal._trap = trap;
  }
  function closeCancelModal(){
    cancelModal.classList.remove('show');
    if(cancelModal._trap){ cancelModal.removeEventListener('keydown', cancelModal._trap); cancelModal._trap=null; }
    if(lastFocused) lastFocused.focus();
  }
  $('#cancelCloseBtn').addEventListener('click', closeCancelModal);
  $('#cancelNoBtn').addEventListener('click', closeCancelModal);
  cancelModal.addEventListener('click', (e)=>{ if(e.target===cancelModal) closeCancelModal(); });

  $('#ownerCancelBtn').addEventListener('click', ()=>{
    const teamId=$('#ownerTeamSel').value;
    if(!teamId){ show('취소할 신청서를 먼저 선택하세요'); return; }
    openCancelModal();
  });

  $('#cancelYesBtn').addEventListener('click', async ()=>{
    const teamId=$('#ownerTeamSel').value; 
    const name=$('#ownerName').value.trim(); 
    const phone=($('#ownerPhone').value||'').replace(/\D/g,'');
    if(!teamId){ show('취소할 신청서를 선택하세요'); return; }
    if(!name || phone.length<8){ show('이름과 연락처를 다시 확인하세요'); return; }

    const candidates = ['cancelteambyowner','cancelTeamByOwner','deleteteambyowner','deleteTeamByOwner'];
    const payload = { name, phone, teamId };

    const yesBtn = $('#cancelYesBtn'); yesBtn.disabled = true; yesBtn.textContent = '처리 중…';
    try{
      const json = await apiPost(candidates, payload);
      if(json && json.ok){
        closeCancelModal();
        show('취소 완료: 신청서가 삭제되었습니다.');
        $('#ownerTeamSel').innerHTML='';
        $('#ownerResult').style.display='none';
        ownerEdit=null; cloneSource=null;
        resetAllFormUI();
      }else{
        alert('취소 실패: ' + (json && (json.error||json.raw) || 'unknown'));
      }
    }catch(e){
      alert('네트워크 오류로 취소에 실패했습니다.');
    }finally{
      yesBtn.disabled=false; yesBtn.textContent='확인(삭제)';
    }
  });

  function resetAllFormUI(){
    $('#tourSelect').value='';
    renderTourInfo(null);
    $('#posterWrap').style.display='none';
    $('#province').value=''; $('#province').dispatchEvent(new Event('change'));
    $('#teamNameKo').value=''; $('#teamNameEn').value='';
    $('#managerName').value=''; $('#managerPhone').value='';
    categorySelect.innerHTML='<option value="">대회를 먼저 선택하세요</option>'; categorySelect.disabled=true;
    divisionSelect.innerHTML='<option value="">종별을 먼저 선택하세요</option>'; divisionSelect.disabled=true;
    $('#uniformHome').value='#ff0000'; $('#uniformAway').value='#ffffff';
    $('#uniformHomePicker').value='#ff0000'; $('#uniformAwayPicker').value='#ffffff';
    renderJersey($('#jerseyHome'), '#ff0000'); renderJersey($('#jerseyAway'), '#ffffff'); checkContrast();
    playersDiv.innerHTML='';
    const frag=document.createDocumentFragment(); for(let i=0;i<5;i++) frag.appendChild(createPlayerCard()); playersDiv.appendChild(frag);
    $$('.step').forEach(s=>s.classList.remove('active')); $('#step0').classList.add('active');
    window.scrollTo({top:0,behavior:'smooth'});
  }

  // --- [SUBMIT LOCK HELPER] 중복 제출 방지 ---
  let IS_SUBMITTING = false;
  function setSubmitting(on){
    const btn = document.getElementById('submitBtn');
    if(!btn) return;
    if(on){
      IS_SUBMITTING = true;
      btn.disabled = true;
      btn.textContent = '제출 중';
      btn.setAttribute('aria-busy','true');
      btn.style.pointerEvents = 'none';
    }else{
      IS_SUBMITTING = false;
      btn.disabled = false;
      btn.textContent = '신청서 제출';
      btn.removeAttribute('aria-busy');
      btn.style.pointerEvents = '';
    }
  }

  /* ===== 제출(신규/수정 공용) ===== */
  function safelyCopy(txt, label){
    if(!txt){ show(label+' 정보가 없습니다. 관리자 설정 대기'); return; }
    navigator.clipboard.writeText(txt).then(()=>{ show(label+' 복사 완료'); })
    .catch(()=>{ const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); show(label+' 복사 완료'); });
  }
  function extractPaymentInfo(t){
    const obj=t||{};
    const tryKeys=(o, keys)=>{ for(const k of keys){ if(k in o && String(o[k]??'').trim()) return String(o[k]); } return ''; };
    const fee = tryKeys(obj, ['fee','entryFee','entry_fee','참가비','참가비용','등록비']);
    const acct = tryKeys(obj, ['account','bankAccount','bank_account','입금계좌','계좌','입금정보']);
    return { fee, acct };
  }
  function buildPayText(fee, acct){
    const feeLine  = `참가비 ${String(fee||'').trim()||'-'}원`;
    let acctLine = String(acct||'').trim();
    if(!acctLine){
      acctLine = '은행명 계좌번호 예금주';
    }else{
      acctLine = acctLine.replace(/[,\|/]+/g,' ').replace(/\s{2,}/g,' ').trim();
      acctLine = acctLine.replace(/(예금주)\s*[:：]\s*/g,'$1 ');
    }
    return `${feeLine}\n${acctLine}`;
  }
  function showFloatingPanelAfterSubmit(){
    const el = $('#floatingDone');
    const { fee, acct } = extractPaymentInfo(currentTour || {});
    const txt = buildPayText(fee, acct);
    $('#payText').textContent = txt;
    const ready = Boolean(String(fee||'').trim() && String(acct||'').trim());
    $('#floatingSub').innerHTML = ready
      ? '아래 정보를 확인하고 복사하세요.'
      : '관리자 설정 대기: 참가비/입금계좌가 아직 없습니다. (관리자 설정 후 자동 노출)';
    const copyBtn = $('#copyPayBtn');
    copyBtn.disabled = !ready;
    copyBtn.onclick = () => safelyCopy(txt, '결제정보');
    el.classList.add('show');
    if(el._hideTimer) clearTimeout(el._hideTimer);
    el._hideTimer = setTimeout(()=>{ el.classList.remove('show'); }, 30000);
  }

  document.getElementById('submitBtn').addEventListener('click', async ()=>{
    if (IS_SUBMITTING) return;          // ✅ 이미 진행 중이면 무시
    setSubmitting(true);                 // ✅ 즉시 잠금 + '제출 중'
  
    // ✅ 유효성 체크 (실패 시 즉시 잠금 해제)
    if (!validateStep('step0') || !validateStep('step1') || !validateStep('step2') || !validatePlayersStrict()){
      setSubmitting(false);
      return;
    }
  
    // 수정마감 확인
    try{
      const tourId = (document.getElementById('tourSelect').value || '').trim();
      const meta = await fetchTourMeta(tourId);
      const isEditing = Boolean((ownerEdit && ownerEdit.teamId) || (editTeamId && editCode));
      if (meta && meta.editDeadlineAt) {
        if (isPast(meta.now, meta.editDeadlineAt)) {
          alert('수정 마감이 지났습니다. 더 이상 신청서 변경이 불가합니다.');
          setSubmitting(false);
          return;
        } else {
          const msg = isEditing
            ? `수정 마감: ${fmtDT(meta.editDeadlineAt)}\n이후에는 변경이 불가합니다.\n수정을 진행할까요?`
            : `수정 마감: ${fmtDT(meta.editDeadlineAt)}\n제출 후 마감 시각 이후에는 변경이 제한됩니다.\n제출을 진행할까요?`;
          if (!confirm(msg)) { setSubmitting(false); return; }
        }
      } else {
        const msg = isEditing
          ? '현재 수정 마감이 설정되어 있지 않습니다.\n수정을 진행할까요?'
          : '현재 수정 마감이 설정되어 있지 않습니다.\n제출을 진행할까요?';
        if (!confirm(msg)) { setSubmitting(false); return; }
      }
    }catch{
      // 메타 조회 실패 시에는 계속 진행 (원래 로직 유지)
    }
  
    // payload 구성
    const province=document.getElementById('province').value.trim(), city=document.getElementById('city').value.trim();
    const team={
      tourId: document.getElementById('tourSelect').value.trim(),
      tourName: (currentTour&&currentTour.name)||'',
      region: province && city ? `${province} ${city}` : '',
      province, city,
      teamNameKo: document.getElementById('teamNameKo').value.trim(),
      teamNameEn: document.getElementById('teamNameEn').value.trim(),
      managerName: document.getElementById('managerName').value.trim(),
      managerPhone: (document.getElementById('managerPhone').value||'').replace(/\D+/g,''),
      category: document.getElementById('category').value,
      division: document.getElementById('division').value,
      uniformHome: document.getElementById('uniformHome').value.trim(),
      uniformAway: document.getElementById('uniformAway').value.trim()
    };
    const players=[...document.querySelectorAll('.player-card')].map(card=>{
      const get=k=> (card.querySelector(`[data-key="${k}"]`)?.value || '').trim();
      return { name:get('name'), number:get('number'), position:get('position'), birth:get('birth'), elite:get('elite') };
    });
  
    const payload={team, players, base: location.origin + location.pathname};
    let candidates = ['registerteam','registerTeam'];
    if (ownerEdit && ownerEdit.teamId){
      payload.teamId = ownerEdit.teamId; payload.name = ownerEdit.name; payload.phone = ownerEdit.phone;
      candidates = ['updateteambyowner','updateTeamByOwner'];
    } else if (editTeamId && editCode){
      payload.teamId = editTeamId; payload.editCode = editCode;
      candidates = ['updateteam','updateTeam'];
    }
  
    try{
      const json = await apiPost(candidates, payload);
      if(json.ok){
        const btn = document.getElementById('submitBtn');
        btn.textContent = (ownerEdit || (editTeamId&&editCode)) ? '수정 완료' : '제출 완료';
        btn.classList.add('done');
        // ✅ 성공 시에는 계속 잠금 유지(중복 제출 방지)
        show((ownerEdit || (editTeamId&&editCode)) ? '수정이 저장되었습니다.' : '신청이 완료되었습니다.');
        if (!(ownerEdit || (editTeamId&&editCode))){
          const editUrl = json.editUrl || `${location.origin}${location.pathname}?edit=${encodeURIComponent(json.teamId)}&code=${encodeURIComponent(json.editCode)}`;
          document.getElementById('editLinkInput').value=editUrl; document.getElementById('editLinkWrap').style.display='block'; document.getElementById('qr').style.display='block';
          const img = document.querySelector('#qr img');
          const makeQR = () => { img.src='https://chart.googleapis.com/chart?chs=160x160&cht=qr&chl='+encodeURIComponent(editUrl); };
          if('requestIdleCallback' in window){ requestIdleCallback(makeQR, {timeout: 1000}); } else { setTimeout(makeQR, 0); }
        }
        // ✅ 신규 제출이면 현재 디비전 카운트 즉시 +1 하고 UI 재렌더
        try{
          const isEditingNow = Boolean(ownerEdit || (editTeamId && editCode));
          if(!isEditingNow){
            const tourId = document.getElementById('tourSelect').value.trim();
            const dv = (document.getElementById('division').value || '').trim();
            if(tourId && dv){
              const k = normDv(dv);
              CUR_DIV_COUNT[k] = (Number(CUR_DIV_COUNT[k])||0) + 1;
              const last = k.split(' ').pop();
              if (CUR_DIV_COUNT[last]==null) CUR_DIV_COUNT[last] = CUR_DIV_COUNT[k];
              // 캐시도 업데이트
              divCountCache.set(tourId, { ts: Date.now(), data: { ...CUR_DIV_COUNT } });
              // 라벨/힌트 갱신
              if (categorySelect.value) categorySelect.dispatchEvent(new Event('change'));
              updateDivisionHint();
            }
          }
        }catch(_){}
        showFloatingPanelAfterSubmit();
      }else{
        alert('오류: '+(json.error||'unknown'));
        setSubmitting(false); // 실패 시 잠금 해제
      }
    }catch(err){
      alert('제출 실패: '+(err&&err.message||err));
      setSubmitting(false);   // 실패 시 잠금 해제
    }
  });

  /* ===== 부트 ===== */
  async function boot(forceReload){
    setConn('warn','연결 확인 중…');
    await loadTournaments();
    const initialId = $('#tourSelect').value || '';
    const initialTour = initialId ? TOUR_MAP[initialId] : null;
    renderTourInfo(initialTour);
    if (initialId){
      renderPosterStrict(initialId);    // 비대기
      loadAppliedCountsSmart(initialId, ++lastTourChangeToken); // 비대기
    }
    if (editTeamId && editCode){
      try{
        const j = await apiGet('getteam', { teamId: editTeamId, code: editCode });
        if(j && (j.team || j.ok)){
          await fillFormFromTeam_(j.team||{}, j.players||[]);
          show('수정 링크로 불러온 신청서입니다.');
        }else if(j && j.error){
          show('수정 링크 불러오기 실패: ' + j.error);
        }
      }catch(e){}
    }
  }
  (async function init(){ await boot(); })();
</script>
</body>
</html>
