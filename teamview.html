<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BDR TeamView</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --blue:#1769ff; --bg:#f6f8fb; --card:#fff; --muted:#6b7684; --chip-bg:#f1f5fb; --chip-bd:#e4ecf7 }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:'Pretendard','Apple SD Gothic Neo',sans-serif;color:#222}
  .wrap{max-width:980px;margin:20px auto;padding:0 14px 64px}
  header{display:flex;justify-content:space-between;align-items:center;margin:8px 0 14px;gap:10px;flex-wrap:wrap}
  h1{font-size:18px;margin:0}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{padding:8px 12px;border-radius:12px;border:1px solid #dfe6ee;background:#fff;cursor:pointer}
  .btn.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
  .btn.ghost{background:#fff;color:#334155;border-color:#e6ecf5}
  .card{background:var(--card);border-radius:14px;box-shadow:0 8px 28px rgba(23,105,255,.08);padding:14px;margin-top:14px}
  .muted{color:var(--muted);font-size:12px}
  .row{display:grid;gap:10px}
  @media(min-width:720px){ .row-2{grid-template-columns:1.2fr 1fr} }
  .kvs{display:grid;grid-template-columns:120px 1fr;gap:6px;font-size:14px}
  .kv-k{color:#6b7280;align-self:center}
  .kv-v{align-self:center}
  .kv-chip{display:inline-block;max-width:100%;padding:6px 10px;border-radius:999px;border:1px solid var(--chip-bd);background:var(--chip-bg);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .badge{display:inline-block;font-size:12px;padding:6px 12px;border-radius:999px;border:1px solid #e2e8f0;background:#f1f5fb;color:#334155}
  .jersey{display:inline-flex;align-items:center;gap:6px}

  /* table */
  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:separate;border-spacing:0 8px;table-layout:fixed}

  /* 최신 기준: 모든 열 폭 auto */
  col.no, col.name, col.pos, col.birth, col.age, col.elite, col.att, col.strt { width:auto }

  th{font-size:12px;color:#5b6472;text-align:left;padding:0 10px}
  td{background:#fff;padding:10px;border-top:1px solid #eef2f7;border-bottom:1px solid #eef2f7;vertical-align:middle}
  tr td:first-child{border-left:1px solid #eef2f7;border-radius:12px 0 0 12px}
  tr td:last-child{border-right:1px solid #eef2f7;border-radius:0 12px 12px 0}

  /* === FIX: TeamCard 칩(대회명/대표자) 넘침 방지 === */
  .row-2 > * { min-width: 0; }            /* 우측 컬럼이 그리드에서 줄여질 수 있게 */
  .kvs { grid-template-columns: 88px 1fr; }/* 라벨 칸을 살짝 줄이고 값 칸 확보 */
  .kvs .kv-v { min-width: 0; }             /* 값 셀 내부도 축소 허용 (ellipsis 작동) */
  .kv-chip { display:block; max-width:100%; overflow:hidden; text-overflow:ellipsis; }
  
  /* 헤더 액션 버튼(헤더 아래 배치: 데스크톱) */
  .th-actions{margin-top:4px;display:flex;gap:6px;justify-content:center}
  .btn-mini{font-size:11px;padding:3px 6px;border-radius:8px;border:1px solid #dfe6ee;background:#fff;cursor:pointer}
  .btn-mini:hover{border-color:#cbd5e1}

  th.col-att, td.col-att,
  th.col-start, td.col-start { text-align:center }
  .chk-attend, .chk-starter{ width:18px;height:18px;vertical-align:middle }

  .ellipsis{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .center{display:flex;justify-content:center;align-items:center}
  .skeleton{background:linear-gradient(90deg,#f2f4f7,#e9eef7,#f2f4f7) 0 0/200px 100% no-repeat;animation:sh 1.2s infinite}
  .skeleton-pill{height:24px;border-radius:999px;display:inline-block}
  @keyframes sh{0%{background-position:-200px 0}100%{background-position:200px 0}}

  /* 선발출전 동그라미(등번호) – 데스크톱 */
  td.backno{ position:relative; font-weight:700 }
  tr:has(.chk-starter:checked) td.backno::after{
    content:"◯";
    position:absolute; right:8px; top:50%; transform:translateY(-50%);
    font-size:16px; color:#0f172a;
  }

  /* ===== Print: A4 폭에 맞춰 확대/축소 ===== */
  @page { size: A4 portrait; margin: 6mm; }
  @media print{
    html, body { width: 210mm; }
    header,.toolbar,.th-actions,.mobile-actions{display:none !important}
    body{background:#fff}
    .wrap{max-width:none;width:100%;margin:0;padding:0}
    .card{box-shadow:none;border:1px solid #e5e7eb;border-radius:8px;margin:6mm 0 0 0;padding:10px}
    .table-wrap{overflow:visible}
    table{width:100%;border-spacing:0;table-layout:fixed}
    td,th{padding:8px}
    tr{break-inside:avoid}
    tbody tr{ display:table-row !important } /* 인쇄는 원래 테이블로 */
    thead{ display:table-header-group !important }
    table, tbody, td{ display:table !important }
    /* 출석 체크된 행만 인쇄 */
    tbody tr{ display:none !important }
    tbody tr.print-keep{ display:table-row !important }
  }

  /* =========================
     모바일 카드(두 줄 그리드) ≤640px
     ========================= */
  @media (max-width: 640px){
    body { font-size: clamp(14px, 3.8vw, 16px); }
    h1 { font-size: clamp(16px, 4.4vw, 18px); }

    /* 헤더 숨기고 카드 모드 사용 */
    thead { display:none; }
    table, tbody { display:block; width:100%; }
    tbody tr{
      display:grid;
      /* 1행: 등번호 | 이름 | 포지션 | 출석
         2행: 생년월일 | 만나이 | 선출 | 선발 */
      grid-template-columns: 0.9fr 1.5fr 1fr 0.9fr;
      grid-template-areas:
        "no name pos attend"
        "birth age elite starter";
      gap:10px 12px;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:14px;
      margin:10px 0;
      padding:10px;
      position:relative;
    }
    td{ border:none; border-radius:0; padding:6px 4px; display:block; }
    td::before{
      content: attr(data-label);
      display:block;
      font-size:12px;
      color:#6b7280;
      margin-bottom:4px;
      line-height:1.2;
    }

    /* 각 칸 위치 지정 */
    td.c-no{ grid-area:no; font-size:18px; font-weight:800; }
    td.c-name{ grid-area:name; font-weight:700; }
    td.c-pos{ grid-area:pos; }
    td.c-att{ grid-area:attend; text-align:center }
    td.c-birth{ grid-area:birth; }
    td.c-age{ grid-area:age; }
    td.c-elite{ grid-area:elite; }
    td.c-starter{ grid-area:starter; text-align:center }

    /* 체크박스 터치 영역 확대 */
    .chk-attend, .chk-starter{ width:22px; height:22px; }

    /* 데스크톱 동그라미 제거 → 카드 우상단에 통합 표기 */
    tr:has(.chk-starter:checked) td.backno::after{ content:none; }
    tbody tr:has(.chk-starter:checked)::after{
      content:"◯";
      position:absolute; right:10px; top:10px;
      font-size:16px; color:#0f172a;
    }

    /* 데스크톱용 헤더-하위 액션 숨김, 모바일 액션바 On */
    .th-actions{ display:none !important; }
    .mobile-actions{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .mobile-actions .btn-mini{ padding:7px 10px; font-size:12px; border-radius:10px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1 id="pageTitle">TeamView</h1>
    <div class="toolbar">
      <button class="btn" id="btnShare">공유</button>
      <button class="btn" id="btnCopy">링크 복사</button>
      <button class="btn" id="btnPrint">인쇄</button>
      <button class="btn" id="btnSaveJpg">사진 저장</button>
      <button class="btn" id="btnReload">새로고침</button>
    </div>
  </header>

  <div class="card" id="teamCard">
    <div class="row row-2">
      <div>
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <div id="teamTitle" style="font-size:18px;font-weight:700">팀 정보를 불러오는 중…</div>
          <span class="badge" id="leftBadge"></span>
        </div>
        <div class="muted" id="teamSub" style="margin-top:4px">Team ID: <span id="teamIdTxt"></span></div>
        <div id="jerseys" class="jersey" style="margin-top:8px"></div>
      </div>
      <div>
        <div class="kvs" id="teamKVs">
          <div class="kv-k" id="kv1Label">대회명</div>
          <div class="kv-v"><span id="kvRegion" class="kv-chip skeleton skeleton-pill" style="width:60%"></span></div>
          <div class="kv-k">종별·디비전</div>
          <div class="kv-v"><span id="kvCatDiv" class="kv-chip skeleton skeleton-pill" style="width:50%"></span></div>
          <div class="kv-k">대표자</div>
          <div class="kv-v"><span id="kvManager" class="kv-chip skeleton skeleton-pill" style="width:70%"></span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card" id="playersCard">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:8px;flex-wrap:wrap">
      <h3 style="margin:0;font-size:16px">선수 명단</h3>
      <div class="mobile-actions" aria-hidden="false">
        <button type="button" class="btn-mini" id="btnAttendToggle">전체체크/해제</button>
        <button type="button" class="btn-mini" id="btnAllStarterOff">선발 전체해제</button>
      </div>
      <div class="muted" id="countInfo" style="margin-left:auto"></div>
    </div>
    <div class="table-wrap">
      <table>
        <colgroup>
          <col class="no"><col class="name"><col class="pos"><col class="birth"><col class="age"><col class="elite"><col class="att"><col class="strt">
        </colgroup>
        <thead>
          <tr>
            <th>등번호</th>
            <th>선수이름</th>
            <th class="col-pos">포지션</th>
            <th class="col-birth">생년월일</th>
            <th class="col-age">만나이</th>
            <th class="col-elite">선출</th>
            <th class="col-att">
              출석
              <div class="th-actions">
                <button type="button" class="btn-mini" id="btnAttendToggle_desktop">전체체크/해제</button>
              </div>
            </th>
            <th class="col-start">
              선발출전
              <div class="th-actions">
                <button type="button" class="btn-mini" id="btnAllStarterOff_desktop">전체해제</button>
              </div>
            </th>
          </tr>
        </thead>
        <tbody id="playersTbody">
          <tr><td colspan="8" class="center"><div class="skeleton" style="width:60%;height:16px;border-radius:8px"></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card" id="errorCard" style="display:none">
    <div style="color:#b91c1c;font-weight:700">불러오기 실패</div>
    <div class="muted" id="errorMsg" style="margin-top:6px"></div>
  </div>
</div>

<script>
/* ============ 상수/설정 ============ */
const DEFAULT_WEB_APP_URL='https://script.google.com/macros/s/AKfycbz1qk5MbQvVU3d8Qs3EcPO792iBNlVQR71WhCpNbkqzCcdn5gM17Hqx9AUAIGUwwSKCww/exec';
const CONF_KEY='BDR_ADMIN_CONF_V2';
const CHECKS_NS='TV_CHECKS_V1::';
let gTeamId='';
const conf = (()=>{ try{ return JSON.parse(localStorage.getItem(CONF_KEY)||'{}'); }catch{return{}} })();
function validWebAppUrl(u){ return /^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec(\?.*)?$/i.test((u||'').trim()); }
function apiBase(){ return validWebAppUrl(conf.appUrl)? conf.appUrl : DEFAULT_WEB_APP_URL; }
function apiUrl(path, q={}){ const u=new URL(apiBase()); u.searchParams.set('path', path); Object.entries(q).forEach(([k,v])=>u.searchParams.set(k,v)); return u.toString(); }
async function getJSON(u){
  try{
    const r=await fetch(u,{cache:'no-store',mode:'cors',credentials:'omit',redirect:'follow'});
    const t=await r.text(); try{ return JSON.parse(t); }catch{ return {ok:false,error:'JSON 파싱 실패', raw:t.slice(0,280)}; }
  }catch(e){ return {ok:false,error:String(e && e.message || e)}; }
}
const A4_TARGET_WIDTH = 2480; // px
const JPG_QUALITY = 0.92;
const A4_TARGET_HEIGHT = 3508; // px
const A4_MARGIN_MM = 6;

/* ============ 유틸 ============ */
const $=s=>document.querySelector(s);
const pad=n=>String(n).padStart(2,'0');
function phonePretty(s){ return String(s||'').replace(/\D/g,'').replace(/^(\d{3})(\d{3,4})(\d{4})$/,'$1-$2-$3'); }
function jerseySVG(hex,label){ const color=(/^[#][0-9a-f]{6}$/i).test(hex||'')?hex:'#e5e7eb', text=(label||'').toUpperCase(); return `<svg width="42" height="52" viewBox="0 0 42 52" xmlns="http://www.w3.org/2000/svg"><g filter="url(#s)"><path d="M14 3 l4 6 h6 l4-6 h6 v15 l3 3 v27 a3 3 0 0 1 -3 3 h-26 a3 3 0 0 1 -3 -3 v-27 l3-3 v-15 z" fill="${color}" stroke="#cbd5e1"/><text x="21" y="31" font-family="system-ui,sans-serif" font-size="9" fill="#0f172a" text-anchor="middle" font-weight="700">${text}</text></g><defs><filter id="s" x="0" y="0" width="42" height="52"><feDropShadow dx="0" dy="1" stdDeviation="1" flood-color="#000" flood-opacity=".08"/></filter></defs></svg>`; }
function qs(k){ return new URLSearchParams(location.search).get(k)||''; }
function fmtBirth(s, mode='full'){
  if(!s) return '';
  const d = new Date(s);
  if(isNaN(d)) return String(s);

  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');

  if(mode === 'compact') {
    // 요청: yymmdd (하이픈 없이 6자리)
    return String(y).slice(2) + m + dd;
  }
  // 기본은 yyyy-mm-dd
  return `${y}-${m}-${dd}`;
}

/* 로컬 저장/복원 */
function loadChecks(teamId){ try{ return JSON.parse(localStorage.getItem(CHECKS_NS+teamId)||'{}'); }catch{return{}} }
function saveChecks(teamId, data){ try{ localStorage.setItem(CHECKS_NS+teamId, JSON.stringify(data||{})); }catch{} }
function rowKey(r){
  const no = r['등번호']||r.backNumber||'';
  const name = r['선수이름']||r.playerName||'';
  return `${String(no).trim()}::${String(name).trim()}`;
}

/* ============ 사진 저장: 기존 그대로 ============ */
async function saveViewAsJPG(){
  const team = document.getElementById('teamCard');
  const players = document.getElementById('playersCard');
  if(!team || !players) throw new Error('캡처할 영역을 찾을 수 없습니다.');

  // 인쇄와 동일하게 "출석 체크된 행만" 남기기
  applyPrintKeepRows();

  const wrap = document.querySelector('.wrap');
  const baseWidth = wrap?.offsetWidth || 980;

  const A4_MM = 210;
  const innerW = Math.round(A4_TARGET_WIDTH * (A4_MM - 2 * A4_MARGIN_MM) / A4_MM);
  const innerH = Math.round(A4_TARGET_HEIGHT * (A4_MM - 2 * A4_MARGIN_MM) / A4_MM);
  const marginPx = Math.round((A4_TARGET_WIDTH / A4_MM) * A4_MARGIN_MM);

  const bg = '#ffffff';
  const tempHost = document.createElement('div');
  tempHost.style.position = 'fixed';
  tempHost.style.left = '-10000px';
  tempHost.style.top = '0';
  tempHost.style.width = baseWidth + 'px';
  tempHost.style.boxSizing = 'border-box';
  tempHost.style.padding = '0';
  tempHost.style.background = bg;

  const teamClone = team.cloneNode(true);
  const playersClone = players.cloneNode(true);

  const oChecks = Array.from(players.querySelectorAll('input[type=checkbox]'));
  const cChecks = Array.from(playersClone.querySelectorAll('input[type=checkbox]'));
  cChecks.forEach((c,i)=>{ if(oChecks[i]) c.checked = !!oChecks[i].checked; });

  const photoStyle = document.createElement('style');
  photoStyle.textContent = `
    .photo-a4 header, .photo-a4 .toolbar, .photo-a4 .th-actions, .photo-a4 .mobile-actions { display:none !important; }
    .photo-a4 .wrap { max-width:none; width:100%; margin:0; padding:0; }
    .photo-a4 .card { box-shadow:none; border:1px solid #e5e7eb; border-radius:8px; margin:0 0 10px 0; padding:10px; }
    .photo-a4 .table-wrap{ overflow:visible }
    .photo-a4 table{ width:100%; border-spacing:0; table-layout:fixed }
    .photo-a4 td, .photo-a4 th { padding:8px }
    .photo-a4 tr{ break-inside:avoid }
    .photo-a4 tbody tr { display:table-row }
  `;

  const root = document.createElement('div');
  root.className = 'photo-a4';
  const innerWrap = document.createElement('div');
  innerWrap.className = 'wrap';
  innerWrap.appendChild(teamClone);
  innerWrap.appendChild(playersClone);
  root.appendChild(innerWrap);

  tempHost.appendChild(photoStyle);
  tempHost.appendChild(root);
  document.body.appendChild(tempHost);

  const contentH = tempHost.offsetHeight;
  const scaleByW = innerW / baseWidth;
  const scaleByH = innerH / contentH;
  const scale = Math.min(scaleByW, scaleByH);

  try{
    const canvas = await renderByForeignObjectA4(tempHost, scale, innerW, innerH, marginPx, bg);
    await downloadCanvasAsJPG(canvas);
  }catch(e){
    const canvas = await renderByHtml2CanvasA4(tempHost, scale, innerW, innerH, marginPx, bg);
    await downloadCanvasAsJPG(canvas);
  }finally{
    tempHost.remove();
  }
}

async function renderByHtml2CanvasA4(container, scale, innerW, innerH, marginPx, bg){
  if(typeof html2canvas !== 'function') throw new Error('html2canvas를 불러오지 못했습니다.');
  const rawCanvas = await html2canvas(container, {
    backgroundColor: '#ffffff',
    scale, useCORS: true, allowTaint: false, foreignObjectRendering: false, logging: false
  });

  const canvas = document.createElement('canvas');
  canvas.width  = A4_TARGET_WIDTH;
  canvas.height = A4_TARGET_HEIGHT;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  const fitScale = Math.min(innerW / rawCanvas.width, innerH / rawCanvas.height, 1);
  const drawW = Math.round(rawCanvas.width * fitScale);
  const drawH = Math.round(rawCanvas.height * fitScale);

  ctx.drawImage(rawCanvas, marginPx, marginPx, drawW, drawH);
  return canvas;
}

async function renderByForeignObjectA4(container, scale, innerW, innerH, marginPx, bg){
  const styleTexts = Array.from(document.querySelectorAll('style')).map(s => s.innerHTML).join('\n');

  const inner = `
    <div xmlns="http://www.w3.org/1999/xhtml"
         style="width:${container.offsetWidth}px; box-sizing:border-box; background:${bg};
                transform-origin:0 0; transform:scale(${scale});">
      <style>${styleTexts}</style>
      ${container.innerHTML}
    </div>
  `;

  const svg = `
    <svg xmlns="http://www.w3.org/2000/svg" width="${A4_TARGET_WIDTH}" height="${A4_TARGET_HEIGHT}">
      <rect width="100%" height="100%" fill="#ffffff"/>
      <g transform="translate(${marginPx},${marginPx})">
        <foreignObject width="${innerW}" height="${innerH}">
          ${inner}
        </foreignObject>
      </g>
    </svg>
  `;

  const blob = new Blob([svg], { type:'image/svg+xml;charset=utf-8' });
  const url  = URL.createObjectURL(blob);

  const img = new Image();
  img.crossOrigin = 'anonymous';
  await new Promise((res, rej)=>{ img.onload = res; img.onerror = ()=>rej(new Error('foreignObject 렌더 실패')); img.src = url; });

  const canvas = document.createElement('canvas');
  canvas.width  = A4_TARGET_WIDTH;
  canvas.height = A4_TARGET_HEIGHT;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img, 0, 0);
  URL.revokeObjectURL(url);
  return canvas;
}

function downloadCanvasAsJPG(canvas){
  return new Promise((resolve, reject)=>{
    const now = new Date();
    const filenameSafe = (document.getElementById('pageTitle')?.textContent || 'TeamView')
      .replace(/[\\/:*?"<>|]/g,'_');
    canvas.toBlob(blob=>{
      if(!blob) return reject(new Error('이미지 변환 실패'));
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `TeamView_${filenameSafe}_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}.jpg`;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); resolve(); }, 200);
    }, 'image/jpeg', JPG_QUALITY);
  });
}

/* ============ 렌더러 ============ */
function fillKV(id, text){
  const el = document.getElementById(id);
  if(!el) return;
  el.textContent = text || '-';
  el.classList.remove('skeleton','skeleton-pill');
}

function renderTeamCard(team){
  if(!team){
    $('#teamTitle').textContent='팀 정보를 찾을 수 없습니다.';
    $('#leftBadge').textContent='';
    $('#teamSub').textContent='';
    $('#teamKVs').innerHTML='';
    return;
  }
  const title = [team.teamNameKo||'', team.teamNameEn?`(${team.teamNameEn})`:'' ].join(' ').trim();
  $('#pageTitle').textContent = title || 'TeamView';
  $('#teamTitle').textContent = title || '무명 팀';
  $('#teamIdTxt').textContent = String(team.teamId||'');
  $('#jerseys').innerHTML = `<div class="jersey">${jerseySVG(team.uniformHome||'#e5e7eb','HOME')}${jerseySVG(team.uniformAway||'#e5e7eb','AWAY')}</div>`;

  const regionStr = [team.province||'', team.city||''].join(' ').trim() || (team.region||'');
  const tourName  = team.tourName || '';
  const catdiv    = [team.category||'', team.division||''].filter(Boolean).join(' · ');
  const mgr       = [team.managerName||'', phonePretty(team.managerPhone||'')].filter(Boolean).join(' · ');

  $('#leftBadge').textContent = regionStr || '';
  $('#kv1Label').textContent = '대회명';
  fillKV('kvRegion', tourName);
  fillKV('kvCatDiv', catdiv);
  fillKV('kvManager', mgr);
}

function renderPlayers(rows){
  const tb = $('#playersTbody');
  if(!Array.isArray(rows) || rows.length===0){
    tb.innerHTML = `<tr><td colspan="8" class="muted">등록된 선수 명단이 없습니다.</td></tr>`;
    $('#countInfo').textContent = '0명';
    return;
  }
  const normNo = v => {
    const s = String(v||'').trim();
    const m = s.match(/^\d+$/); return m ? parseInt(s,10) : Number.MAX_SAFE_INTEGER;
  };
  rows.sort((a,b)=> normNo(a['등번호']||a.backNumber) - normNo(b['등번호']||b.backNumber));

  const saved = loadChecks(gTeamId);

  tb.innerHTML = rows.map(r=>{
    const no   = r['등번호']||r.backNumber||'';
    const name = r['선수이름']||r.playerName||'';
    const pos  = (r['포지션']||r.position||'').toUpperCase();
    const birth= fmtBirth(r['생년월일']||r.birth||r.dob||'', 'compact');
    const age  = r['만나이']||r.age||'';
    const elite= r['선출여부']||r.elite||'';
    const key  = rowKey(r);
    const st = saved[key] || { a:false, s:false };
    return `<tr data-key="${key}">
      <td class="backno ellipsis c-no"    data-label="등번호">${no||'-'}</td>
      <td class="namecell ellipsis c-name" data-label="선수이름">${name||''}</td>
      <td class="col-pos ellipsis c-pos"   data-label="포지션">${pos||''}</td>
      <td class="col-att c-att"            data-label="출석"><input type="checkbox" class="chk-attend"${st.a?' checked':''} aria-label="출석"></td>
      <td class="col-birth ellipsis c-birth" data-label="생년월일">${birth||''}</td>
      <td class="col-age ellipsis c-age"     data-label="만나이">${age||''}</td>
      <td class="col-elite ellipsis c-elite" data-label="선출">${elite||''}</td>
      <td class="col-start c-starter"        data-label="선발출전"><input type="checkbox" class="chk-starter"${st.s?' checked':''} aria-label="선발출전"></td>
    </tr>`;
  }).join('');
  $('#countInfo').textContent = `${rows.length}명`;
}

/* ============ 로드 ============ */
async function boot(){
  gTeamId = qs('teamId') || qs('id');
  if(!gTeamId){
    document.getElementById('errorCard').style.display='';
    document.getElementById('errorMsg').textContent='teamId 파라미터가 필요합니다. 예) teamview.html?teamId=TMXXXXXXXX';
    return;
  }
  const teamRes = await getJSON(apiUrl('getteam', { teamId: gTeamId }));
  if(!(teamRes && (teamRes.ok===true || teamRes.team))){
    document.getElementById('errorCard').style.display='';
    document.getElementById('errorMsg').textContent = (teamRes && (teamRes.error||teamRes.raw)) || '팀 정보를 불러올 수 없습니다.';
  }
  renderTeamCard(teamRes && teamRes.team);

  const plyRes = await getJSON(apiUrl('players', { teamId: gTeamId }));
  if(!(plyRes && Array.isArray(plyRes.rows))){
    document.getElementById('playersTbody').innerHTML = `<tr><td colspan="8" class="muted">선수명단을 불러오지 못했습니다.</td></tr>`;
    document.getElementById('countInfo').textContent = '';
  }else{
    renderPlayers(plyRes.rows);
  }
}

/* ============ 일괄 체크 ============ */
function setCheckedAll(selector, value){
  const inputs = document.querySelectorAll(selector);
  inputs.forEach(inp=>{
    if(inp.checked !== value){
      inp.checked = value;
      inp.dispatchEvent(new Event('change', { bubbles:true }));
    }
  });
}

/* ============ 상단 버튼 ============ */
document.getElementById('btnReload').addEventListener('click', ()=>location.reload());
document.getElementById('btnPrint').addEventListener('click', ()=>window.print());
document.getElementById('btnCopy').addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(location.href); alert('현재 페이지 링크를 복사했습니다.'); }catch{ alert('복사 실패'); }
});
document.getElementById('btnShare').addEventListener('click', async ()=>{
  try{
    if(navigator.share){
      await navigator.share({ title: document.title, text:'팀 선수명단', url: location.href });
    }else{
      await navigator.clipboard.writeText(location.href);
      alert('공유 API 미지원 기기입니다. 링크를 복사했습니다.');
    }
  }catch(e){}
});
document.getElementById('btnSaveJpg').addEventListener('click', async ()=>{
  try{ await saveViewAsJPG(); }catch(e){ alert('이미지 저장 중 오류: ' + (e && e.message ? e.message : e)); }
});

/* ============ 액션 버튼 (데스크톱/모바일 공통 id 처리) ============ */
document.addEventListener('click', (e)=>{
  const id = (e.target && e.target.id) || '';
  if(id === 'btnAttendToggle' || id === 'btnAttendToggle_desktop'){
    const nodes = Array.from(document.querySelectorAll('.chk-attend'));
    const shouldCheck = nodes.some(n => !n.checked);
    setCheckedAll('.chk-attend', shouldCheck);
  }else if(id === 'btnAllStarterOff' || id === 'btnAllStarterOff_desktop'){
    setCheckedAll('.chk-starter', false);
  }
});

/* ============ 인쇄: 출석 체크된 행만 인쇄 ============ */
function applyPrintKeepRows(){
  const rows = document.querySelectorAll('#playersTbody tr');
  rows.forEach(tr=>{
    const att = tr.querySelector('.chk-attend');
    if(att && att.checked){ tr.classList.add('print-keep'); }
    else { tr.classList.remove('print-keep'); }
  });
}
window.addEventListener('beforeprint', applyPrintKeepRows);

/* ============ 체크 상태 저장 ============ */
document.addEventListener('change', (e)=>{
  const t = e.target;
  if(!(t instanceof HTMLInputElement)) return;
  if(!t.closest('#playersTbody')) return;

  if(t.classList.contains('chk-attend') || t.classList.contains('chk-starter')){
    const tr = t.closest('tr');
    const key = tr?.getAttribute('data-key')||'';
    if(!key) return;
    const all = loadChecks(gTeamId);
    const aEl = tr.querySelector('.chk-attend');
    const sEl = tr.querySelector('.chk-starter');

    // 선발 체크 시 출석 자동 체크
    if(t.classList.contains('chk-starter') && sEl?.checked && aEl && !aEl.checked){
      aEl.checked = true;
    }
    all[key] = { a: !!aEl?.checked, s: !!sEl?.checked };
    saveChecks(gTeamId, all);
  }
});

boot();
</script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</body>
</html>
