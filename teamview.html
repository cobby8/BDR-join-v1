<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BDR TeamView</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --blue:#1769ff; --bg:#f6f8fb; --card:#fff; --muted:#6b7684; --chip-bg:#f1f5fb; --chip-bd:#e4ecf7 }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:'Pretendard','Apple SD Gothic Neo',sans-serif;color:#222}
  .wrap{max-width:980px;margin:20px auto;padding:0 14px 64px}
  header{display:flex;justify-content:space-between;align-items:center;margin:8px 0 14px}
  h1{font-size:18px;margin:0}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{padding:8px 12px;border-radius:12px;border:1px solid #dfe6ee;background:#fff;cursor:pointer}
  .btn.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
  .btn.ghost{background:#fff;color:#334155;border-color:#e6ecf5}
  .card{background:var(--card);border-radius:14px;box-shadow:0 8px 28px rgba(23,105,255,.08);padding:14px;margin-top:14px}
  .muted{color:var(--muted);font-size:12px}
  .row{display:grid;gap:10px}
  @media(min-width:720px){ .row-2{grid-template-columns:1.2fr 1fr} }
  .kvs{display:grid;grid-template-columns:120px 1fr;gap:6px;font-size:14px}
  .kv-k{color:#6b7280;align-self:center}
  .kv-v{align-self:center}
  .kv-chip{display:inline-block;max-width:100%;padding:6px 10px;border-radius:999px;border:1px solid var(--chip-bd);background:var(--chip-bg);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .badge{display:inline-block;font-size:12px;padding:6px 12px;border-radius:999px;border:1px solid #e2e8f0;background:#f1f5fb;color:#334155}
  .jersey{display:inline-flex;align-items:center;gap:6px}

  /* table */
  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:separate;border-spacing:0 8px;table-layout:fixed}

  /* ğŸ”§ ìµœì‹  ê¸°ì¤€: ëª¨ë“  ì—´ í­ auto */
  col.no, col.name, col.pos, col.birth, col.age, col.elite, col.att, col.strt { width:auto }

  th{font-size:12px;color:#5b6472;text-align:left;padding:0 10px}
  td{background:#fff;padding:10px;border-top:1px solid #eef2f7;border-bottom:1px solid #eef2f7;vertical-align:middle}
  tr td:first-child{border-left:1px solid #eef2f7;border-radius:12px 0 0 12px}
  tr td:last-child{border-right:1px solid #eef2f7;border-radius:0 12px 12px 0}

  /* í—¤ë” ì•¡ì…˜ ë²„íŠ¼(í—¤ë” ì•„ë˜ ë°°ì¹˜) */
  .th-actions{margin-top:4px;display:flex;gap:6px;justify-content:center}
  .btn-mini{font-size:11px;padding:3px 6px;border-radius:8px;border:1px solid #dfe6ee;background:#fff;cursor:pointer}
  .btn-mini:hover{border-color:#cbd5e1}

  th.col-att, td.col-att,
  th.col-start, td.col-start { text-align:center }
  .chk-attend, .chk-starter{ width:18px;height:18px;vertical-align:middle }

  .ellipsis{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .center{display:flex;justify-content:center;align-items:center}
  .skeleton{background:linear-gradient(90deg,#f2f4f7,#e9eef7,#f2f4f7) 0 0/200px 100% no-repeat;animation:sh 1.2s infinite}
  .skeleton-pill{height:24px;border-radius:999px;display:inline-block}
  @keyframes sh{0%{background-position:-200px 0}100%{background-position:200px 0}}

  /* ëª¨ë°”ì¼ ìˆ¨ê¹€ */
  @media (max-width: 640px) {
    .col-pos, .col-elite, .col-age, .col-birth { display:none; }
  }

  /* ì„ ë°œì¶œì „ ë™ê·¸ë¼ë¯¸(ë“±ë²ˆí˜¸) */
  td.backno{ position:relative; font-weight:700 }
  tr:has(.chk-starter:checked) td.backno::after{
    content:"â—¯";
    position:absolute; right:8px; top:50%; transform:translateY(-50%);
    font-size:16px; color:#0f172a;
  }

  /* ===== Print: í™”ë©´ ë¹„ìœ¨ ê·¸ëŒ€ë¡œ, A4 í­ì— ë§ì¶° í™•ëŒ€/ì¶•ì†Œ ===== */
  @page { size: A4 portrait; margin: 6mm; }
  @media print{
    html, body { width: 210mm; }
    header,.toolbar,.th-actions{display:none !important}
    body{background:#fff}
    .wrap{max-width:none;width:100%;margin:0;padding:0}
    .card{box-shadow:none;border:1px solid #e5e7eb;border-radius:8px;margin:6mm 0 0 0;padding:10px}
    .table-wrap{overflow:visible}
    table{width:100%;border-spacing:0;table-layout:fixed}
    td,th{padding:8px}
    tr{break-inside:avoid}

    /* ì¶œì„ ì²´í¬ëœ í–‰ë§Œ ì¸ì‡„ (í˜¸í™˜ì„± ìœ„í•´ í´ë˜ìŠ¤ ë°©ì‹) */
    tbody tr{ display:none }
    tbody tr.print-keep{ display:table-row }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1 id="pageTitle">TeamView</h1>
    <div class="toolbar">
      <button class="btn" id="btnShare">ê³µìœ </button>
      <button class="btn" id="btnCopy">ë§í¬ ë³µì‚¬</button>
      <button class="btn" id="btnPrint">ì¸ì‡„</button>
      <button class="btn" id="btnSaveJpg">ì‚¬ì§„ ì €ì¥</button>
      <button class="btn" id="btnReload">ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </header>

  <div class="card" id="teamCard">
    <div class="row row-2">
      <div>
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <div id="teamTitle" style="font-size:18px;font-weight:700">íŒ€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
          <!-- ì™¼ìª½ ë°°ì§€ = ì§€ì—­ -->
          <span class="badge" id="leftBadge"></span>
        </div>
        <div class="muted" id="teamSub" style="margin-top:4px">Team ID: <span id="teamIdTxt"></span></div>
        <div id="jerseys" class="jersey" style="margin-top:8px"></div>
      </div>
      <div>
        <div class="kvs" id="teamKVs">
          <div class="kv-k" id="kv1Label">ëŒ€íšŒëª…</div>
          <div class="kv-v"><span id="kvRegion" class="kv-chip skeleton skeleton-pill" style="width:60%"></span></div>
          <div class="kv-k">ì¢…ë³„Â·ë””ë¹„ì „</div>
          <div class="kv-v"><span id="kvCatDiv" class="kv-chip skeleton skeleton-pill" style="width:50%"></span></div>
          <div class="kv-k">ëŒ€í‘œì</div>
          <div class="kv-v"><span id="kvManager" class="kv-chip skeleton skeleton-pill" style="width:70%"></span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card" id="playersCard">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 style="margin:0;font-size:16px">ì„ ìˆ˜ ëª…ë‹¨</h3>
      <div class="muted" id="countInfo"></div>
    </div>
    <div class="table-wrap">
      <table>
        <!-- ì—´ ìˆœì„œ: ë²ˆí˜¸, ì´ë¦„, í¬ì§€ì…˜, ìƒë…„ì›”ì¼, ë§Œë‚˜ì´, ì„ ì¶œ, ì¶œì„, ì„ ë°œì¶œì „ -->
        <colgroup>
          <col class="no"><col class="name"><col class="pos"><col class="birth"><col class="age"><col class="elite"><col class="att"><col class="strt">
        </colgroup>
        <thead>
          <tr>
            <th>ë“±ë²ˆí˜¸</th>
            <th>ì„ ìˆ˜ì´ë¦„</th>
            <th class="col-pos">í¬ì§€ì…˜</th>
            <th class="col-birth">ìƒë…„ì›”ì¼</th>
            <th class="col-age">ë§Œë‚˜ì´</th>
            <th class="col-elite">ì„ ì¶œ</th>
            <th class="col-att">
              ì¶œì„
            <div class="th-actions">
              <button type="button" class="btn-mini" id="btnAttendToggle">ì „ì²´ì²´í¬/í•´ì œ</button>
            </div>
            </th>
            <th class="col-start">
              ì„ ë°œì¶œì „
              <div class="th-actions">
                <button type="button" class="btn-mini" id="btnAllStarterOff">ì „ì²´í•´ì œ</button>
              </div>
            </th>
          </tr>
        </thead>
        <tbody id="playersTbody">
          <tr><td colspan="8" class="center"><div class="skeleton" style="width:60%;height:16px;border-radius:8px"></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card" id="errorCard" style="display:none">
    <div style="color:#b91c1c;font-weight:700">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>
    <div class="muted" id="errorMsg" style="margin-top:6px"></div>
  </div>
</div>

<script>
/* ============ ìƒìˆ˜/ì„¤ì • ============ */
const DEFAULT_WEB_APP_URL='https://script.google.com/macros/s/AKfycbz1qk5MbQvVU3d8Qs3EcPO792iBNlVQR71WhCpNbkqzCcdn5gM17Hqx9AUAIGUwwSKCww/exec';
const CONF_KEY='BDR_ADMIN_CONF_V2';
const CHECKS_NS='TV_CHECKS_V1::';
let gTeamId='';
const conf = (()=>{ try{ return JSON.parse(localStorage.getItem(CONF_KEY)||'{}'); }catch{return{}} })();
function validWebAppUrl(u){ return /^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec(\?.*)?$/i.test((u||'').trim()); }
function apiBase(){ return validWebAppUrl(conf.appUrl)? conf.appUrl : DEFAULT_WEB_APP_URL; }
function apiUrl(path, q={}){ const u=new URL(apiBase()); u.searchParams.set('path', path); Object.entries(q).forEach(([k,v])=>u.searchParams.set(k,v)); return u.toString(); }
async function getJSON(u){
  try{
    const r=await fetch(u,{cache:'no-store',mode:'cors',credentials:'omit',redirect:'follow'});
    const t=await r.text(); try{ return JSON.parse(t); }catch{ return {ok:false,error:'JSON íŒŒì‹± ì‹¤íŒ¨', raw:t.slice(0,280)}; }
  }catch(e){ return {ok:false,error:String(e && e.message || e)}; }
}
const A4_TARGET_WIDTH = 2480; // px (A4 ê°€ë¡œí­ ê¸°ì¤€ ì•½ 300DPI í’ˆì§ˆ)
const JPG_QUALITY = 0.92;     // JPEG í’ˆì§ˆ
const A4_TARGET_HEIGHT = 3508; // px (A4 ì„¸ë¡œ @300DPI)
const A4_MARGIN_MM = 6;        // ì¸ì‡„ì™€ ë™ì¼í•œ ì—¬ë°±

/* ============ ìœ í‹¸ ============ */
const $=s=>document.querySelector(s);
const pad=n=>String(n).padStart(2,'0');
function phonePretty(s){ return String(s||'').replace(/\D/g,'').replace(/^(\d{3})(\d{3,4})(\d{4})$/,'$1-$2-$3'); }
function jerseySVG(hex,label){ const color=(/^[#][0-9a-f]{6}$/i).test(hex||'')?hex:'#e5e7eb', text=(label||'').toUpperCase(); return `<svg width="42" height="52" viewBox="0 0 42 52" xmlns="http://www.w3.org/2000/svg"><g filter="url(#s)"><path d="M14 3 l4 6 h6 l4-6 h6 v15 l3 3 v27 a3 3 0 0 1 -3 3 h-26 a3 3 0 0 1 -3 -3 v-27 l3-3 v-15 z" fill="${color}" stroke="#cbd5e1"/><text x="21" y="31" font-family="system-ui,sans-serif" font-size="9" fill="#0f172a" text-anchor="middle" font-weight="700">${text}</text></g><defs><filter id="s" x="0" y="0" width="42" height="52"><feDropShadow dx="0" dy="1" stdDeviation="1" flood-color="#000" flood-opacity=".08"/></filter></defs></svg>`; }
function qs(k){ return new URLSearchParams(location.search).get(k)||''; }
function fmtBirth(s){ if(!s) return ''; const d=new Date(s); if(!isNaN(d)) return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; return String(s); }

/* ë¡œì»¬ ì €ì¥/ë³µì› */
function loadChecks(teamId){ try{ return JSON.parse(localStorage.getItem(CHECKS_NS+teamId)||'{}'); }catch{return{}} }
function saveChecks(teamId, data){ try{ localStorage.setItem(CHECKS_NS+teamId, JSON.stringify(data||{})); }catch{} }
function rowKey(r){
  const no = r['ë“±ë²ˆí˜¸']||r.backNumber||'';
  const name = r['ì„ ìˆ˜ì´ë¦„']||r.playerName||'';
  return `${String(no).trim()}::${String(name).trim()}`;
}

async function saveViewAsJPG(){
  const team = document.getElementById('teamCard');
  const players = document.getElementById('playersCard');
  if(!team || !players) throw new Error('ìº¡ì²˜í•  ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

  // ì¸ì‡„ì™€ ë™ì¼í•˜ê²Œ "ì¶œì„ ì²´í¬ëœ í–‰ë§Œ" ë‚¨ê¸°ê¸°
  applyPrintKeepRows();

  const wrap = document.querySelector('.wrap');
  const baseWidth = wrap?.offsetWidth || 980;

  // A4 ë‚´ë¶€(ì—¬ë°± ì œì™¸) í­/ë†’ì´(px)
  const A4_MM = 210;
  const innerW = Math.round(A4_TARGET_WIDTH * (A4_MM - 2 * A4_MARGIN_MM) / A4_MM);
  const innerH = Math.round(A4_TARGET_HEIGHT * (A4_MM - 2 * A4_MARGIN_MM) / A4_MM);
  const marginPx = Math.round((A4_TARGET_WIDTH / A4_MM) * A4_MARGIN_MM);

  // ì˜¤í”„ìŠ¤í¬ë¦° ì»¨í…Œì´ë„ˆ ìƒì„±
  const bg = '#ffffff'; // ì¸ì‡„ì™€ ë™ì¼í•œ í° ë°°ê²½
  const tempHost = document.createElement('div');
  tempHost.style.position = 'fixed';
  tempHost.style.left = '-10000px';
  tempHost.style.top = '0';
  tempHost.style.width = baseWidth + 'px';
  tempHost.style.boxSizing = 'border-box';
  tempHost.style.padding = '0';        // ì—¬ë°±ì€ ìº”ë²„ìŠ¤ì—ì„œ ì²˜ë¦¬
  tempHost.style.background = bg;

  // í—¤ë” ì œì™¸, ì¹´ë“œ 2ê°œ ë³µì œ
  const teamClone = team.cloneNode(true);
  const playersClone = players.cloneNode(true);

  // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë™ê¸°í™”
  const oChecks = Array.from(players.querySelectorAll('input[type=checkbox]'));
  const cChecks = Array.from(playersClone.querySelectorAll('input[type=checkbox]'));
  cChecks.forEach((c,i)=>{ if(oChecks[i]) c.checked = !!oChecks[i].checked; });

  // ì¸ì‡„ ë ˆì´ì•„ì›ƒê³¼ ë™ì¼í•˜ê²Œ ë³´ì´ë„ë¡ ë³´ì • ìŠ¤íƒ€ì¼ ì£¼ì…(= @media print ë‚´ìš© ë³µì œ)
  const photoStyle = document.createElement('style');
  photoStyle.textContent = `
    /* ì¸ì‡„ ë ˆì´ì•„ì›ƒ ë³µì œ */
    .photo-a4 header, .photo-a4 .toolbar, .photo-a4 .th-actions { display:none !important; }
    .photo-a4 .wrap { max-width:none; width:100%; margin:0; padding:0; }
    .photo-a4 .card { box-shadow:none; border:1px solid #e5e7eb; border-radius:8px; margin:0 0 10px 0; padding:10px; }
    .photo-a4 .table-wrap{ overflow:visible }
    .photo-a4 table{ width:100%; border-spacing:0; table-layout:fixed }
    .photo-a4 td, .photo-a4 th { padding:8px }
    .photo-a4 tr{ break-inside:avoid }
    .photo-a4 tbody tr { display:none }
    .photo-a4 tbody tr.print-keep { display:table-row }
  `;

  // ìº¡ì²˜ìš© ë£¨íŠ¸ êµ¬ì„± (.photo-a4 í´ë˜ìŠ¤ ë¶€ì—¬)
  const root = document.createElement('div');
  root.className = 'photo-a4';
  const innerWrap = document.createElement('div');
  innerWrap.className = 'wrap';
  innerWrap.appendChild(teamClone);
  innerWrap.appendChild(playersClone);
  root.appendChild(innerWrap);

  tempHost.appendChild(photoStyle);
  tempHost.appendChild(root);
  document.body.appendChild(tempHost);

  // ì½˜í…ì¸  ì‹¤ì œ ë†’ì´ ì¸¡ì • â†’ A4 ë‚´ë¶€ ë†’ì´ì— ë§ì¶° ìŠ¤ì¼€ì¼ ê²°ì •(ë„˜ì¹˜ë©´ ìë™ ì¶•ì†Œ)
  const contentH = tempHost.offsetHeight;
  const scaleByW = innerW / baseWidth;
  const scaleByH = innerH / contentH;
  const scale = Math.min(scaleByW, scaleByH);

  // 1) foreignObject ì‹œë„ â†’ 2) ì‹¤íŒ¨ ì‹œ html2canvas í´ë°±
  try{
    const canvas = await renderByForeignObjectA4(tempHost, scale, innerW, innerH, marginPx, bg);
    await downloadCanvasAsJPG(canvas);
  }catch(e){
    const canvas = await renderByHtml2CanvasA4(tempHost, scale, innerW, innerH, marginPx, bg);
    await downloadCanvasAsJPG(canvas);
  }finally{
    tempHost.remove();
  }
}

async function renderByHtml2CanvasA4(container, scale, innerW, innerH, marginPx, bg){
  if(typeof html2canvas !== 'function') throw new Error('html2canvasë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
  const rawCanvas = await html2canvas(container, {
    backgroundColor: '#ffffff',
    scale, useCORS: true, allowTaint: false, foreignObjectRendering: false, logging: false
  });

  // A4 ìº”ë²„ìŠ¤ì— ì—¬ë°± í¬í•¨ ë°°ì¹˜
  const canvas = document.createElement('canvas');
  canvas.width  = A4_TARGET_WIDTH;
  canvas.height = A4_TARGET_HEIGHT;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // rawCanvasëŠ” scale ë°˜ì˜ëœ ê²°ê³¼ë¬¼ì´ë¯€ë¡œ, ë‚´ë¶€ ì˜ì—­ ì¤‘ì•™ ìƒë‹¨(ì—¬ë°± ìœ„ì¹˜)ì— ë§ì¶° ê·¸ë¦¬ê¸°
  // ë†’ì´ê°€ ë‚´ë¶€ ë†’ì´ë¥¼ ë„˜ìœ¼ë©´ ë¹„ìœ¨ë¡œ í•œë²ˆ ë” ì¶•ì†Œ
  const fitScale = Math.min(innerW / rawCanvas.width, innerH / rawCanvas.height, 1);
  const drawW = Math.round(rawCanvas.width * fitScale);
  const drawH = Math.round(rawCanvas.height * fitScale);

  ctx.drawImage(rawCanvas, marginPx, marginPx, drawW, drawH);
  return canvas;
}

async function renderByForeignObjectA4(container, scale, innerW, innerH, marginPx, bg){
  const styleTexts = Array.from(document.querySelectorAll('style')).map(s => s.innerHTML).join('\n');

  const inner = `
    <div xmlns="http://www.w3.org/1999/xhtml"
         style="width:${container.offsetWidth}px; box-sizing:border-box; background:${bg};
                transform-origin:0 0; transform:scale(${scale});">
      <style>${styleTexts}</style>
      ${container.innerHTML}
    </div>
  `;

  const svg = `
    <svg xmlns="http://www.w3.org/2000/svg" width="${A4_TARGET_WIDTH}" height="${A4_TARGET_HEIGHT}">
      <rect width="100%" height="100%" fill="#ffffff"/>
      <g transform="translate(${marginPx},${marginPx})">
        <foreignObject width="${innerW}" height="${innerH}">
          ${inner}
        </foreignObject>
      </g>
    </svg>
  `;

  const blob = new Blob([svg], { type:'image/svg+xml;charset=utf-8' });
  const url  = URL.createObjectURL(blob);

  const img = new Image();
  img.crossOrigin = 'anonymous';
  await new Promise((res, rej)=>{ img.onload = res; img.onerror = ()=>rej(new Error('foreignObject ë Œë” ì‹¤íŒ¨')); img.src = url; });

  const canvas = document.createElement('canvas');
  canvas.width  = A4_TARGET_WIDTH;
  canvas.height = A4_TARGET_HEIGHT;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img, 0, 0);
  URL.revokeObjectURL(url);
  return canvas;
}

function downloadCanvasAsJPG(canvas){
  return new Promise((resolve, reject)=>{
    const now = new Date();
    const filenameSafe = (document.getElementById('pageTitle')?.textContent || 'TeamView')
      .replace(/[\\/:*?"<>|]/g,'_');
    canvas.toBlob(blob=>{
      if(!blob) return reject(new Error('ì´ë¯¸ì§€ ë³€í™˜ ì‹¤íŒ¨'));
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `TeamView_${filenameSafe}_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}.jpg`;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); resolve(); }, 200);
    }, 'image/jpeg', JPG_QUALITY);
  });
}

/* ============ ë Œë”ëŸ¬ ============ */
function fillKV(id, text){
  const el = document.getElementById(id);
  if(!el) return;
  el.textContent = text || '-';
  el.classList.remove('skeleton','skeleton-pill');
}

function renderTeamCard(team){
  if(!team){
    $('#teamTitle').textContent='íŒ€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    $('#leftBadge').textContent='';
    $('#teamSub').textContent='';
    $('#teamKVs').innerHTML='';
    return;
  }
  const title = [team.teamNameKo||'', team.teamNameEn?`(${team.teamNameEn})`:'' ].join(' ').trim();
  $('#pageTitle').textContent = title || 'TeamView';
  $('#teamTitle').textContent = title || 'ë¬´ëª… íŒ€';
  $('#teamIdTxt').textContent = String(team.teamId||'');
  $('#jerseys').innerHTML = `<div class="jersey">${jerseySVG(team.uniformHome||'#e5e7eb','HOME')}${jerseySVG(team.uniformAway||'#e5e7eb','AWAY')}</div>`;

  const regionStr = [team.province||'', team.city||''].join(' ').trim() || (team.region||'');
  const tourName  = team.tourName || '';
  const catdiv    = [team.category||'', team.division||''].filter(Boolean).join(' Â· ');
  const mgr       = [team.managerName||'', phonePretty(team.managerPhone||'')].filter(Boolean).join(' Â· ');

  // ì™¼ìª½ ë°°ì§€ = ì§€ì—­, ìš°ì¸¡ ì²« ì¤„ = ëŒ€íšŒëª…
  $('#leftBadge').textContent = regionStr || '';
  $('#kv1Label').textContent = 'ëŒ€íšŒëª…';
  fillKV('kvRegion', tourName);
  fillKV('kvCatDiv', catdiv);
  fillKV('kvManager', mgr);
}

function renderPlayers(rows){
  const tb = $('#playersTbody');
  if(!Array.isArray(rows) || rows.length===0){
    tb.innerHTML = `<tr><td colspan="8" class="muted">ë“±ë¡ëœ ì„ ìˆ˜ ëª…ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
    $('#countInfo').textContent = '0ëª…';
    return;
  }
  const normNo = v => {
    const s = String(v||'').trim();
    const m = s.match(/^\d+$/); return m ? parseInt(s,10) : Number.MAX_SAFE_INTEGER;
  };
  rows.sort((a,b)=> normNo(a['ë“±ë²ˆí˜¸']||a.backNumber) - normNo(b['ë“±ë²ˆí˜¸']||b.backNumber));

  const saved = loadChecks(gTeamId);

  tb.innerHTML = rows.map(r=>{
    const no   = r['ë“±ë²ˆí˜¸']||r.backNumber||'';
    const name = r['ì„ ìˆ˜ì´ë¦„']||r.playerName||'';
    const pos  = (r['í¬ì§€ì…˜']||r.position||'').toUpperCase();
    const birth= fmtBirth(r['ìƒë…„ì›”ì¼']||r.birth||r.dob||'');
    const age  = r['ë§Œë‚˜ì´']||r.age||'';
    const elite= r['ì„ ì¶œì—¬ë¶€']||r.elite||'';
    const key  = rowKey(r);
    const st = saved[key] || { a:false, s:false };
    return `<tr data-key="${key}">
      <td class="backno ellipsis">${no||'-'}</td>
      <td class="ellipsis">${name||''}</td>
      <td class="col-pos ellipsis">${pos||''}</td>
      <td class="col-birth ellipsis">${birth||''}</td>
      <td class="col-age ellipsis">${age||''}</td>
      <td class="col-elite ellipsis">${elite||''}</td>
      <td class="col-att"><input type="checkbox" class="chk-attend"${st.a?' checked':''} aria-label="ì¶œì„"></td>
      <td class="col-start"><input type="checkbox" class="chk-starter"${st.s?' checked':''} aria-label="ì„ ë°œì¶œì „"></td>
    </tr>`;
  }).join('');
  $('#countInfo').textContent = `${rows.length}ëª…`;
}

/* ============ ë¡œë“œ ============ */
async function boot(){
  gTeamId = qs('teamId') || qs('id');
  if(!gTeamId){
    document.getElementById('errorCard').style.display='';
    document.getElementById('errorMsg').textContent='teamId íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì˜ˆ) teamview.html?teamId=TMXXXXXXXX';
    return;
  }
  const teamRes = await getJSON(apiUrl('getteam', { teamId: gTeamId }));
  if(!(teamRes && (teamRes.ok===true || teamRes.team))){
    document.getElementById('errorCard').style.display='';
    document.getElementById('errorMsg').textContent = (teamRes && (teamRes.error||teamRes.raw)) || 'íŒ€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
  }
  renderTeamCard(teamRes && teamRes.team);

  const plyRes = await getJSON(apiUrl('players', { teamId: gTeamId }));
  if(!(plyRes && Array.isArray(plyRes.rows))){
    document.getElementById('playersTbody').innerHTML = `<tr><td colspan="8" class="muted">ì„ ìˆ˜ëª…ë‹¨ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</td></tr>`;
    document.getElementById('countInfo').textContent = '';
  }else{
    renderPlayers(plyRes.rows);
  }
}

/* ============ ìœ í‹¸: ì²´í¬ ì¼ê´„ ì ìš© ============ */
function setCheckedAll(selector, value){
  const inputs = document.querySelectorAll(selector);
  inputs.forEach(inp=>{
    if(inp.checked !== value){
      inp.checked = value;
      // ë³€ê²½ ì´ë²¤íŠ¸ ë°œìƒì‹œì¼œ ì €ì¥ ë¡œì§ ì‹¤í–‰
      inp.dispatchEvent(new Event('change', { bubbles:true }));
    }
  });
}

/* ============ ìƒë‹¨ ë²„íŠ¼ ============ */
document.getElementById('btnReload').addEventListener('click', ()=>location.reload());
document.getElementById('btnPrint').addEventListener('click', ()=>window.print());
document.getElementById('btnCopy').addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(location.href); alert('í˜„ì¬ í˜ì´ì§€ ë§í¬ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.'); }catch{ alert('ë³µì‚¬ ì‹¤íŒ¨'); }
});
document.getElementById('btnShare').addEventListener('click', async ()=>{
  try{
    if(navigator.share){
      await navigator.share({ title: document.title, text:'íŒ€ ì„ ìˆ˜ëª…ë‹¨', url: location.href });
    }else{
      await navigator.clipboard.writeText(location.href);
      alert('ê³µìœ  API ë¯¸ì§€ì› ê¸°ê¸°ì…ë‹ˆë‹¤. ë§í¬ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.');
    }
  }catch(e){}
});
document.getElementById('btnSaveJpg').addEventListener('click', async ()=>{
  try{
    await saveViewAsJPG();
  }catch(e){
    alert('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + (e && e.message ? e.message : e));
  }
});

/* ============ í—¤ë” ì•¡ì…˜ ë²„íŠ¼ ë™ì‘ ============ */
document.addEventListener('click', (e)=>{
  const id = (e.target && e.target.id) || '';
  if(id === 'btnAttendToggle'){
    const nodes = Array.from(document.querySelectorAll('.chk-attend'));
    const shouldCheck = nodes.some(n => !n.checked); // í•˜ë‚˜ë¼ë„ ë¯¸ì²´í¬ë©´ ì „ì²´ ì²´í¬
    setCheckedAll('.chk-attend', shouldCheck);
  }else if(id === 'btnAllStarterOff'){
    setCheckedAll('.chk-starter', false);
  }
});

/* ============ ì¸ì‡„: ì¶œì„ ì²´í¬ëœ í–‰ë§Œ ì‚´ë¦¬ê¸°(í™”ë©´ ë¹„ìœ¨ ìœ ì§€) ============ */
function applyPrintKeepRows(){
  const rows = document.querySelectorAll('#playersTbody tr');
  rows.forEach(tr=>{
    const att = tr.querySelector('.chk-attend');
    if(att && att.checked){ tr.classList.add('print-keep'); }
    else { tr.classList.remove('print-keep'); }
  });
}
window.addEventListener('beforeprint', applyPrintKeepRows);

/* ============ ì²´í¬ ìƒíƒœ ì €ì¥ ============ */
document.addEventListener('change', (e)=>{
  const t = e.target;
  if(!(t instanceof HTMLInputElement)) return;
  if(!t.closest('#playersTbody')) return;

  if(t.classList.contains('chk-attend') || t.classList.contains('chk-starter')){
    const tr = t.closest('tr');
    const key = tr?.getAttribute('data-key')||'';
    if(!key) return;
    const all = loadChecks(gTeamId);
    const aEl = tr.querySelector('.chk-attend');
    const sEl = tr.querySelector('.chk-starter');

    // ì„ ë°œ ì²´í¬ ì‹œ ì¶œì„ ìë™ ì²´í¬
    if(t.classList.contains('chk-starter') && sEl?.checked && aEl && !aEl.checked){
      aEl.checked = true;
    }
    all[key] = { a: !!aEl?.checked, s: !!sEl?.checked };
    saveChecks(gTeamId, all);
  }
});

boot();
</script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</body>
</html>
