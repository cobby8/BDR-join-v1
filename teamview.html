<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BDR TeamView</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --blue:#1769ff; --bg:#f6f8fb; --card:#fff; --muted:#6b7684; --chip-bg:#f1f5fb; --chip-bd:#e4ecf7 }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:'Pretendard','Apple SD Gothic Neo',sans-serif;color:#222}
  .wrap{max-width:980px;margin:20px auto;padding:0 14px 64px}
  header{display:flex;justify-content:space-between;align-items:center;margin:8px 0 14px}
  h1{font-size:18px;margin:0}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{padding:8px 12px;border-radius:12px;border:1px solid #dfe6ee;background:#fff;cursor:pointer}
  .btn.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
  .btn.ghost{background:#fff;color:#334155;border-color:#e6ecf5}
  .card{background:var(--card);border-radius:14px;box-shadow:0 8px 28px rgba(23,105,255,.08);padding:14px;margin-top:14px}
  .muted{color:var(--muted);font-size:12px}
  .row{display:grid;gap:10px}
  @media(min-width:720px){ .row-2{grid-template-columns:1.2fr 1fr} }
  .kvs{display:grid;grid-template-columns:120px 1fr;gap:6px;font-size:14px}
  .kv-k{color:#6b7280;align-self:center}
  .kv-v{align-self:center}
  .kv-chip{display:inline-block;max-width:100%;padding:6px 10px;border-radius:999px;border:1px solid var(--chip-bd);background:var(--chip-bg);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .badge{display:inline-block;font-size:12px;padding:6px 12px;border-radius:999px;border:1px solid #e2e8f0;background:#f1f5fb;color:#334155}
  .jersey{display:inline-flex;align-items:center;gap:6px}

  /* table */
  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:separate;border-spacing:0 8px;table-layout:fixed}

  /* 🔧 최신 기준: 모든 열 폭 auto */
  col.no, col.name, col.pos, col.birth, col.age, col.elite, col.att, col.strt { width:auto }

  th{font-size:12px;color:#5b6472;text-align:left;padding:0 10px}
  td{background:#fff;padding:10px;border-top:1px solid #eef2f7;border-bottom:1px solid #eef2f7;vertical-align:middle}
  tr td:first-child{border-left:1px solid #eef2f7;border-radius:12px 0 0 12px}
  tr td:last-child{border-right:1px solid #eef2f7;border-radius:0 12px 12px 0}

  /* 헤더 액션 버튼(헤더 아래 배치) */
  .th-actions{margin-top:4px;display:flex;gap:6px;justify-content:center}
  .btn-mini{font-size:11px;padding:3px 6px;border-radius:8px;border:1px solid #dfe6ee;background:#fff;cursor:pointer}
  .btn-mini:hover{border-color:#cbd5e1}

  th.col-att, td.col-att,
  th.col-start, td.col-start { text-align:center }
  .chk-attend, .chk-starter{ width:18px;height:18px;vertical-align:middle }

  .ellipsis{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .center{display:flex;justify-content:center;align-items:center}
  .skeleton{background:linear-gradient(90deg,#f2f4f7,#e9eef7,#f2f4f7) 0 0/200px 100% no-repeat;animation:sh 1.2s infinite}
  .skeleton-pill{height:24px;border-radius:999px;display:inline-block}
  @keyframes sh{0%{background-position:-200px 0}100%{background-position:200px 0}}

  /* 모바일 숨김 */
  @media (max-width: 640px) {
    .col-pos, .col-elite, .col-age, .col-birth { display:none; }
  }

  /* 선발출전 동그라미(등번호) */
  td.backno{ position:relative; font-weight:700 }
  tr:has(.chk-starter:checked) td.backno::after{
    content:"◯";
    position:absolute; right:8px; top:50%; transform:translateY(-50%);
    font-size:16px; color:#0f172a;
  }

  /* ===== Print: 화면 비율 그대로, A4 폭에 맞춰 확대/축소 ===== */
  @page { size: A4 portrait; margin: 6mm; }
  @media print{
    html, body { width: 210mm; }
    header,.toolbar,.th-actions{display:none !important}
    body{background:#fff}
    .wrap{max-width:none;width:100%;margin:0;padding:0}
    .card{box-shadow:none;border:1px solid #e5e7eb;border-radius:8px;margin:6mm 0 0 0;padding:10px}
    .table-wrap{overflow:visible}
    table{width:100%;border-spacing:0;table-layout:fixed}
    td,th{padding:8px}
    tr{break-inside:avoid}

    /* 출석 체크된 행만 인쇄 (호환성 위해 클래스 방식) */
    tbody tr{ display:none }
    tbody tr.print-keep{ display:table-row }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1 id="pageTitle">TeamView</h1>
    <div class="toolbar">
      <button class="btn" id="btnShare">공유</button>
      <button class="btn" id="btnCopy">링크 복사</button>
      <button class="btn" id="btnPrint">인쇄</button>
      <button class="btn" id="btnSaveJpg">사진 저장</button>
      <button class="btn" id="btnReload">새로고침</button>
    </div>
  </header>

  <div class="card" id="teamCard">
    <div class="row row-2">
      <div>
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <div id="teamTitle" style="font-size:18px;font-weight:700">팀 정보를 불러오는 중…</div>
          <!-- 왼쪽 배지 = 지역 -->
          <span class="badge" id="leftBadge"></span>
        </div>
        <div class="muted" id="teamSub" style="margin-top:4px">Team ID: <span id="teamIdTxt"></span></div>
        <div id="jerseys" class="jersey" style="margin-top:8px"></div>
      </div>
      <div>
        <div class="kvs" id="teamKVs">
          <div class="kv-k" id="kv1Label">대회명</div>
          <div class="kv-v"><span id="kvRegion" class="kv-chip skeleton skeleton-pill" style="width:60%"></span></div>
          <div class="kv-k">종별·디비전</div>
          <div class="kv-v"><span id="kvCatDiv" class="kv-chip skeleton skeleton-pill" style="width:50%"></span></div>
          <div class="kv-k">대표자</div>
          <div class="kv-v"><span id="kvManager" class="kv-chip skeleton skeleton-pill" style="width:70%"></span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card" id="playersCard">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 style="margin:0;font-size:16px">선수 명단</h3>
      <div class="muted" id="countInfo"></div>
    </div>
    <div class="table-wrap">
      <table>
        <!-- 열 순서: 번호, 이름, 포지션, 생년월일, 만나이, 선출, 출석, 선발출전 -->
        <colgroup>
          <col class="no"><col class="name"><col class="pos"><col class="birth"><col class="age"><col class="elite"><col class="att"><col class="strt">
        </colgroup>
        <thead>
          <tr>
            <th>등번호</th>
            <th>선수이름</th>
            <th class="col-pos">포지션</th>
            <th class="col-birth">생년월일</th>
            <th class="col-age">만나이</th>
            <th class="col-elite">선출</th>
            <th class="col-att">
              출석
            <div class="th-actions">
              <button type="button" class="btn-mini" id="btnAttendToggle">전체체크/해제</button>
            </div>
            </th>
            <th class="col-start">
              선발출전
              <div class="th-actions">
                <button type="button" class="btn-mini" id="btnAllStarterOff">전체해제</button>
              </div>
            </th>
          </tr>
        </thead>
        <tbody id="playersTbody">
          <tr><td colspan="8" class="center"><div class="skeleton" style="width:60%;height:16px;border-radius:8px"></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card" id="errorCard" style="display:none">
    <div style="color:#b91c1c;font-weight:700">불러오기 실패</div>
    <div class="muted" id="errorMsg" style="margin-top:6px"></div>
  </div>
</div>

<script>
/* ============ 상수/설정 ============ */
const DEFAULT_WEB_APP_URL='https://script.google.com/macros/s/AKfycbz1qk5MbQvVU3d8Qs3EcPO792iBNlVQR71WhCpNbkqzCcdn5gM17Hqx9AUAIGUwwSKCww/exec';
const CONF_KEY='BDR_ADMIN_CONF_V2';
const CHECKS_NS='TV_CHECKS_V1::';
let gTeamId='';
const conf = (()=>{ try{ return JSON.parse(localStorage.getItem(CONF_KEY)||'{}'); }catch{return{}} })();
function validWebAppUrl(u){ return /^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec(\?.*)?$/i.test((u||'').trim()); }
function apiBase(){ return validWebAppUrl(conf.appUrl)? conf.appUrl : DEFAULT_WEB_APP_URL; }
function apiUrl(path, q={}){ const u=new URL(apiBase()); u.searchParams.set('path', path); Object.entries(q).forEach(([k,v])=>u.searchParams.set(k,v)); return u.toString(); }
async function getJSON(u){
  try{
    const r=await fetch(u,{cache:'no-store',mode:'cors',credentials:'omit',redirect:'follow'});
    const t=await r.text(); try{ return JSON.parse(t); }catch{ return {ok:false,error:'JSON 파싱 실패', raw:t.slice(0,280)}; }
  }catch(e){ return {ok:false,error:String(e && e.message || e)}; }
}
const A4_TARGET_WIDTH = 2480; // px (A4 가로폭 기준 약 300DPI 품질)
const JPG_QUALITY = 0.92;     // JPEG 품질

/* ============ 유틸 ============ */
const $=s=>document.querySelector(s);
const pad=n=>String(n).padStart(2,'0');
function phonePretty(s){ return String(s||'').replace(/\D/g,'').replace(/^(\d{3})(\d{3,4})(\d{4})$/,'$1-$2-$3'); }
function jerseySVG(hex,label){ const color=(/^[#][0-9a-f]{6}$/i).test(hex||'')?hex:'#e5e7eb', text=(label||'').toUpperCase(); return `<svg width="42" height="52" viewBox="0 0 42 52" xmlns="http://www.w3.org/2000/svg"><g filter="url(#s)"><path d="M14 3 l4 6 h6 l4-6 h6 v15 l3 3 v27 a3 3 0 0 1 -3 3 h-26 a3 3 0 0 1 -3 -3 v-27 l3-3 v-15 z" fill="${color}" stroke="#cbd5e1"/><text x="21" y="31" font-family="system-ui,sans-serif" font-size="9" fill="#0f172a" text-anchor="middle" font-weight="700">${text}</text></g><defs><filter id="s" x="0" y="0" width="42" height="52"><feDropShadow dx="0" dy="1" stdDeviation="1" flood-color="#000" flood-opacity=".08"/></filter></defs></svg>`; }
function qs(k){ return new URLSearchParams(location.search).get(k)||''; }
function fmtBirth(s){ if(!s) return ''; const d=new Date(s); if(!isNaN(d)) return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; return String(s); }

/* 로컬 저장/복원 */
function loadChecks(teamId){ try{ return JSON.parse(localStorage.getItem(CHECKS_NS+teamId)||'{}'); }catch{return{}} }
function saveChecks(teamId, data){ try{ localStorage.setItem(CHECKS_NS+teamId, JSON.stringify(data||{})); }catch{} }
function rowKey(r){
  const no = r['등번호']||r.backNumber||'';
  const name = r['선수이름']||r.playerName||'';
  return `${String(no).trim()}::${String(name).trim()}`;
}

  async function saveViewAsJPG(){
  // 캡처 대상: 상단 헤더 제외, 카드 두 개만 사진으로 저장
  const team = document.getElementById('teamCard');
  const players = document.getElementById('playersCard');
  if(!team || !players){ alert('캡처할 영역을 찾을 수 없습니다.'); return; }

  // 현재 화면 기준 폭/높이 측정
  const baseWrap = document.querySelector('.wrap');
  const baseWidth = (baseWrap && baseWrap.offsetWidth) ? baseWrap.offsetWidth : 980;
  const totalHeight = team.offsetHeight + players.offsetHeight + 28; // 카드 간 여백 포함(대략)

  // 목표 렌더 크기 (A4 폭 맞춤)
  const targetW = A4_TARGET_WIDTH;
  const scale = targetW / baseWidth;
  const targetH = Math.ceil(totalHeight * scale);

  // 캡처용 DOM 복제(헤더 제외)
  const container = document.createElement('div');
  container.style.width = baseWidth + 'px';
  container.style.padding = '14px';
  container.style.boxSizing = 'border-box';
  container.style.background = getComputedStyle(document.body).backgroundColor || '#ffffff';

  const teamClone = team.cloneNode(true);
  const playersClone = players.cloneNode(true);
  container.appendChild(teamClone);
  container.appendChild(playersClone);

  // 현재 문서 <style>들을 foreignObject 안에 주입 (스타일 유지)
  const styleTexts = Array.from(document.querySelectorAll('style'))
    .map(s => s.innerHTML)
    .join('\n');
  const inlineStyles = `<style>${styleTexts}</style>`;

  // foreignObject용 HTML (XHTML 네임스페이스 지정)
  const innerHTML = `
    ${inlineStyles}
    <div xmlns="http://www.w3.org/1999/xhtml" style="width:${baseWidth}px; box-sizing:border-box;">
      ${container.innerHTML}
    </div>
  `;

  // SVG + foreignObject로 캔버스에 그리기
  const svg = `
    <svg xmlns="http://www.w3.org/2000/svg" width="${targetW}" height="${targetH}">
      <foreignObject width="100%" height="100%">
        <div xmlns="http://www.w3.org/1999/xhtml" style="transform-origin: 0 0; transform: scale(${scale});">
          ${innerHTML}
        </div>
      </foreignObject>
    </svg>
  `;
  const svgBlob = new Blob([svg], { type:'image/svg+xml;charset=utf-8' });
  const url = URL.createObjectURL(svgBlob);

  const img = new Image();
  img.crossOrigin = 'anonymous';
  await new Promise((res, rej)=>{ img.onload=()=>res(); img.onerror=rej; img.src=url; });

  const canvas = document.createElement('canvas');
  canvas.width = targetW;
  canvas.height = targetH;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img, 0, 0);
  URL.revokeObjectURL(url);

  // 파일 저장
  const now = new Date();
  const filenameSafe = (document.getElementById('pageTitle')?.textContent || 'TeamView')
    .replace(/[\\/:*?"<>|]/g,'_');
  canvas.toBlob(blob=>{
    if(!blob){ alert('이미지 변환에 실패했습니다.'); return; }
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `TeamView_${filenameSafe}_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}.jpg`;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 200);
  }, 'image/jpeg', JPG_QUALITY);
}

/* ============ 렌더러 ============ */
function fillKV(id, text){
  const el = document.getElementById(id);
  if(!el) return;
  el.textContent = text || '-';
  el.classList.remove('skeleton','skeleton-pill');
}

function renderTeamCard(team){
  if(!team){
    $('#teamTitle').textContent='팀 정보를 찾을 수 없습니다.';
    $('#leftBadge').textContent='';
    $('#teamSub').textContent='';
    $('#teamKVs').innerHTML='';
    return;
  }
  const title = [team.teamNameKo||'', team.teamNameEn?`(${team.teamNameEn})`:'' ].join(' ').trim();
  $('#pageTitle').textContent = title || 'TeamView';
  $('#teamTitle').textContent = title || '무명 팀';
  $('#teamIdTxt').textContent = String(team.teamId||'');
  $('#jerseys').innerHTML = `<div class="jersey">${jerseySVG(team.uniformHome||'#e5e7eb','HOME')}${jerseySVG(team.uniformAway||'#e5e7eb','AWAY')}</div>`;

  const regionStr = [team.province||'', team.city||''].join(' ').trim() || (team.region||'');
  const tourName  = team.tourName || '';
  const catdiv    = [team.category||'', team.division||''].filter(Boolean).join(' · ');
  const mgr       = [team.managerName||'', phonePretty(team.managerPhone||'')].filter(Boolean).join(' · ');

  // 왼쪽 배지 = 지역, 우측 첫 줄 = 대회명
  $('#leftBadge').textContent = regionStr || '';
  $('#kv1Label').textContent = '대회명';
  fillKV('kvRegion', tourName);
  fillKV('kvCatDiv', catdiv);
  fillKV('kvManager', mgr);
}

function renderPlayers(rows){
  const tb = $('#playersTbody');
  if(!Array.isArray(rows) || rows.length===0){
    tb.innerHTML = `<tr><td colspan="8" class="muted">등록된 선수 명단이 없습니다.</td></tr>`;
    $('#countInfo').textContent = '0명';
    return;
  }
  const normNo = v => {
    const s = String(v||'').trim();
    const m = s.match(/^\d+$/); return m ? parseInt(s,10) : Number.MAX_SAFE_INTEGER;
  };
  rows.sort((a,b)=> normNo(a['등번호']||a.backNumber) - normNo(b['등번호']||b.backNumber));

  const saved = loadChecks(gTeamId);

  tb.innerHTML = rows.map(r=>{
    const no   = r['등번호']||r.backNumber||'';
    const name = r['선수이름']||r.playerName||'';
    const pos  = (r['포지션']||r.position||'').toUpperCase();
    const birth= fmtBirth(r['생년월일']||r.birth||r.dob||'');
    const age  = r['만나이']||r.age||'';
    const elite= r['선출여부']||r.elite||'';
    const key  = rowKey(r);
    const st = saved[key] || { a:false, s:false };
    return `<tr data-key="${key}">
      <td class="backno ellipsis">${no||'-'}</td>
      <td class="ellipsis">${name||''}</td>
      <td class="col-pos ellipsis">${pos||''}</td>
      <td class="col-birth ellipsis">${birth||''}</td>
      <td class="col-age ellipsis">${age||''}</td>
      <td class="col-elite ellipsis">${elite||''}</td>
      <td class="col-att"><input type="checkbox" class="chk-attend"${st.a?' checked':''} aria-label="출석"></td>
      <td class="col-start"><input type="checkbox" class="chk-starter"${st.s?' checked':''} aria-label="선발출전"></td>
    </tr>`;
  }).join('');
  $('#countInfo').textContent = `${rows.length}명`;
}

/* ============ 로드 ============ */
async function boot(){
  gTeamId = qs('teamId') || qs('id');
  if(!gTeamId){
    document.getElementById('errorCard').style.display='';
    document.getElementById('errorMsg').textContent='teamId 파라미터가 필요합니다. 예) teamview.html?teamId=TMXXXXXXXX';
    return;
  }
  const teamRes = await getJSON(apiUrl('getteam', { teamId: gTeamId }));
  if(!(teamRes && (teamRes.ok===true || teamRes.team))){
    document.getElementById('errorCard').style.display='';
    document.getElementById('errorMsg').textContent = (teamRes && (teamRes.error||teamRes.raw)) || '팀 정보를 불러올 수 없습니다.';
  }
  renderTeamCard(teamRes && teamRes.team);

  const plyRes = await getJSON(apiUrl('players', { teamId: gTeamId }));
  if(!(plyRes && Array.isArray(plyRes.rows))){
    document.getElementById('playersTbody').innerHTML = `<tr><td colspan="8" class="muted">선수명단을 불러오지 못했습니다.</td></tr>`;
    document.getElementById('countInfo').textContent = '';
  }else{
    renderPlayers(plyRes.rows);
  }
}

/* ============ 유틸: 체크 일괄 적용 ============ */
function setCheckedAll(selector, value){
  const inputs = document.querySelectorAll(selector);
  inputs.forEach(inp=>{
    if(inp.checked !== value){
      inp.checked = value;
      // 변경 이벤트 발생시켜 저장 로직 실행
      inp.dispatchEvent(new Event('change', { bubbles:true }));
    }
  });
}

/* ============ 상단 버튼 ============ */
document.getElementById('btnReload').addEventListener('click', ()=>location.reload());
document.getElementById('btnPrint').addEventListener('click', ()=>window.print());
document.getElementById('btnCopy').addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(location.href); alert('현재 페이지 링크를 복사했습니다.'); }catch{ alert('복사 실패'); }
});
document.getElementById('btnShare').addEventListener('click', async ()=>{
  try{
    if(navigator.share){
      await navigator.share({ title: document.title, text:'팀 선수명단', url: location.href });
    }else{
      await navigator.clipboard.writeText(location.href);
      alert('공유 API 미지원 기기입니다. 링크를 복사했습니다.');
    }
  }catch(e){}
});
document.getElementById('btnSaveJpg').addEventListener('click', ()=>saveViewAsJPG().catch(e=>alert('이미지 저장 중 오류: '+e)));

/* ============ 헤더 액션 버튼 동작 ============ */
document.addEventListener('click', (e)=>{
  const id = (e.target && e.target.id) || '';
  if(id === 'btnAttendToggle'){
    const nodes = Array.from(document.querySelectorAll('.chk-attend'));
    const shouldCheck = nodes.some(n => !n.checked); // 하나라도 미체크면 전체 체크
    setCheckedAll('.chk-attend', shouldCheck);
  }else if(id === 'btnAllStarterOff'){
    setCheckedAll('.chk-starter', false);
  }
});

/* ============ 인쇄: 출석 체크된 행만 살리기(화면 비율 유지) ============ */
function applyPrintKeepRows(){
  const rows = document.querySelectorAll('#playersTbody tr');
  rows.forEach(tr=>{
    const att = tr.querySelector('.chk-attend');
    if(att && att.checked){ tr.classList.add('print-keep'); }
    else { tr.classList.remove('print-keep'); }
  });
}
window.addEventListener('beforeprint', applyPrintKeepRows);

/* ============ 체크 상태 저장 ============ */
document.addEventListener('change', (e)=>{
  const t = e.target;
  if(!(t instanceof HTMLInputElement)) return;
  if(!t.closest('#playersTbody')) return;

  if(t.classList.contains('chk-attend') || t.classList.contains('chk-starter')){
    const tr = t.closest('tr');
    const key = tr?.getAttribute('data-key')||'';
    if(!key) return;
    const all = loadChecks(gTeamId);
    const aEl = tr.querySelector('.chk-attend');
    const sEl = tr.querySelector('.chk-starter');

    // 선발 체크 시 출석 자동 체크
    if(t.classList.contains('chk-starter') && sEl?.checked && aEl && !aEl.checked){
      aEl.checked = true;
    }
    all[key] = { a: !!aEl?.checked, s: !!sEl?.checked };
    saveChecks(gTeamId, all);
  }
});

boot();
</script>
</body>
</html>
