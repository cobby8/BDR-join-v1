<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BDR ê´€ë¦¬ì v1.1</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --blue:#1769ff; --bg:#f6f8fb; --card:#fff; --muted:#6b7684; --red:#ef4444; --green:#16a34a }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:'Pretendard','Apple SD Gothic Neo',sans-serif;color:#222}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px 64px}
  header{display:flex;justify-content:space-between;align-items:center;margin:10px 0 18px}
  h1{font-size:20px;margin:0}
  .card{background:var(--card);border-radius:14px;box-shadow:0 8px 28px rgba(23,105,255,.08);padding:16px;margin-top:16px}
  .row{display:grid;gap:12px}
  @media(min-width:720px){ .row-2{grid-template-columns:1.2fr 2fr} .row-3{grid-template-columns:1fr 1fr 1fr} }
  label{display:block;font-weight:600;margin:10px 0 6px}
  input,select,textarea{width:100%;padding:12px;border:1px solid #e6ecf5;border-radius:12px;font-size:14px;outline:none;background:#fff}
  input:focus,select:focus,textarea:focus{border-color:var(--blue)}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid #dfe6ee;background:#fff;cursor:pointer;white-space:nowrap;display:inline-block}
  .btn.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
  .btn.danger{background:#fff;color:#ef4444;border-color:#ffd1d1}
  .btn.ghost{background:#fff;color:#334155;border-color:#e6ecf5}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:12px}
  .grid{display:grid;gap:10px}
  .grid-2{grid-template-columns:1fr 1fr}
  .pill{display:inline-block;border:1px solid #e6ecf5;border-radius:999px;padding:6px 10px;font-size:12px;margin:2px 0;background:#fff;cursor:pointer;user-select:none;transition:background .12s, box-shadow .12s}
  .pill:hover{ background:#f8fbff; box-shadow:0 2px 6px rgba(23,105,255,.15) }
  .hr{height:1px;background:#eef2f7;margin:8px 0}
  .badge{display:inline-flex;gap:8px;align-items:center;font-size:12px;color:#334155;background:#f1f5fb;border:1px solid #e4ecf7;border-radius:999px;padding:4px 8px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid #e6ecf5;border-radius:999px;padding:6px 10px;font-size:12px;background:#fff;cursor:pointer}
  .place-item{display:grid;gap:8px;grid-template-columns:1.7fr 1fr 1fr auto;align-items:center;border:1px solid #e6ecf5;border-radius:12px;padding:10px;background:#fff}
  .locked *[data-editable]{pointer-events:none; opacity:.9}
  .input-icon{position:relative}
  .eye-btn{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:0;background:transparent;cursor:pointer;font-size:16px}
  .offscreen{position:absolute;left:-9999px;opacity:0;width:0;height:0;pointer-events:none}

  /* í‘œ ê¸°ë³¸ */
  table{width:100%;border-collapse:separate;border-spacing:0 10px;table-layout:fixed}
  col.col-region{width:18%}
  col.col-team{width:26%}
  col.col-uniform{width:14%}
  col.col-catdiv{width:18%}
  col.col-created{width:16%}
  col.col-actions{width:8%}

  th{font-size:12px;color:#5b6472;text-align:left;padding:0 10px}
  td{background:#fff;padding:12px 10px;border-top:1px solid #eef2f7;border-bottom:1px solid #eef2f7;vertical-align:top}
  tr td:first-child{border-left:1px solid #eef2f7;border-radius:12px 0 0 12px}
  tr td:last-child{border-right:1px solid #eef2f7;border-radius:0 12px 12px 0}
  .ellipsis{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

  /* ìœ ë‹ˆí¼ ì¤‘ì•™ */
  .jersey{display:flex;align-items:center;justify-content:center;gap:16px;width:100%}

  /* íŒì—… */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:.15s;z-index:9998}
  .overlay.show{opacity:1;pointer-events:auto}
  .popover{position:fixed;min-width:320px;max-width:92vw;background:#fff;border:1px solid #e6ecf5;border-radius:14px;box-shadow:0 12px 30px rgba(0,0,0,.16);opacity:0;transform:translate(-50%,-6px);transition:.15s;z-index:9999;left:50%;top:13%}
  .popover.show{opacity:1;transform:translate(-50%,0)}
  .pop-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #eef2f7;font-weight:700}
  .pop-body{padding:12px}
  .pop-actions{display:flex;gap:8px;justify-content:flex-end;padding:10px 12px;border-top:1px solid #eef2f7}

  /* í¬ìŠ¤í„° */
  .poster-preview{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .poster-preview img{max-width:220px;max-height:220px;border-radius:12px;border:1px solid #e6ecf5;object-fit:contain;background:#fff}
  .poster-drop{border:1px dashed #cbd5e1;border-radius:12px;padding:12px;text-align:center;color:#64748b;cursor:pointer;min-width:240px}
  .poster-meta{display:flex;gap:8px;align-items:center}

  /* ì•¡ì…˜ ë²„íŠ¼ ì •ë ¬ */
  .actions-cell{ display:flex; gap:8px; justify-content:flex-end; align-items:center; }
  .actions-cell .btn{ transform:scale(.9); transform-origin:right center; }
  .actions-cell .btn.primary, .actions-cell .btn.danger{ padding:9px 13px; font-size:13px; }

  /* ì¢…ë³„Â·ë””ë¹„ì „ 2ì¤„ */
  .td-catdiv .cat-line{font-weight:600; line-height:1.1}
  .td-catdiv .div-line{color:var(--muted); margin-top:2px; line-height:1.1}

  /* ì‹ ì²­ì¼ì‹œ ì¢Œì •ë ¬ */
  .td-created{ text-align:left; }

/* ëª¨ì§‘íŒ€ìˆ˜ ì¸í’‹ + ë””ë¹„ì „ 4ì—´ ê·¸ë¦¬ë“œ(ë°˜ì‘í˜•) */
.cap-input{
  width:clamp(56px, 20vw, 78px);   /* ê³µê°„ì´ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ ë” ì–‡ì•„ì§ */
  min-width:56px;
  padding:6px 8px;
  border:1px solid #e6ecf5; border-radius:10px;
  font-size:clamp(11px, 0.9vw, 12px);
}
/* PC 4ì—´, ì¤„ì–´ë“¤ë©´ 3â†’2â†’1ì—´ */
/* PC/Narrow ëª¨ë‘ ëŒ€ì‘: ì¹© ì¹¸ì„ ìë™ìœ¼ë¡œ ëŠ˜ë¦¬ê³  ì¤„ì´ëŠ” ìœ ë™ ê·¸ë¦¬ë“œ */
.cap-row{
  display:grid;
  /* í•œ ì¹¸ ìµœì†Œ 160px í™•ë³´, ë” ê³µê°„ ìˆìœ¼ë©´ ì•Œì•„ì„œ ì—¬ëŸ¬ ì¹¸ ë°°ì¹˜ */
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap:10px;
  align-items:stretch;
  grid-auto-rows:minmax(44px,auto);
  overflow:visible;
}
/* place-item ì•ˆì—ì„œëŠ” ì¹© ì˜ì—­ì´ ì œëª© ì˜¤ë¥¸ìª½ ì „í­ ì‚¬ìš© */
.place-item .cap-row{ grid-column: 2 / -1; }

.cap-chip{
  display:flex; align-items:center; gap:8px;
  border:1px solid #e6ecf5; background:#fff; border-radius:999px;
  padding:6px 10px;
  /* ì…€(ê·¸ë¦¬ë“œ ì¹¸) ê°€ë¡œí­ì„ ê½‰ ì±„ìš°ë˜, ì•ˆì—ì„œ ìœ ì—°í•˜ê²Œ ì¤„ì–´ë“¦ */
  width:100%; min-width:0;
  font-size:clamp(11px, 0.9vw, 12px);
  white-space:nowrap;
  box-sizing:border-box;
}
.cap-chip b{ font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.cap-chip .remove{ border:0; background:transparent; cursor:pointer; color:#ef4444; font-size:14px; line-height:1 }
.cap-note{ color:#64748b; font-size:clamp(11px, 0.9vw, 12px); }

  /* === Admin: ëª¨ë°”ì¼ ì¹´ë“œ ë ˆì´ì•„ì›ƒ (â‰¤640px) === */
  @media (max-width:640px){
    table.responsive-table thead{ display:none; }
    table.responsive-table, 
    table.responsive-table tbody, 
    table.responsive-table tr, 
    table.responsive-table td{ display:block; width:100%; }

    table.responsive-table tbody tr{
      background:#fff;
      border:1px solid #e6ecf5;
      border-radius:14px;
      margin:10px 0;
      padding:10px;
    }
    table.responsive-table td{ border:none; padding:8px 6px 4px; }
    table.responsive-table td::before{
      content: attr(data-label);
      display:block; font-size:12px; color:#6b7280; margin-bottom:4px; line-height:1.2;
    }
    table.responsive-table td:last-child .actions-cell{ justify-content:flex-end; }

    #formArea .grid > *, #formArea .row-2 > *, #formArea .place-item > * { min-width:0; }
    #formArea input, #formArea textarea { word-break:break-all; }
    #formArea .place-item{ grid-template-columns:1fr; }
    #formArea .poster-meta{ flex-wrap:wrap; row-gap:6px; }
    #formArea .poster-preview{ gap:8px; }
    #formArea .poster-preview img{ max-width:100%; height:auto; }
    #formArea .pill, #formArea .chip, #formArea .badge{ max-width:100%; overflow:hidden; text-overflow:ellipsis; }

    #teamsTable.responsive-table tbody tr{
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-template-areas:
        "team   region"
        "catdiv created"
        "uniform actions";
      gap:10px 12px;
      align-items:center;
    }
    #teamsTable.responsive-table td:nth-child(2){ grid-area: team; }
    #teamsTable.responsive-table td:nth-child(1){ grid-area: region; }
    #teamsTable.responsive-table td:nth-child(3){ grid-area: uniform; text-align:center; }
    #teamsTable.responsive-table td:nth-child(4){ grid-area: catdiv; }
    #teamsTable.responsive-table td:nth-child(5){ grid-area: created; }
    #teamsTable.responsive-table td:nth-child(6){ grid-area: actions; }

    #teamsTable.responsive-table td:nth-child(2)::before,
    #teamsTable.responsive-table td:nth-child(6)::before{ display:none; }

    #teamsTable.responsive-table td:nth-child(2) b{ font-size:15px; }
    #teamsTable.responsive-table td:nth-child(2) .muted{ display:block; margin-top:2px; }
    #teamsTable.responsive-table td{ min-width:0; }
  }

  #selectedTourInfo .chip{
    display:inline-block; padding:6px 10px; border-radius:999px;
    background:#f1f5fb; border:1px solid #e4ecf7; color:#334155;
    max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
  /* ì œëª© + ì¹© 2ì¹¼ëŸ¼ì„ ì´˜ì´˜íˆ */
  .place-item.div-row{
    grid-template-columns: auto 1fr;
    align-items: center;
    gap:8px 10px;   /* ì„¸ë¡œ 8, ê°€ë¡œ 10ìœ¼ë¡œ ì—¬ë°± ìµœì í™” */
  }
  /* í¸ì§‘ëª¨ë“œ ì•„ë‹ ë•Œ í¬ìŠ¤í„° ë“œë¡­ ë¹„í™œì„±í™” í‘œì‹œ */
  .poster-drop.disabled{
    cursor: not-allowed;
    opacity: .6;
    pointer-events: none; /* í´ë¦­/ë“œë˜ê·¸ ëª¨ë‘ ì°¨ë‹¨ */
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>BDR ê´€ë¦¬ì v1.1</h1>
    <div class="toolbar" title="ì—°ê²°ìƒíƒœ">
      <span class="muted" id="healthDot">â—</span>
      <button class="btn" id="settingsBtn">âš™ï¸ ì„¤ì •</button>
      <button class="btn" id="reloadBtn">ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </header>

  <input class="offscreen" type="text" autocomplete="username" />
  <input class="offscreen" type="password" autocomplete="current-password" />

  <div class="card">
    <div class="row row-3">
      <div>
        <label>ëŒ€íšŒ í•„í„°</label>
        <select id="tourFilter"><option value="">ì „ì²´ ëŒ€íšŒ</option></select>
      </div>
      <div class="muted" style="align-self:end">â€» âš™ï¸ì—ì„œ Apps Script Web App URLì„ ë³€ê²½/í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0;font-size:16px">ëŒ€íšŒ ê´€ë¦¬</h3>
      <div class="toolbar">
        <button class="btn" id="newTourBtn">ì‹ ê·œ ëŒ€íšŒ</button>
        <button class="btn" id="editBtn" disabled>ìˆ˜ì •</button>
      </div>
    </div>

    <div class="row row-2">
      <div>
        <label>ëŒ€íšŒ ëª©ë¡</label>
        <div id="tourList" class="grid"></div>
      </div>

      <div id="formArea" class="locked">
        <label id="tourFormTitle">ëŒ€íšŒ ë“±ë¡/ìˆ˜ì •</label>

        <div class="grid">
          <input id="tourId" placeholder="ìë™ìƒì„± (ìˆ˜ì • ì‹œ ê³ ì •)" disabled>
          <input id="tourName" placeholder="ëŒ€íšŒëª…" data-editable>
          <input id="tourUrl" placeholder="ì•ˆë‚´ í˜ì´ì§€ URL (ì„ íƒ)" data-editable inputmode="url" autocomplete="off" spellcheck="false">
        </div>

        <label class="muted" style="margin-top:8px">ì¢…ë³„ ì„¤ì •</label>
        <div class="muted" style="margin-top:-6px">
          í¸ì§‘ ëª¨ë“œì—ì„œë§Œ <b>+ êµ¬ë¶„/ì¢…ë³„ ì¶”ê°€</b> ì‚¬ìš© ê°€ëŠ¥. ê° ì¢…ë³„(ë˜ëŠ” ìœ ì†Œë…„ ìŒ) ìš°ì¸¡ì— <b>ëª¨ì§‘íŒ€ìˆ˜</b>ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
        </div>
        <div id="divSetList" class="grid" style="margin-top:8px"></div>
        <div class="toolbar" style="margin-top:6px;justify-content:space-between">
          <button class="btn danger" id="clearAllDivBtn" data-editable disabled>ì¢…ë³„êµ¬ë¶„ ì „ì²´ ì‚­ì œ</button>
          <button class="btn ghost" id="addDivSetBtn" data-editable disabled>+ êµ¬ë¶„/ì¢…ë³„ ì¶”ê°€</button>
        </div>

        <div class="hr"></div>

        <label>ëŒ€íšŒì¥ì†Œ</label>
        <div class="muted" style="margin-top:-6px">+ ì¥ì†Œ ì¶”ê°€ â†’ ì¥ì†Œëª…ë§Œ ì…ë ¥í•©ë‹ˆë‹¤.</div>
        <div id="placeList" class="grid" style="margin-top:8px"></div>
        <div class="toolbar" style="margin-top:6px;justify-content:flex-end">
          <button class="btn ghost" id="addPlaceBtn" data-editable disabled>+ ì¥ì†Œ ì¶”ê°€</button>
        </div>

        <div class="hr"></div>

        <label>ëŒ€íšŒ í¬ìŠ¤í„°</label>
        <div class="poster-preview" id="posterPreview"></div>
        <div class="toolbar" style="justify-content:space-between;margin-top:6px">
          <div class="poster-meta">
            <label><input type="checkbox" id="posterEmbed" disabled> DataURLë¡œ ì €ì¥(ì‚¬ìš© ì•ˆ í•¨)</label>
            <span class="muted">â€» ì„œë²„ëŠ” Driveì— ì—…ë¡œë“œí•˜ê³  <b>posterId/posterUrl</b>ë§Œ ì €ì¥í•©ë‹ˆë‹¤.</span>
          </div>
          <div class="toolbar">
            <button class="btn" id="posterCopy" disabled>ì£¼ì†Œ ë³µì‚¬</button>
            <button class="btn danger" id="posterClear" disabled>í¬ìŠ¤í„° ì œê±°</button>
          </div>
        </div>

        <div class="hr"></div>

        <label>ëŒ€íšŒê¸°ê°„</label>
        <div class="grid grid-2">
          <input id="tourStart" type="date" placeholder="ì‹œì‘ì¼" data-editable>
          <input id="tourEnd" type="date" placeholder="ì¢…ë£Œì¼" data-editable>
        </div>

        <label style="margin-top:10px">ì ‘ìˆ˜ê¸°ê°„</label>
        <div class="grid grid-2">
          <input id="regStart" type="datetime-local" placeholder="ì ‘ìˆ˜ ì‹œì‘" data-editable>
          <input id="regEnd" type="datetime-local" placeholder="ì ‘ìˆ˜ ì¢…ë£Œ" data-editable>
        </div>

        <!-- âœ¨ ìˆ˜ì • ë§ˆê°(ì ‘ìˆ˜ê¸°ê°„ ì•„ë˜) -->
        <label style="margin-top:10px">ìˆ˜ì • ë§ˆê°</label>
        <input id="editDeadlineAt" type="datetime-local" placeholder="ìˆ˜ì • ë§ˆê°" data-editable>

        <div class="hr"></div>
        
        <label>ê²°ì œ ì •ë³´</label>
        <div class="grid" style="margin-top:6px">
          <div>
            <label style="margin:0 0 6px">ì°¸ê°€ë¹„</label>
            <input id="fee" placeholder="ì˜ˆ: 90,000" data-editable>
            <div class="muted">ì°¸ê°€ì‹ ì²­ì„œì—ëŠ” <b>â€œì°¸ê°€ë¹„ nì›â€</b> í˜•íƒœë¡œ í‘œì‹œë©ë‹ˆë‹¤.</div>
          </div>
          <div>
            <label style="margin:0 0 6px">ì…ê¸ˆê³„ì¢Œ</label>
            <input id="account" placeholder="ì˜ˆ: ì¹´ì¹´ì˜¤ë±…í¬ 3333-01-1234567 í™ê¸¸ë™" data-editable>
            <div class="muted">ì‹ ì²­ì„œì—ëŠ” <b>â€œì€í–‰ëª… ê³„ì¢Œë²ˆí˜¸ ì˜ˆê¸ˆì£¼â€</b> í•œ ì¤„ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</div>
          </div>
        </div>

        <div class="grid grid-2" style="margin-top:12px;align-items:end">
          <div>
            <label>ëŒ€íšŒê´€ë¦¬ ì½”ë“œ (í•„ìˆ˜)</label>
            <div class="input-icon">
              <input id="adminCode" type="password" placeholder="ì´ ëŒ€íšŒë¥¼ ê´€ë¦¬í•  ë¹„ë°€ë²ˆí˜¸" data-editable autocomplete="current-password" name="password" readonly>
              <button class="eye-btn" id="toggleCodeBtn" title="ë³´ê¸°/ìˆ¨ê¸°ê¸°">ğŸ‘ï¸</button>
            </div>
            <div style="margin-top:8px">
              <label>ìƒíƒœ(ìë™)</label>
              <div id="tourStatusBadge" class="badge">ìƒíƒœë¯¸ì •</div>
            </div>
          </div>
          <div class="toolbar" style="justify-content:flex-end;gap:8px">
            <button class="btn danger" id="deleteTourBtn" data-editable disabled>ì‚­ì œ</button>
            <button class="btn primary" id="saveTourBtn" data-editable disabled>ì €ì¥</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- íŒ€/ì„ ìˆ˜ -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0;font-size:16px">ì°¸ê°€íŒ€ ëª…ë‹¨</h3>
      <div class="toolbar">
        <input id="searchText" placeholder="íŒ€ëª…/ëŒ€í‘œì/ì—°ë½ì²˜ ê²€ìƒ‰" style="width:160px">
        <button class="btn" id="searchBtn">ê²€ìƒ‰</button>
      </div>
    </div>

    <!-- ì„ íƒëœ ëŒ€íšŒ í‘œì‹œ (í•˜ë‚˜ë§Œ ìœ ì§€) -->
    <div id="selectedTourInfo" class="muted tour-summary" style="margin:-2px 0 8px"></div>

    <div style="overflow:auto">
      <table id="teamsTable" class="responsive-table">
        <colgroup>
          <col class="col-region" />
          <col class="col-team" />
          <col class="col-uniform" />
          <col class="col-catdiv" />
          <col class="col-created" />
          <col class="col-actions" />
        </colgroup>
        <thead>
          <tr>
            <th>ì§€ì—­</th>
            <th>íŒ€ / ëŒ€í‘œì</th>
            <th>ìœ ë‹ˆí¼</th>
            <th>ì¢…ë³„Â·ë””ë¹„ì „</th>
            <th>ì‹ ì²­ì¼ì‹œ</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="teamsTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="overlay" class="overlay"></div>
<div id="popover" class="popover" role="dialog" aria-modal="true" style="display:none">
  <div class="pop-head"><span id="popTitle">ì œëª©</span><button class="btn" id="popCloseBtn">ë‹«ê¸°</button></div>
  <div class="pop-body" id="popBody"></div>
  <div class="pop-actions" id="popActions"></div>
</div>

<script>
/* ========= ìƒìˆ˜ ========= */
const WEB_APP_URL='https://script.google.com/macros/s/AKfycbz1qk5MbQvVU3d8Qs3EcPO792iBNlVQR71WhCpNbkqzCcdn5gM17Hqx9AUAIGUwwSKCww/exec';
const VIEWER_BASE='./teamview.html';

/* ========= ìƒíƒœ ì  ========= */
function setHealth(color, tip){ const dot=document.getElementById('healthDot'); dot.style.color=color; if(tip) dot.title=tip||''; }

/* ========= ì„¤ì • ì €ì¥ ========= */
const CONF_KEY='BDR_ADMIN_CONF_V2';
const store={ load(){ try{ return JSON.parse(localStorage.getItem(CONF_KEY)||'{}'); }catch{return{};} }, save(o){ localStorage.setItem(CONF_KEY, JSON.stringify(o||{})); } };
function validWebAppUrl(u){ return /^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec(\?.*)?$/i.test((u||'').trim()); }
let conf=store.load(); if(!validWebAppUrl(conf.appUrl)) { conf.appUrl=WEB_APP_URL; store.save(conf); }

/* ========= DOM/UTIL ========= */
const $=s=>document.querySelector(s);
const el=h=>{ const t=document.createElement('template'); t.innerHTML=h.trim(); return t.content.firstElementChild; };
const pad=n=>String(n).padStart(2,'0');
const phonePretty=s=> (s||'').replace(/\D/g,'').replace(/^(\d{3})(\d{3,4})(\d{4})$/,'$1-$2-$3');
function fmtDate(v){  if(!v) return '';  const d=new Date(v);  if(isNaN(d)) return String(v);  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;}
function fmtDateShort(v){  if(!v) return '';  const d=new Date(v);  if(isNaN(d)) return String(v);  const yy = String(d.getFullYear()).slice(-2);  return `${yy}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;}

/* === Admin: ëª¨ë°”ì¼ ì¹´ë“œìš© ë¼ë²¨ ì£¼ì… === */
function applyDataLabelsToTable(table){
  if(!table) return;
  const ths = table.querySelectorAll('thead th');
  if(!ths.length) return;
  const headers = Array.from(ths).map(th=> (th.textContent||'').trim());
  table.querySelectorAll('tbody tr').forEach(tr=>{
    const tds = tr.querySelectorAll('td');
    tds.forEach((td, i)=>{
      const label = headers[i] || '';
      if(label) td.setAttribute('data-label', label);
    });
  });
}
function applyResponsiveLabels(){
  document.querySelectorAll('table.responsive-table').forEach(applyDataLabelsToTable);
}
function toInputDateOnly(s){ if(!s) return ''; if(typeof s==='string'){ const m=s.match(/^(\d{4}-\d{2}-\d{2})/); if(m) return m[1]; } const d=new Date(s); if(!isNaN(d)) return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; return ''; }
function toInputDT(s){ if(!s) return ''; if(typeof s==='string'){ const m=s.match(/^(\d{4}-\d{2}-\d{2})[ T](\d{2}):(\d{2})/); if(m) return `${m[1]}T${m[2]}:${m[3]}`; } const d=new Date(s); if(!isNaN(d)) return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; return ''; }
function calcStatus(rs,re){ if(!rs||!re) return 'ìƒíƒœë¯¸ì •'; const s=new Date(rs), e=new Date(re), n=new Date(); if(isNaN(s)||isNaN(e)) return 'ìƒíƒœë¯¸ì •'; if(n<s) return 'ì ‘ìˆ˜ì „'; if(n>e) return 'ë§ˆê°'; return 'ì ‘ìˆ˜ì¤‘'; }
function statusBadgeHtml(st){ const m={'ì ‘ìˆ˜ì¤‘':{bg:'#ecfdf5',bd:'#d1fae5',fg:'#16a34a'},'ì ‘ìˆ˜ì „':{bg:'#eff6ff',bd:'#dbeafe',fg:'#1769ff'},'ë§ˆê°':{bg:'#fef2f2',bd:'#fee2e2',fg:'#ef4444'},'ìƒíƒœë¯¸ì •':{bg:'#f1f5fb',bd:'#e4ecf7',fg:'#334155'}}; const c=m[st]||m['ìƒíƒœë¯¸ì •']; return `<span class="badge" style="background:${c.bg};border-color:${c.bd};color:${c.fg}">${st}</span>`; }

/* ========= API ìœ í‹¸ ========= */
const truthyFlag = (v)=>{ if (v===true || v===1) return true; if (typeof v==='string') { const s=v.trim().toLowerCase(); if (['true','ok','success','done','1','yes'].includes(s)) return true; } return false; };
const isSuccessResponse = (j)=>{ if (!j || typeof j!=='object') return false; if (truthyFlag(j.ok) || truthyFlag(j.success) || truthyFlag(j.status) || j.rows!==undefined) return true; if (j.tourId || j.id || (j.data && (j.data.tourId || j.data.id))) return true; if (Number.isFinite(j.affectedRows) || Number.isFinite(j.updated) || Number.isFinite(j.inserted) || Number.isFinite(j.count)) return true; return false; };
function apiUrl(path,q={}){ 
  let base=(conf.appUrl||'').trim(); if(!validWebAppUrl(base)){ base=WEB_APP_URL; conf.appUrl=base; store.save(conf); }
  const u=new URL(base); u.searchParams.set('path', path); Object.entries(q).forEach(([k,v])=>u.searchParams.set(k,v)); return u.toString();
}
async function getJSON(u){
  try{
    const r=await fetch(u,{cache:'no-store',mode:'cors',credentials:'omit',redirect:'follow'});
    const t=await r.text();
    try{ return JSON.parse(t); }catch(e){
      return { ok:false, error:'JSON íŒŒì‹± ì‹¤íŒ¨', raw: t.slice(0,300) };
    }
  }catch(e){
    return { ok:false, error: String(e && e.message || e) };
  }
}
async function postJSONCompat(paths, payload){
  const bodyText = JSON.stringify(payload||{});
  const tryTextPlain = async(p)=>{
    const r = await fetch(apiUrl(p), {
      method:'POST', headers:{'Content-Type':'text/plain'},
      body: bodyText, cache:'no-store', redirect:'follow', credentials:'omit', mode:'cors'
    });
    const t=await r.text(); try{ return JSON.parse(t); }catch{ return {ok:false,error:t||'JSON íŒŒì‹± ì‹¤íŒ¨'}; }
  };
  const tryUrlEncoded = async(p)=>{
    const r = await fetch(apiUrl(p), {
      method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body: 'payload='+encodeURIComponent(bodyText),
      cache:'no-store', redirect:'follow', credentials:'omit', mode:'cors'
    });
    const t=await r.text(); try{ return JSON.parse(t); }catch{ return {ok:false,error:t||'JSON íŒŒì‹± ì‹¤íŒ¨'}; }
  };
  let last=null;
  for (const p of paths){
    try{ const j=await tryTextPlain(p); last=j; if (isSuccessResponse(j) || j.error!==undefined) return j; }catch(e){ last={ok:false,error:String(e?.message||e)}; }
    try{ const j=await tryUrlEncoded(p); last=j; if (isSuccessResponse(j) || j.error!==undefined) return j; }catch(e){ last={ok:false,error:String(e?.message||e)}; }
  }
  return last||{ok:false,error:'unknown'};
}

/* ========= Floating core ========= */
const overlay = document.getElementById('overlay');
const pop = document.getElementById('popover'), popTitle = document.getElementById('popTitle'),
      popBody = document.getElementById('popBody'), popActions = document.getElementById('popActions'),
      popCloseBtn = document.getElementById('popCloseBtn');
function openPopoverCentered(title, bodyEl, actionsEl){ popTitle.textContent = title || ''; popBody.innerHTML = ''; popBody.appendChild(bodyEl); popActions.innerHTML = ''; if (actionsEl) popActions.appendChild(actionsEl); overlay.classList.add('show'); pop.style.display='block'; requestAnimationFrame(()=> pop.classList.add('show')); }
function closePopover(){ pop.classList.remove('show'); overlay.classList.remove('show'); setTimeout(()=>{ pop.style.display='none'; popBody.innerHTML=''; popActions.innerHTML=''; },120); }
overlay.addEventListener('click', closePopover);
popCloseBtn.addEventListener('click', closePopover);

/* ========= ì‚­ì œ(íŒ€) í™•ì¸ ========= */
const ENABLE_DELETE_API = true;
async function confirmDeleteTeamAdmin(teamId, teamName){
  let adminCode = ($('#adminCode').value || '').trim();
  if (!adminCode){
    await new Promise(res => openAdminCodeFloating(()=> res()));
    adminCode = ($('#adminCode').value || '').trim();
    if (!adminCode) return;
  }
  const body = el(`<div>
    <div style="margin:6px 0 10px">íŒ€ <b>${teamName || teamId}</b> ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
    <div class="muted">Players/Teamsì—ì„œ í•´ë‹¹ íŒ€ ê´€ë ¨ ë°ì´í„°ê°€ ì œê±°ë©ë‹ˆë‹¤.</div>
  </div>`);
  const actions = el(`<div></div>`);
  const cancel  = el(`<button class="btn">ì·¨ì†Œ</button>`);
  const ok      = el(`<button class="btn danger">ì˜êµ¬ ì‚­ì œ</button>`);
  actions.appendChild(cancel); actions.appendChild(ok);
  cancel.addEventListener('click', closePopover);
  ok.addEventListener('click', async ()=>{
    closePopover();
    if (!ENABLE_DELETE_API){ alert('í”„ëŸ°íŠ¸ ë°°ì¹˜ ì™„ë£Œ: ë°±ì—”ë“œ ì—°ë™ í›„ í™œì„±í™”ë©ë‹ˆë‹¤.'); return; }
    try{
      ok.disabled = true; ok.textContent = 'ì‚­ì œ ì¤‘â€¦';
      const payload = { teamId, adminCode };
      const j = await postJSONCompat(['deleteTeamAdmin','deleteteamadmin','delete_team_admin'], payload);
      if (!isSuccessResponse(j)) throw new Error(j?.error || 'ì‚­ì œ ì‹¤íŒ¨');
      await loadTeams();
      alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }catch(e){
      alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ' + (e.message||e));
    }finally{
      ok.disabled = false; ok.textContent = 'ì˜êµ¬ ì‚­ì œ';
    }
  });
  openPopoverCentered('íŒ€ ì‚­ì œ(ê´€ë¦¬ì)', body, actions);
}

/* ========= ê´€ë¦¬ìì½”ë“œ ì…ë ¥ íŒì—… ========= */
function openAdminCodeFloating(onOk){
  const body = el(`
    <div>
      <label>ëŒ€íšŒê´€ë¦¬ ì½”ë“œ</label>
      <div class="input-icon" style="margin-top:6px">
        <input id="popAdminCode" type="password" placeholder="ì´ ëŒ€íšŒë¥¼ ê´€ë¦¬í•  ë¹„ë°€ë²ˆí˜¸"
               style="width:100%;padding-right:38px;border:1px solid #e6ecf5;border-radius:12px;padding:12px">
        <button class="eye-btn" id="popAdminEye" title="ë³´ê¸°/ìˆ¨ê¸°ê¸°" style="right:12px">ğŸ‘ï¸</button>
      </div>
    </div>
  `);
  const pw = body.querySelector('#popAdminCode');
    pw.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      const code = pw.value.trim();
      if(!code) return alert('ê´€ë¦¬ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      $('#adminCode').value = code;
      setLocked(false);
      if(typeof onOk === 'function') onOk(code);
      closePopover();
    }
  });
  body.querySelector('#popAdminEye').addEventListener('click', ()=>{ pw.type = (pw.type==='password'?'text':'password'); });
  const actions=el(`<div></div>`);
  const cancel=el(`<button class="btn">ì·¨ì†Œ</button>`);
  const ok=el(`<button class="btn primary">í™•ì¸</button>`);
  actions.appendChild(cancel); actions.appendChild(ok);
  cancel.addEventListener('click', closePopover);
  ok.addEventListener('click', ()=>{ const code=pw.value.trim(); if(!code) return alert('ê´€ë¦¬ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); $('#adminCode').value=code; setLocked(false); if(typeof onOk==='function') onOk(code); closePopover(); });
  openPopoverCentered('ê´€ë¦¬ì½”ë“œ í™•ì¸', body, actions);
}

/* ========= íŒ€ìˆ˜ ì§‘ê³„(ë””ë¹„ì „ë³„) ========= */
let DIV_COUNTS = {};   // ì˜ˆ: { 'i3 U12': 5, 'D3': 8, ... }

/* ========= ëª©ë¡ / í•„í„° ========= */
let TOURS={}, TOUR_ARRAY=[], CURRENT_TOUR_ID='', CURRENT_TOUR_OBJ=null;

async function health(){
  const j=await getJSON(apiUrl('health'));
  if(j && (j.ok || j.status==='ok' || j.success || j.rows!==undefined)){
    setHealth('#22c55e','ì—°ê²° ì •ìƒ'); return true;
  }
  setHealth('#ef4444','ì—°ê²° ì‹¤íŒ¨'+(j && (j.error?(' - '+j.error):(j.raw?' (ë¡œê·¸ì¸/ê¶Œí•œ í•„ìš” ì˜ì‹¬)':'')) || ''));
  return false;
}

async function loadTournaments(){
  const j = await getJSON(apiUrl('tournaments'));
  TOUR_ARRAY = Array.isArray(j.rows) ? j.rows : [];
  TOURS = {};
  for (const t of TOUR_ARRAY) {
    const id = String((t && (t.tourId || t.TourID)) || '').trim();
    if (id) TOURS[id] = t;
  }
  renderTournamentList();
  renderTourFilter();
}

function tourCard(t){
  const id=t.tourId||t.TourID;
  const rs=t.regStart||t['reg.start']||t.reg_start||t.regStartDate||'';
  const re=t.regEnd||t['reg.end']||t.reg_end||t.regEndDate||'';
  const st=calcStatus(rs,re);
  const range=(t.start||t.end)?`${toInputDateOnly(t.start)} ~ ${toInputDateOnly(t.end)}`:'ì¼ì •ë¯¸ì •';
  return `<div class="pill" data-id="${id}" tabindex="0" role="button"><b class="ellipsis" style="max-width:260px;display:inline-block;vertical-align:bottom;">${t.name||'(ë¬´ì œ)'}</b> Â· ${st} Â· ${range}</div>`;
}

function renderTournamentList(){
  const box = $('#tourList');
  box.innerHTML = (TOUR_ARRAY || []).map(t => tourCard(t)).join('');
  box.querySelectorAll('.pill').forEach(el => {
    el.addEventListener('click', async () => {
      if (!(await confirmDiscardIfDirty())) return;
      const id = el.getAttribute('data-id');
      const t  = TOURS[id] || (TOUR_ARRAY || []).find(x => String((x.tourId || x.TourID) || '') === id) || null;
      CURRENT_TOUR_OBJ = t || null;
      await loadTourToForm(t, true);
      $('#editBtn').disabled = false;
      $('#tourFilter').value = id;
      await loadTeams();
      document.getElementById('formArea').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  });
}

function renderTourFilter(){
  const sel=$('#tourFilter'); const keep=sel.value;
  sel.innerHTML='<option value="">ì „ì²´ ëŒ€íšŒ</option>';
  (TOUR_ARRAY||[]).forEach(t=>{
    const id=t.tourId||t.TourID; if(!id) return;
    const period=(t.start||t.end)?` Â· ${toInputDateOnly(t.start)}~${toInputDateOnly(t.end)}`:'';
    sel.appendChild(new Option(`${t.name||'(ë¬´ì œ)'}${period}`, id));
  });
  if(keep && [...sel.options].some(o=>o.value===keep)) sel.value=keep;
}

/* ========= íŒ€ í‘œ ========= */
function jerseySVG(hex,label){ const color=(/^[#][0-9a-f]{6}$/i).test(hex||'')?hex:'#e5e7eb', text=(label||'').toUpperCase(); return `<svg width="42" height="52" viewBox="0 0 42 52" xmlns="http://www.w3.org/2000/svg"><g filter="url(#s)"><path d="M14 3 l4 6 h6 l4-6 h6 v15 l3 3 v27 a3 3 0 0 1 -3 3 h-26 a3 3 0 0 1 -3 -3 v-27 l3-3 v-15 z" fill="${color}" stroke="#cbd5e1"/><text x="21" y="31" font-family="system-ui,sans-serif" font-size="9" fill="#0f172a" text-anchor="middle" font-weight="700">${text}</text></g><defs><filter id="s" x="0" y="0" width="42" height="52"><feDropShadow dx="0" dy="1" stdDeviation="1" flood-color="#000" flood-opacity=".08"/></filter></defs></svg>`; }
function normalizeTeamRow(r){
  const region=[r.province||'', r.city||''].join(' ').trim();
  return {
    teamId:r.teamId||'', tourId:r.tourId||'', tourName:r.tourName||'',
    region, teamName:r.teamNameKo||r.teamName||'', managerName:r.managerName||'',
    managerPhone:phonePretty(r.managerPhone||''), category:r.category||'',
    division:r.division||'', homeHex:(r.uniformHome||'').toLowerCase(),
    awayHex:(r.uniformAway||'').toLowerCase(), createdAt:r.createdAt||'', editCode:r.editCode||''
  };
}

/* â–¼â–¼â–¼ ì¶”ê°€: ë””ë¹„ì „ë³„ íŒ€ìˆ˜ ì§‘ê³„ë¥¼ ìœ„í•œ í‚¤ ìƒì„± ë¡œì§ */
function getDivKeyForCount(v){
  // vëŠ” normalizeTeamRowë¡œ ì •ê·œí™”ëœ ê°’
  const cat = (v.category||'').trim();   // ì˜ˆ: 'ì¼ë°˜ë¶€', 'ëŒ€í•™ë¶€', 'i3', 'i3w' ...
  const div = (v.division||'').trim();   // ì˜ˆ: 'D3', 'U1', 'U12' ...
  // ìœ ì†Œë…„: iìˆ«ì(ë˜ëŠ” iìˆ«ìw) + ì—°ë ¹(U10 ë“±)ì„ í•œ ìŒìœ¼ë¡œ ë¬¶ì–´ ì§‘ê³„
  if (/^i\d+w?$/i.test(cat) && div) return `${cat} ${div}`;
  // ì¼ë°˜/ëŒ€í•™/ì—¬ì„±ë¶€: í™”ë©´ ì¹©ì˜ ì½”ë“œëŠ” 'D3','U1','UW' ë“± division ì½”ë“œ ìì²´
  if (div) return div;
  // í˜¹ì‹œ divisionì´ ë¹„ì–´ìˆìœ¼ë©´ categoryë¡œë¼ë„ ë¬¶ìŒ
  return cat || '';
}
function telHref(s){ const d = String(s||'').replace(/\D/g,''); return d ? `tel:${d}` : ''; }

function rowTeam(v){
  const openBtn = `<a href="#" class="btn primary open-view" data-id="${v.teamId}" title="TeamView(ìƒˆ íƒ­)">ì—´ê¸°</a>`;
  const delBtn  = `<a href="#" class="btn danger del-team" data-id="${v.teamId}" data-team="${(v.teamName||'').replace(/"/g,'&quot;')}" title="íŒ€ ì‚­ì œ(ê´€ë¦¬ì)">ì‚­ì œ</a>`;
  return `<tr>
    <td class="ellipsis" title="${v.region||''}">${v.region||'-'}</td>
    <td>
      <div class="ellipsis" title="${v.teamName||''}"><b>${v.teamName||''}</b></div>
      <div class="muted ellipsis" title="${(v.managerName||'')+' Â· '+(v.managerPhone||'')}">
        ${v.managerName||''} Â· ${ v.managerPhone ? `<a href="${telHref(v.managerPhone)}" style="color:inherit;text-decoration:none">${v.managerPhone}</a>` : '' }
      </div>
    </td>
    <td class="td-uniform"><div class="jersey">${jerseySVG(v.homeHex,'HOME')}${jerseySVG(v.awayHex,'AWAY')}</div></td>
    <td class="td-catdiv">
      <div class="cat-line">${v.category||''}</div>
      <div class="div-line">${v.division||''}</div>
    </td>
    <td class="ellipsis td-created">${fmtDateShort(v.createdAt)}</td>
    <td class="actions-cell" style="text-align:right; display:flex; gap:8px; justify-content:flex-end">${openBtn}${delBtn}</td>
  </tr>`;
}

async function loadTeams(){
  const tourId=($('#tourFilter').value||'').trim();
  const j=await getJSON(apiUrl('teams', tourId?{tourId}:{}) );

  // â–¼ (1) ì›ë³¸ rows í™•ë³´
  let rowsAll=Array.isArray(j.rows)?j.rows:[];
  if(tourId) rowsAll=rowsAll.filter(r=>String(r.tourId||'').trim()===tourId);

  // â–¼ (2) ë””ë¹„ì „ë³„ íŒ€ìˆ˜ ì§‘ê³„ ìƒì„± (ê²€ìƒ‰ê³¼ ë¬´ê´€í•˜ê²Œ ì „ì²´ ì§‘ê³„)
  const counts = {};
  rowsAll.forEach(r=>{
    const v = normalizeTeamRow(r);
    const key = getDivKeyForCount(v);
    if(!key) return;
    counts[key] = (counts[key]||0) + 1;
  });
  DIV_COUNTS = counts;       // â˜… ì „ì—­ì— ë°˜ì˜ (ì¹© UIì—ì„œ ì‚¬ìš©)
  refreshDivUI();            // â˜… ì¹© UIë¥¼ í˜„ì¬ íŒ€ìˆ˜ë¡œ ì¬ë Œë”

  // â–¼ (3) ì—¬ê¸°ì„œë¶€í„°ëŠ” â€œí‘œ ë Œë”ë§ìš© rowsâ€(ê²€ìƒ‰ ì ìš©)
  let rows = rowsAll.slice();
  const q=($('#searchText').value||'').trim().toLowerCase();
  if(q){
    rows=rows.filter(r=>{
      const v=normalizeTeamRow(r);
      return [v.tourName,v.region,v.teamName,v.managerName,v.managerPhone,v.category,v.division].join(' ').toLowerCase().includes(q);
    });
  }

  document.getElementById('teamsTbody').innerHTML =
    rows.map(r=>rowTeam(normalizeTeamRow(r))).join('') ||
    `<tr><td colspan="6" class="muted">ë°ì´í„° ì—†ìŒ</td></tr>`;

  /* ì„ íƒëœ ëŒ€íšŒ í‘œì‹œ (ìƒëµ: ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ) */
  (function(){
    const box = document.getElementById('selectedTourInfo');
    if (!box) return;
    const selId = ($('#tourFilter').value||'').trim();
    if (!selId){ box.style.display='none'; box.textContent=''; return; }
    const t = TOURS[selId] || (TOUR_ARRAY||[]).find(x => String(x.tourId||x.TourID||'') === selId);
    if (!t){ box.style.display='none'; box.textContent=''; return; }
    const period = (t.start||t.end) ? `${toInputDateOnly(t.start)} ~ ${toInputDateOnly(t.end)}` : 'ì¼ì •ë¯¸ì •';
    const st = calcStatus(t.regStart||t['reg.start']||t.reg_start||t.regStartDate||'', t.regEnd||t['reg.end']||t.reg_end||t.regEndDate||'');
    box.style.display='';
    box.innerHTML = `
      <span class="badge" style="background:#f1f5fb;border-color:#e4ecf7;color:#334155">${(t.name||'(ë¬´ì œ)')}</span>
      <span class="badge" style="background:#f8fafc;border-color:#e5e7eb;color:#334155">${period}</span>
      ${statusBadgeHtml(st)}
    `;
  })();

  applyResponsiveLabels();
}
  
document.getElementById('teamsTbody').addEventListener('click', (e)=>{
  const open = e.target.closest('.open-view');
  if (open){
    e.preventDefault();
    const id = open.dataset.id || '';
    if (!id) return;
    const url = `${VIEWER_BASE}?teamId=${encodeURIComponent(id)}`;
    window.open(url, '_blank', 'noopener');
    return;
  }
  const del = e.target.closest('.del-team');
  if (del){
    e.preventDefault();
    const id   = del.dataset.id   || '';
    const name = del.dataset.team || '';
    if (!id) return;
    confirmDeleteTeamAdmin(id, name);
    return;
  }
});

/* ========= ìƒíƒœ/ì ê¸ˆ ========= */
let DIV_STATE=[]; // [{group, entries:[{code, cap}]}]
let FORM_LOCKED=true, DIRTY=false;
function setLocked(locked){
  FORM_LOCKED = locked;
  const area = $('#formArea');
  if (locked) area.classList.add('locked'); else area.classList.remove('locked');
  document.querySelectorAll('[data-editable]').forEach(e => e.disabled = locked);

  const admin = $('#adminCode');
  if (locked) { admin.setAttribute('readonly', ''); }
  else { admin.addEventListener('focus', () => admin.removeAttribute('readonly'), { once: true }); }

  $('#saveTourBtn').disabled   = locked;
  $('#deleteTourBtn').disabled = locked || !CURRENT_TOUR_ID;
  $('#addDivSetBtn').disabled  = locked;
  $('#addPlaceBtn').disabled   = locked;
  $('#clearAllDivBtn').disabled = locked || (DIV_STATE.length === 0);

  const editBtn = $('#editBtn');
  if (editBtn) editBtn.disabled = locked ? !CURRENT_TOUR_ID : true;
  
  /* â˜… í¸ì§‘ ìƒíƒœ ë³€ê²½ ì‹œ ë””ë¹„ì „ ì¹©ì„ ì¬ë Œë”ë§í•˜ì—¬
     - ìˆ˜ì •ëª¨ë“œ: ì‚­ì œë²„íŠ¼/ëª¨ì§‘íŒ€ìˆ˜ ì¸í’‹ í™œì„±í™”
     - ì €ì¥ í›„(ì ê¸ˆ): ì‚­ì œë²„íŠ¼ ì œê±°/ì¸í’‹ ë¹„í™œì„±(í‘œì‹œë§Œ)
  */
  /* ê¸°ì¡´: refreshDivUI(); ì•„ë˜ì— ì¶”ê°€ */
  refreshDivUI();
  /* â˜… ì ê¸ˆ ìƒíƒœ ë³€ê²½ ì‹œ í¬ìŠ¤í„° UIë„ ì ê¸ˆ/í¸ì§‘ ìƒíƒœ ë°˜ì˜ */
  renderPoster();
}


document.getElementById('addPlaceBtn').addEventListener('click', () => {
  if (FORM_LOCKED) { alert('ìƒë‹¨ "ìˆ˜ì •" ë²„íŠ¼ì„ ëˆŒëŸ¬ í¸ì§‘ì„ í•´ì œí•˜ì„¸ìš”.'); return; }
  openPlaceFloating('', (name) => {
    const row = makePlaceRow({ name });
    document.getElementById('placeList').appendChild(row);
    DIRTY = true;
  });
});

function markDirty(){ if(!FORM_LOCKED) DIRTY=true; }
document.addEventListener('input',(e)=>{ if(e.target.matches('[data-editable]')) markDirty(); });
window.addEventListener('beforeunload',(e)=>{ if(DIRTY){ e.preventDefault(); e.returnValue=''; }});
async function confirmDiscardIfDirty(){ if(!DIRTY) return true; const ok=confirm('ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ê³„ì† ì§„í–‰í• ê¹Œìš”?'); if(ok) DIRTY=false; return ok; }

/* ========= ì¢…ë³„/ì¥ì†Œ UI ========= */
const DIVISION_PRESETS = {
  'ì¼ë°˜ë¶€': ['D3','D4','D5','D6','D7'],
  'ëŒ€í•™ë¶€': ['U1','U2','U3','UW'],
  'ì—¬ì„±ë¶€': ['D3','D4','D5'],
  'ìœ ì†Œë…„ë¶€': ['í•˜ëª¨ë‹ˆ','í•˜ëª¨ë‹ˆw','i1','i1w','i2','i2w','i3','i3w','i4','i4w']
};
const YOUTH_AGE_LABELS = Array.from({length: 12}, (_, i) => 'U' + (7 + i));

function getStateByGroup(group){
  let st = DIV_STATE.find(s=>s.group===group);
  if(!st){ st = { group, entries: [] }; DIV_STATE.push(st); }
  if(!Array.isArray(st.entries)) st.entries = [];
  return st;
}
function coerceEntriesFromDivisions(group, divisions, capsMap){
  const entries = [];
  (divisions||[]).forEach(v=>{
    if(!v) return;
    if(typeof v==='string'){
      const cap = (capsMap && Number.isFinite(Number(capsMap[v]))) ? Number(capsMap[v]) : null;
      entries.push({ code: v, cap });
    }else if(v && typeof v==='object' && v.code){
      const cap = (v.cap!=null)?Number(v.cap): (capsMap && Number.isFinite(Number(capsMap[v.code]))) ? Number(capsMap[v.code]) : null;
      entries.push({ code: v.code, cap: Number.isFinite(cap)?cap:null });
    }
  });
  return entries;
}

function renderDivRow(container, set, editable){
  const group = set.group;
  const entries = set.entries || [];

  const row = el(`<div class="place-item"></div>`);
  row.classList.add('div-row');   // â˜… ì œëª©ê³¼ ì¹©ì´ ë¶™ì–´ ë³´ì´ë„ë¡ 2ì¹¼ëŸ¼ ë ˆì´ì•„ì›ƒ ì ìš©
  const left = el(`<div style="display:flex;align-items:center;gap:8px"><b>${group}</b></div>`);
  const delSmall = el(`<button class="btn danger" style="padding:4px 8px;font-size:12px" ${editable?'':'disabled'}>ì‚­ì œ</button>`);
  delSmall.addEventListener('click',()=>{ 
    if(FORM_LOCKED) return; 
    if(confirm(`"${group}" êµ¬ë¶„ì„ ì‚­ì œí• ê¹Œìš”?`)){ 
      DIV_STATE = DIV_STATE.filter(s=>s.group!==group); 
      DIRTY=true; 
      refreshDivUI(); 
    } 
  });
  left.appendChild(delSmall);
  row.appendChild(left);

  // ì¤‘ê°„: cap ì…ë ¥ ë¦¬ìŠ¤íŠ¸
  const mid = el(`<div class="cap-row"></div>`);
  mid.style.gridColumn = '2 / -1';
  if(entries.length){
    // ... (ì¹© ì¶”ê°€ ë¡œì§ ê·¸ëŒ€ë¡œ)
    entries.forEach((ent, idx)=>{
      const code = ent.code;
      const cap = (ent.cap ?? '');
      const cur = Number(DIV_COUNTS[code] || 0);   // â˜… í˜„ì¬ ì°¸ê°€ì‹ ì²­ íŒ€ìˆ˜
      const chip = el(`
        <label class="cap-chip">
          <b>${code}</b>
          <span class="cap-note" style="margin-left:4px">í˜„ì¬ ${cur}íŒ€</span>
          ${editable 
            ? `<input class="cap-input" type="number" min="0" step="1" value="${cap!==''?cap:''}" placeholder="ëª¨ì§‘" data-editable>`
            : `<span class="cap-note" style="margin-left:6px">${Number.isFinite(+cap)?`ëª¨ì§‘ ${cap}íŒ€`:'ëª¨ì§‘ ë¯¸ì„¤ì •'}</span>`
          }
          ${editable ? `<button class="remove" title="ì œê±°">Ã—</button>` : ``}
        </label>
      `);
      if(editable){
        const inp = chip.querySelector('.cap-input');
        inp.addEventListener('input', ()=>{
          const v = inp.value.trim();
          ent.cap = v==='' ? null : Math.max(0, parseInt(v,10)||0);
          DIRTY = true;
        });
        const rm = chip.querySelector('.remove');
        rm.addEventListener('click', ()=>{
          const st = getStateByGroup(group);
          st.entries = st.entries.filter((_,i)=>i!==idx);
          DIRTY = true; refreshDivUI();
        });
      }
      mid.appendChild(chip);
    });
  }else{
    mid.appendChild(el(`<span class="muted">í•­ëª© ì—†ìŒ</span>`));
  }
  row.appendChild(mid);

  container.appendChild(row);
}

function refreshDivUI(){
  const box = $('#divSetList');
  box.innerHTML = '';
  const editable = !FORM_LOCKED;
  DIV_STATE.forEach(s => renderDivRow(box, s, editable));
  $('#addDivSetBtn').disabled = FORM_LOCKED;
  $('#clearAllDivBtn').disabled = FORM_LOCKED || DIV_STATE.length === 0;
}

function openDivFloating(){
  const body = el(`
    <div>
      <label>êµ¬ë¶„</label>
      <select id="popGroupSel" style="width:100%;margin-bottom:8px;padding:10px;border:1px solid #e6ecf5;border-radius:12px"></select>
      <div id="popDivChecks"></div>

      <div id="youthPairWrap" style="display:none;margin-top:10px">
        <label>ìœ ì†Œë…„: ì¢…ë³„ 1ê°œ ì„ íƒ â†’ ì—°ë ¹ 1ê°œ ì„ íƒ</label>
        <div id="youthDivRadios" style="margin-top:6px"></div>
        <div id="youthAgeRadios" style="margin-top:8px"></div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="btn" id="btnAddPair">+ ìŒ ì¶”ê°€</button>
          <span class="muted">ì¶”ê°€ëœ ìŒì€ ìƒìœ„ ëª©ë¡ì— í‘œì‹œë©ë‹ˆë‹¤.</span>
        </div>
      </div>
    </div>
  `);

  const sel = body.querySelector('#popGroupSel');
  sel.innerHTML = Object.keys(DIVISION_PRESETS).map(g=>`<option value="${g}">${g}</option>`).join('');
  const checks = body.querySelector('#popDivChecks');
  const youthWrap = body.querySelector('#youthPairWrap');
  const youthDivRadios = body.querySelector('#youthDivRadios');
  const youthAgeRadios = body.querySelector('#youthAgeRadios');

  function render(g){
    const opts = DIVISION_PRESETS[g] || [];
    const st = getStateByGroup(g);
    const pickedCodes = new Set((st.entries||[]).map(e=>e.code));

    if (g === 'ìœ ì†Œë…„ë¶€'){
      youthWrap.style.display = '';
      checks.innerHTML = `<div class="muted">â€» ìœ ì†Œë…„ì€ ì•„ë˜ì—ì„œ ì¢…ë³„/ì—°ë ¹ì„ í•˜ë‚˜ì”© ì„ íƒ í›„ <b>+ ìŒ ì¶”ê°€</b>.</div>`;
      youthDivRadios.innerHTML = `<div style="display:flex;flex-wrap:wrap;gap:8px;">${opts.map(v=>`<label class="chip"><input type="radio" name="y_div" value="${v}"> ${v}</label>`).join('')}</div>`;
      youthAgeRadios.innerHTML = `<div style="display:flex;flex-wrap:wrap;gap:8px;">${YOUTH_AGE_LABELS.map(a=>`<label class="chip"><input type="radio" name="y_age" value="${a}"> ${a}</label>`).join('')}</div>`;
      const btnAdd = body.querySelector('#btnAddPair');
      btnAdd.onclick = ()=>{
        const div = (body.querySelector('input[name="y_div"]:checked')||{}).value || '';
        const age = (body.querySelector('input[name="y_age"]:checked')||{}).value || '';
        if(!div) return alert('ì¢…ë³„ì„ ì„ íƒí•˜ì„¸ìš”.');
        if(!age) return alert('ì—°ë ¹ì„ ì„ íƒí•˜ì„¸ìš”.');
        const pair = `${div} ${age}`;
        if(!pickedCodes.has(pair)){
          st.entries.push({ code: pair, cap: null });
          DIRTY = true; refreshDivUI();
        }else{
          alert('ì´ë¯¸ ì¶”ê°€ëœ í•­ëª©ì…ë‹ˆë‹¤.');
        }
      };
      checks.innerHTML += '';
    }else{
      youthWrap.style.display = 'none';
      youthDivRadios.innerHTML = '';
      youthAgeRadios.innerHTML = '';
      checks.innerHTML = `<div style="display:flex;flex-wrap:wrap;gap:8px;">${opts.map(v=>`<label class="chip"><input type="checkbox" value="${v}" ${pickedCodes.has(v)?'checked':''}> ${v}</label>`).join('')}</div>`;
    }
  }
  sel.addEventListener('change', ()=>render(sel.value));
  render(sel.value);

  const actions = el(`<div></div>`);
  const cancel = el(`<button class="btn">ì·¨ì†Œ</button>`);
  const ok = el(`<button class="btn primary">ì ìš©</button>`);
  actions.appendChild(cancel); actions.appendChild(ok);
  cancel.addEventListener('click', closePopover);
  ok.addEventListener('click', ()=>{
    const g = sel.value;
    if (g !== 'ìœ ì†Œë…„ë¶€'){
      const selected = [...body.querySelectorAll('#popDivChecks input:checked')].map(i=>i.value);
      const st = getStateByGroup(g);
      // ì¶”ê°€
      selected.forEach(code=>{
        if(!(st.entries||[]).some(e=>e.code===code)){
          st.entries.push({ code, cap: null });
        }
      });
      // ì²´í¬ í•´ì œëœ í•­ëª© ì œê±°
      st.entries = st.entries.filter(e=> selected.includes(e.code));
      DIRTY = true; refreshDivUI(); closePopover();
    }else{
      // ìœ ì†Œë…„ì€ ì´ë¯¸ +ìŒ ì¶”ê°€ë¡œë§Œ ë°˜ì˜ë˜ë¯€ë¡œ ë°”ë¡œ ë‹«ê¸°
      closePopover();
    }
  });

  openPopoverCentered('êµ¬ë¶„/ì¢…ë³„ ì„ íƒ', body, actions);
}
document.getElementById('addDivSetBtn').addEventListener('click', openDivFloating);

function makePlaceRow(init={name:''}){
  const row=el(`<div class="place-item"></div>`);
  const name=el(`<div><label style="margin:0 0 6px">ì¥ì†Œëª…</label><input value="${init.name||''}" data-editable placeholder="ì˜ˆ: ì„œìš¸íŠ¹ë³„ì‹œí•™ìƒì²´ìœ¡ê´€"></div>`);
  const f1=el(`<div></div>`), f2=el(`<div></div>`);
  const ctrl=el(`<div style="display:flex;gap:6px;align-items:flex-end"><button class="btn" data-edit data-editable>ì´ë¦„ ìˆ˜ì •</button><button class="btn danger" data-del data-editable>ì‚­ì œ</button></div>`);
  ctrl.querySelector('[data-edit]').addEventListener('click',()=> openPlaceFloating(name.querySelector('input').value,(newName)=>{ name.querySelector('input').value=newName; DIRTY=true; }));
  ctrl.querySelector('[data-del]').addEventListener('click',()=>{ row.remove(); DIRTY=true; });
  row.appendChild(name); row.appendChild(f1); row.appendChild(f2); row.appendChild(ctrl);
  row.getValue=()=>({name:name.querySelector('input').value.trim()});
  return row;
}
function getPlaces(){ return [...document.querySelectorAll('#placeList .place-item')].map(it=>it.getValue()).filter(p=>p.name); }
function setPlaces(list){ const box=$('#placeList'); box.innerHTML=''; (list&&list.length?list:[]).forEach(v=>{ const nm=(typeof v==='string')?v:(v?.name||v?.address||''); box.appendChild(makePlaceRow({name:nm})); }); }

/* ========= í¬ìŠ¤í„° ========= */
let POSTER_DATA_URL='', POSTER_CLEAR=false;
function extractDriveId(u){
  const s=String(u||'').trim();
  if(!s) return '';
  if(/^[A-Za-z0-9_-]{20,}$/.test(s) && !/^https?:\/\//i.test(s)) return s;
  let m = s.match(/\/d\/([A-Za-z0-9_-]{10,})/); if(m) return m[1];
  m = s.match(/[?&]id=([A-Za-z0-9_-]{10,})/);   if(m) return m[1];
  m = s.match(/\/uc(?:\?[^#]*?)?\bid=([A-Za-z0-9_-]{10,})/); if(m) return m[1];
  return '';
}
const buildView=id=>'https://drive.google.com/uc?export=view&id='+encodeURIComponent(id);
const buildDown=id=>'https://drive.google.com/uc?export=download&id='+encodeURIComponent(id);
const buildThumb=(id,w=2000)=>'https://drive.google.com/thumbnail?id='+encodeURIComponent(id)+'&sz=w'+w;

function normalizePosterFromFields(posterUrl, posterId){
  const variants=[];
  const id = extractDriveId(posterId) || extractDriveId(posterUrl);
  if(id){
    variants.push(buildView(id));
    variants.push(buildDown(id));
    variants.push(buildThumb(id,2000));
  }
  const u = String(posterUrl||'').trim();
  if(/\.(png|jpe?g|webp|gif|svg)(\?.*)?$/i.test(u) && !variants.includes(u)) variants.push(u);
  if(/^https?:\/\//i.test(u) && !variants.includes(u)) variants.push(u);
  return { primary: variants[0] || '', variants };
}

async function renderPoster(){
  const prev=$('#posterPreview');
  let showUrl = '';
  let variants = [];

  if(POSTER_DATA_URL && !POSTER_CLEAR){
    showUrl = POSTER_DATA_URL;
    variants = [POSTER_DATA_URL];
  }else if(!POSTER_CLEAR){
    const t = CURRENT_TOUR_OBJ;
    if (t){
      const pack = normalizePosterFromFields(t.posterUrl, t.posterId);
      showUrl = pack.primary;
      variants = pack.variants;
    }
  }

  if(!showUrl){
    prev.innerHTML = `
      <div class="poster-drop ${FORM_LOCKED ? 'disabled' : ''}" id="posterDrop">
        ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•´ ì—…ë¡œë“œ
        <input type="file" id="posterInput" accept="image/*" style="display:none">
      </div>`;
    $('#posterCopy').disabled = true;
    $('#posterClear').disabled = true;
    $('#posterCopy').dataset.copyUrl = '';
    /* â˜… ì ê¸ˆì¼ ë•ŒëŠ” ìƒí˜¸ì‘ìš© ìì²´ë¥¼ ì—°ê²°í•˜ì§€ ì•ŠìŒ */
    if (!FORM_LOCKED) wirePosterInteractions();
  }else{
    prev.innerHTML = `<img id="posterImg" src="" alt="poster"> <div class="muted">${POSTER_DATA_URL?'ì—…ë¡œë“œ(ë¯¸ì €ì¥)':'í˜„ì¬ ì €ì¥ëœ í¬ìŠ¤í„°'}</div>`;
    const img=$('#posterImg');
    let i=0;
    const tryNext=()=>{ if(i>=variants.length){ img.removeAttribute('src'); return; } img.src=variants[i++]; };
    img.onerror=tryNext; img.onload=()=>{};
    tryNext();
    $('#posterCopy').disabled = false;           // ë³µì‚¬ ê¸°ëŠ¥ì€ ì½ê¸°ì „ìš©ì—ì„œë„ í—ˆìš©
    $('#posterClear').disabled = FORM_LOCKED;    // â˜… ì ê¸ˆì´ë©´ ì‚­ì œ ë¹„í™œì„±
    $('#posterCopy').dataset.copyUrl = variants[0] || showUrl;
  }
}
function wirePosterInteractions(){
  const drop=document.getElementById('posterDrop');
    /* â˜… í¸ì§‘ ëª¨ë“œì—ì„œë§Œ ì—…ë¡œë“œ í—ˆìš© */
    if (FORM_LOCKED) return;
  const input=document.getElementById('posterInput');
  if(!drop||!input) return;
  drop.addEventListener('click', ()=> input.click());
  drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.borderColor='#1769ff'; });
  drop.addEventListener('dragleave', ()=>{ drop.style.borderColor='#cbd5e1'; });
  drop.addEventListener('drop', e=>{ e.preventDefault(); drop.style.borderColor='#cbd5e1'; const f=e.dataTransfer.files?.[0]; if(f) handlePosterFile(f); });
  input.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) handlePosterFile(f); });
}
async function handlePosterFile(file){
  if (FORM_LOCKED) { alert('í¸ì§‘ ëª¨ë“œì—ì„œë§Œ í¬ìŠ¤í„°ë¥¼ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìƒë‹¨ "ìˆ˜ì •"ì„ ëˆŒëŸ¬ í¸ì§‘ì„ í•´ì œí•˜ì„¸ìš”.'); return; }
  try{ POSTER_DATA_URL = await fileToJpegDataUrl(file, 1024, 0.8); POSTER_CLEAR=false; await renderPoster(); markDirty(); }
  catch(e){ alert('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: '+e.message); }
}
async function fileToJpegDataUrl(file, maxW=1024, q=0.8){
  const readAsDataURL=f=>new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f); });
  const src=await readAsDataURL(file);
  const img=await new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=src; });
  const scale=Math.min(1, maxW/(img.width||1)); const w=Math.round((img.width||1)*scale), h=Math.round((img.height||1)*scale);
  const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h; canvas.getContext('2d').drawImage(img,0,0,w,h);
  return canvas.toDataURL('image/jpeg', q);
}
document.getElementById('posterCopy').addEventListener('click', async ()=>{
  let url=$('#posterCopy').dataset.copyUrl||'';
  if(!url && POSTER_DATA_URL && !POSTER_CLEAR) url=POSTER_DATA_URL;
  else if(!url && CURRENT_TOUR_OBJ){
    const pack = normalizePosterFromFields(CURRENT_TOUR_OBJ.posterUrl, CURRENT_TOUR_OBJ.posterId);
    url = pack.primary || '';
  }
  if(!url) return;
  try{ await navigator.clipboard.writeText(url); alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'); }catch{ alert('ë³µì‚¬ ì‹¤íŒ¨'); }
});
document.getElementById('posterClear').addEventListener('click', async ()=>{
  if (FORM_LOCKED) { alert('í¸ì§‘ ëª¨ë“œì—ì„œë§Œ í¬ìŠ¤í„°ë¥¼ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return; }
  POSTER_DATA_URL = '';
  POSTER_CLEAR = true;
  await renderPoster();
  markDirty();
});

/* ========= ë¡œë“œ/ì €ì¥ ========= */
function updateStatusBadge(){ const rs=$('#regStart').value||''; const re=$('#regEnd').value||''; $('#tourStatusBadge').innerHTML=statusBadgeHtml(calcStatus(rs,re)); }
['regStart','regEnd'].forEach(id=>$('#'+id).addEventListener('change',updateStatusBadge));
function pickFirst(obj, keys){ for(const k of keys){ if(obj && obj[k]) return obj[k]; } return ''; }

async function loadTourToForm(t, locked=true){
  const id = t?.tourId || t?.TourID || '';
  CURRENT_TOUR_ID=id; CURRENT_TOUR_OBJ=t||null;
  $('#tourFormTitle').textContent = t ? 'ëŒ€íšŒ ìˆ˜ì • (ì½ê¸° ì „ìš©)' : 'ëŒ€íšŒ ë“±ë¡';
  $('#tourId').value   = id;
  $('#tourName').value = t?.name || '';
  $('#tourUrl').value  = t?.url  || '';

  $('#fee').value     = t?.fee     || '';
  $('#account').value = t?.account || '';

  POSTER_DATA_URL = ''; POSTER_CLEAR = false;
  await renderPoster();

  $('#tourStart').value= toInputDateOnly(t?.start);
  $('#tourEnd').value  = toInputDateOnly(t?.end);
  const rs = pickFirst(t, ['regStart','reg.start','reg_start','regStartDate','reg.start.date']);
  const re = pickFirst(t, ['regEnd','reg.end','reg_end','regEndDate','reg.end.date']);
  $('#regStart').value = toInputDT(rs);
  $('#regEnd').value   = toInputDT(re);
  $('#editDeadlineAt').value = toInputDT(t?.editDeadlineAt);
  updateStatusBadge();

  // === ëª¨ì§‘íŒ€ìˆ˜ì™€ ì¢…ë³„ ë¶ˆëŸ¬ì˜¤ê¸° ===
  let divSets=t?.divSets;
  if(!Array.isArray(divSets)||!divSets.length){
    const m=t?.divs||{};
    divSets=Object.keys(m).map(g=>({group:g,divisions:m[g]||[]}));
  }
  const caps = t?.divCaps || t?.div_caps || {};
  DIV_STATE = (divSets||[]).map(s=>{
    return { group: s.group, entries: coerceEntriesFromDivisions(s.group, s.divisions||[], caps) };
  });
  refreshDivUI();

  setPlaces(Array.isArray(t?.places)?t.places:[]);
  $('#adminCode').value=''; DIRTY=false; setLocked(locked);
}

function clearTourForm(){
  CURRENT_TOUR_ID=''; CURRENT_TOUR_OBJ=null;
  $('#tourFormTitle').textContent='ëŒ€íšŒ ë“±ë¡';
  ['tourId','tourName','tourUrl','tourStart','tourEnd','regStart','regEnd','adminCode'].forEach(id=>$('#'+id).value='');
  POSTER_DATA_URL=''; POSTER_CLEAR=false; renderPoster();
  DIV_STATE=[]; refreshDivUI(); setPlaces([]);
  updateStatusBadge();
  DIRTY=false; setLocked(false);
  $('#editBtn').disabled=true;
}
document.getElementById('toggleCodeBtn').addEventListener('click',()=>{ const i=$('#adminCode'); i.type=(i.type==='password'?'text':'password'); });

function buildDivPayload(){
  // divs: { ê·¸ë£¹: [ì½”ë“œ, ...] }
  // divCaps: { ì½”ë“œ(or ìœ ì†Œë…„ìŒ): ëª¨ì§‘íŒ€ìˆ˜ }
  const divs = {};
  const divCaps = {};
  (DIV_STATE||[]).forEach(s=>{
    if(!divs[s.group]) divs[s.group]=[];
    (s.entries||[]).forEach(ent=>{
      if(!divs[s.group].includes(ent.code)) divs[s.group].push(ent.code);
      if(ent.cap!==null && ent.cap!==undefined && Number.isFinite(Number(ent.cap))){
        divCaps[ent.code] = Number(ent.cap);
      }
    });
  });
  return { divs, divCaps };
}

async function doSave(){
  const name=($('#tourName').value||'').trim(); if(!name) return alert('ëŒ€íšŒëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
  let adminCode=($('#adminCode').value||'').trim();
  if(!adminCode){ return openAdminCodeFloating(()=> doSave()); }

  const { divs, divCaps } = buildDivPayload();

  const base = {
    tourId: ($('#tourId').value || '').trim(),
    name,
    url: ($('#tourUrl').value || '').trim(),
    start: $('#tourStart').value || '',
    end:   $('#tourEnd').value   || '',
    regStart: $('#regStart').value || '',
    regEnd:   $('#regEnd').value   || '',
    editDeadlineAt: ($('#editDeadlineAt').value || ''),
    status:   calcStatus($('#regStart').value||'', $('#regEnd').value||''),
    // ì €ì¥ í¬ë§· (êµ¬ë²„ì „ í˜¸í™˜ + ì‹ ë²„ì „)
    divSets: (DIV_STATE||[]).map(s => ({ group:s.group, divisions:(s.entries||[]).map(e=>e.code) })),
    divs,
    divCaps,                                   // â˜… ì‹ ê·œ: ì½”ë“œâ†’ëª¨ì§‘íŒ€ìˆ˜ ë§µ
    div_caps_json: JSON.stringify(divCaps),    // í˜¸í™˜ í‚¤ í•¨ê»˜ ì „ì†¡
    places:  getPlaces(),
    fee:     ($('#fee').value || '').trim(),
    account: ($('#account').value || '').trim(),
    adminCode,
    posterClear: POSTER_CLEAR ? true : undefined,
    // ì¼ë¶€ ë°±ì—”ë“œ í˜¸í™˜ í‚¤ ìœ ì§€
    'reg.start': $('#regStart').value || '',  'reg.end': $('#regEnd').value || '',
    reg_start:   $('#regStart').value || '',  reg_end:  $('#regEnd').value || '',
    regStartDate: $('#regStart').value || '', regEndDate: $('#regEnd').value || '',
    'reg.start.date': $('#regStart').value || '', 'reg.end.date': $('#regEnd').value || '',
    divs_json: JSON.stringify(divs)
  };
  
  // (â˜…ì¶”ê°€) í¬ìŠ¤í„°ë¥¼ ë³€ê²½/ì‚­ì œí•˜ì§€ ì•Šì•˜ë‹¤ë©´ ê¸°ì¡´ ê°’ì„ í•¨ê»˜ ë³´ë‚¸ë‹¤
  if (!POSTER_CLEAR && !POSTER_DATA_URL) {
    base.posterId  = (CURRENT_TOUR_OBJ && CURRENT_TOUR_OBJ.posterId)  || '';
    base.posterUrl = (CURRENT_TOUR_OBJ && CURRENT_TOUR_OBJ.posterUrl) || '';
  }
  
  // ìƒˆ ì—…ë¡œë“œê°€ ìˆì„ ë•Œë§Œ dataURL ì „ì†¡
  if (POSTER_DATA_URL && !POSTER_CLEAR) {
    base.posterDataUrl = POSTER_DATA_URL;
  }

  try{
    const j=await postJSONCompat(['upsertTournament','upsert_tournament','UPSERTTOURNAMENT'], base);
    if (!isSuccessResponse(j)) {
      const msg = j?.error || j?.message || j?.msg || 'ì„œë²„ ì‘ë‹µì„ ì´í•´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      return alert('ì €ì¥ ì‹¤íŒ¨: ' + msg);
    }
    await loadTournaments();
    if(j.tourId){ $('#tourId').value=j.tourId; CURRENT_TOUR_ID=j.tourId; CURRENT_TOUR_OBJ=TOURS[j.tourId]||CURRENT_TOUR_OBJ; }
    alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    POSTER_DATA_URL=''; POSTER_CLEAR=false; DIRTY=false; setLocked(true); $('#tourFormTitle').textContent='ëŒ€íšŒ ìˆ˜ì • (ì½ê¸° ì „ìš©)';
    await renderPoster();
  }catch(e){
    alert('ì €ì¥ ì‹¤íŒ¨: ' + (e?.message || e));
  }
}

/* ========= ì‚­ì œ ========= */
async function doDelete(){
  if(!CURRENT_TOUR_ID) return alert('ì‚­ì œí•  ëŒ€íšŒê°€ ì—†ìŠµë‹ˆë‹¤.');
  let adminCode=($('#adminCode').value||'').trim();
  if(!adminCode) return openAdminCodeFloating(()=> doDelete());
  const name = ($('#tourName').value||'').trim();
  if(!confirm(`"${name || CURRENT_TOUR_ID}" ëŒ€íšŒë¥¼ ì •ë§ ì‚­ì œí• ê¹Œìš”? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;

  const payload={ tourId: CURRENT_TOUR_ID, adminCode };
  try{
    const j = await postJSONCompat(['deleteTournament','removeTournament','delete_tournament','remove_tournament'], payload);
    if (!isSuccessResponse(j)) {
      const msg = j?.error || j?.message || j?.msg || 'ì„œë²„ ì‘ë‹µì„ ì´í•´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      return alert('ì‚­ì œ ì‹¤íŒ¨: ' + msg);
    }
    await loadTournaments();
    await loadTeams();
    applyResponsiveLabels();
    clearTourForm();
    alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  }catch(e){
    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ' + (e.message||e));
  }
}

/* ========= ìƒë‹¨ ë²„íŠ¼/íƒìƒ‰ ========= */
document.getElementById('settingsBtn').addEventListener('click', ()=>{
  const cur=(conf.appUrl||'').trim();
  const val=prompt('Apps Script Web App URLì„ ì…ë ¥í•˜ì„¸ìš” (â€¦/exec):',cur);
  if(val===null) return;
  if(!validWebAppUrl(val)) { alert('URL í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (â€¦/exec)'); return; }
  conf.appUrl=(val||'').trim(); store.save(conf);
  alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.'); location.reload();
});
document.getElementById('reloadBtn').addEventListener('click', async (e)=>{
  e.preventDefault();
  try{
    const btn = e.currentTarget;
    btn.disabled = true;
    const prev = btn.textContent; btn.textContent = 'ìƒˆë¡œê³ ì¹¨ ì¤‘â€¦';
    if(!(await confirmDiscardIfDirty())) return;
    await health(); await loadTournaments(); await loadTeams(); await renderPoster();
    if (typeof applyResponsiveLabels === 'function') applyResponsiveLabels();
    btn.textContent = prev;
  }catch(err){
    alert('ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ' + (err?.message || err));
  }finally{
    const btn = document.getElementById('reloadBtn'); if(btn){ btn.disabled=false; btn.textContent='ìƒˆë¡œê³ ì¹¨'; }
  }
});
document.getElementById('newTourBtn').addEventListener('click', async ()=>{
  if(!(await confirmDiscardIfDirty())) return; clearTourForm();
});
document.getElementById('editBtn').addEventListener('click', ()=>{
  if(!CURRENT_TOUR_ID) return alert('ìˆ˜ì •í•  ëŒ€íšŒë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
  openAdminCodeFloating(()=>{ $('#tourFormTitle').textContent='ëŒ€íšŒ ìˆ˜ì • (í¸ì§‘ì¤‘)'; });
});

document.getElementById('tourFilter').addEventListener('change', async ()=>{
  if(!(await confirmDiscardIfDirty())){ $('#tourFilter').value=''; return; }
  await loadTeams();
});
document.getElementById('searchBtn').addEventListener('click', loadTeams);
document.getElementById('searchText').addEventListener('keydown', e=>{ if(e.key==='Enter') loadTeams(); });

document.getElementById('saveTourBtn').addEventListener('click', doSave);
document.getElementById('deleteTourBtn').addEventListener('click', doDelete);

/* ========= ë¶€íŒ… ========= */
(async function boot(){
  await health();
  await loadTournaments();
  await loadTeams();
  await renderPoster();
})();

/* ========= ì¥ì†Œ íŒì—… (ì› ì½”ë“œì—ì„œ ì‚¬ìš©ë˜ë˜ ë¶€ë¶„ ë³´ì™„) ========= */
function openPlaceFloating(initName, onOk){
  const body = el(`
    <div>
      <label>ì¥ì†Œëª…</label>
      <input id="placeNameInput" style="width:100%;padding:10px;border:1px solid #e6ecf5;border-radius:12px" value="${(initName||'').replace(/"/g,'&quot;')}">
    </div>
  `);
  const actions=el(`<div></div>`);
  const cancel=el(`<button class="btn">ì·¨ì†Œ</button>`);
  const ok=el(`<button class="btn primary">í™•ì¸</button>`);
  actions.appendChild(cancel); actions.appendChild(ok);
  cancel.addEventListener('click', closePopover);
  ok.addEventListener('click', ()=>{
    const v = (body.querySelector('#placeNameInput').value||'').trim();
    if(!v) return alert('ì¥ì†Œëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
    if(typeof onOk==='function') onOk(v);
    closePopover();
  });
  openPopoverCentered('ì¥ì†Œ', body, actions);
}
</script>
</body>
</html>
